# Story 2.7: Car Tags

## Status

Approved

## Story

**As a** user with multiple vehicles,  
**I want** to tag each parking spot with a car label,  
**so that** I can distinguish between different vehicles.

## Acceptance Criteria

1. Confirmation screen shows car tag selector
2. Default tags available: "My Car", "Rental", "Other"
3. Users can create custom car tags (saved to their profile)
4. Selected car tag is saved with the spot record
5. Car tag displays in spot history and detail views
6. Car tag is optional - defaults to "My Car" if not changed
7. Users can manage (add/edit/delete) custom tags in settings (Epic 5)

## Tasks / Subtasks

- [ ] **Task 1: Create Car Tags Database Table** (AC: 3)
  - [ ] Create `apps/api/src/db/schema/carTags.ts`
  - [ ] Fields: `id`, `userId`, `name`, `color`, `createdAt`
  - [ ] Index on `userId`
  - [ ] Seed default tags (system-wide, no userId)
  - [ ] Run migration

- [ ] **Task 2: Create Car Tags Repository** (AC: 2, 3)
  - [ ] Create `apps/api/src/repositories/carTag.repository.ts`
  - [ ] Implement `findByUserId(userId)` - get user's custom tags
  - [ ] Implement `getDefaults()` - get system default tags
  - [ ] Implement `create(userId, tag)` - add custom tag
  - [ ] Implement `update(id, data)` - edit tag
  - [ ] Implement `delete(id)` - remove tag
  - [ ] Write unit tests

- [ ] **Task 3: Create Car Tags API Endpoints** (AC: 3)
  - [ ] Create `apps/api/src/routes/car-tags/carTags.routes.ts`
  - [ ] Add `GET /v1/car-tags` - list user's + default tags
  - [ ] Add `POST /v1/car-tags` - create custom tag
  - [ ] Add `PATCH /v1/car-tags/:id` - update tag
  - [ ] Add `DELETE /v1/car-tags/:id` - delete tag
  - [ ] Write integration tests

- [ ] **Task 4: Create Car Tag Selector Component** (AC: 1, 2, 6)
  - [ ] Create `apps/web/src/components/spot/CarTagSelector.tsx`
  - [ ] Create `apps/web/src/components/spot/carTag.types.ts`
  - [ ] Dropdown/pill selector UI
  - [ ] Show default tags first
  - [ ] Show custom tags after
  - [ ] "My Car" selected by default
  - [ ] Colored indicators for tags

- [ ] **Task 5: Create Car Tags Store** (AC: 3)
  - [ ] Create `apps/web/src/stores/carTagStore.ts`
  - [ ] Fetch tags on app init
  - [ ] Cache tags locally
  - [ ] Add `createTag()`, `updateTag()`, `deleteTag()` actions
  - [ ] Write unit tests

- [ ] **Task 6: Integrate into Confirmation Screen** (AC: 1, 4)
  - [ ] Add CarTagSelector to SpotActions
  - [ ] Update spot when tag selected (reuse PATCH from Story 2.5)
  - [ ] Show selected tag on button

- [ ] **Task 7: Display Tag in Spot Detail** (AC: 5)
  - [ ] Show tag badge in SpotDetailCard
  - [ ] Use tag color for badge background
  - [ ] Position near title/address

- [ ] **Task 8: Display Tag in History View** (AC: 5)
  - [ ] Show small tag badge in list items
  - [ ] Helps distinguish spots visually
  - [ ] Filter by tag (stretch goal)

- [ ] **Task 9: Guest Mode Tags**
  - [ ] Store custom tags in IndexedDB
  - [ ] Provide same default options
  - [ ] Custom tags local only (won't sync)

- [ ] **Task 10: Tag Management UI (Placeholder)** (AC: 7)
  - [ ] Add TODO for Epic 5 settings
  - [ ] Link "Manage Tags" to settings (disabled)
  - [ ] Document planned functionality

- [ ] **Task 11: Testing**
  - [ ] Test default tags display
  - [ ] Test custom tag creation
  - [ ] Test tag selection saves to spot
  - [ ] Test tag display in history/detail
  - [ ] Write Playwright E2E tests

## Dev Notes

### Architecture References

- [architecture-backend/4-data-models.md](../architecture-backend/4-data-models.md) - CarTag schema
- [architecture/5-api-specification.md](../architecture/5-api-specification.md) - Car tags endpoints

### Car Tags Schema

```typescript
// db/schema/carTags.ts
export const carTags = pgTable('car_tags', {
  id: uuid('id').defaultRandom().primaryKey(),
  userId: uuid('user_id').references(() => users.id), // null = default tag
  name: text('name').notNull(),
  color: text('color').default('#3B82F6'), // Blue default
  isDefault: boolean('is_default').default(false),
  createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),
});

// Seed defaults
// INSERT INTO car_tags (name, color, is_default) VALUES
//   ('My Car', '#3B82F6', true),
//   ('Rental', '#10B981', true),
//   ('Other', '#6B7280', true);
```

### Default Tags

```typescript
const DEFAULT_TAGS: CarTag[] = [
  { id: 'default-my-car', name: 'My Car', color: '#3B82F6', isDefault: true },
  { id: 'default-rental', name: 'Rental', color: '#10B981', isDefault: true },
  { id: 'default-other', name: 'Other', color: '#6B7280', isDefault: true },
];
```

### Car Tag Selector Component

```tsx
// components/spot/CarTagSelector.tsx
interface CarTagSelectorProps {
  selectedTag: string;
  onSelect: (tagName: string) => void;
}

export function CarTagSelector({ selectedTag, onSelect }: CarTagSelectorProps) {
  const { tags } = useCarTagStore();
  const [isOpen, setIsOpen] = useState(false);

  const currentTag = tags.find((t) => t.name === selectedTag) || tags[0];

  return (
    <div className="relative">
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="flex items-center gap-2 px-3 py-2 border rounded-lg"
      >
        <span className="w-3 h-3 rounded-full" style={{ backgroundColor: currentTag.color }} />
        <span>{currentTag.name}</span>
        <ChevronDown className="w-4 h-4" />
      </button>

      {isOpen && (
        <div className="absolute top-full mt-1 w-48 bg-white border rounded-lg shadow-lg z-10">
          {tags.map((tag) => (
            <button
              key={tag.id}
              onClick={() => {
                onSelect(tag.name);
                setIsOpen(false);
              }}
              className="w-full flex items-center gap-2 px-3 py-2 hover:bg-gray-50"
            >
              <span className="w-3 h-3 rounded-full" style={{ backgroundColor: tag.color }} />
              <span>{tag.name}</span>
              {tag.name === selectedTag && <Check className="w-4 h-4 ml-auto" />}
            </button>
          ))}
          <div className="border-t">
            <button
              onClick={() => {
                /* Future: Open create tag modal */
              }}
              className="w-full px-3 py-2 text-blue-500 text-sm hover:bg-gray-50"
            >
              + Add custom tag
            </button>
          </div>
        </div>
      )}
    </div>
  );
}
```

### Car Tags Store

```typescript
// stores/carTagStore.ts
interface CarTagState {
  tags: CarTag[];
  isLoading: boolean;
}

interface CarTagActions {
  fetchTags: () => Promise<void>;
  createTag: (name: string, color?: string) => Promise<CarTag>;
}

export const useCarTagStore = create<CarTagState & CarTagActions>((set, get) => ({
  tags: [],
  isLoading: false,

  fetchTags: async () => {
    const { isGuest } = useGuestStore.getState();

    if (isGuest) {
      const customTags = await indexedDbService.getItem<CarTag[]>('settings', 'carTags');
      set({ tags: [...DEFAULT_TAGS, ...(customTags || [])] });
      return;
    }

    set({ isLoading: true });
    const response = await fetch('/api/v1/car-tags');
    const data = await response.json();
    set({ tags: data, isLoading: false });
  },

  createTag: async (name, color = '#3B82F6') => {
    const { isGuest } = useGuestStore.getState();

    if (isGuest) {
      const newTag = {
        id: crypto.randomUUID(),
        name,
        color,
        isDefault: false,
      };
      const existing = (await indexedDbService.getItem<CarTag[]>('settings', 'carTags')) || [];
      await indexedDbService.setItem('settings', 'carTags', [...existing, newTag]);
      set((state) => ({ tags: [...state.tags, newTag] }));
      return newTag;
    }

    const response = await fetch('/api/v1/car-tags', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, color }),
    });
    const newTag = await response.json();
    set((state) => ({ tags: [...state.tags, newTag] }));
    return newTag;
  },
}));
```

### Tag Badge Display

```tsx
// components/spot/TagBadge.tsx
interface TagBadgeProps {
  name: string;
  color: string;
  size?: 'sm' | 'md';
}

export function TagBadge({ name, color, size = 'md' }: TagBadgeProps) {
  const sizeClasses = size === 'sm' ? 'text-xs px-2 py-0.5' : 'text-sm px-3 py-1';

  return (
    <span
      className={`inline-flex items-center gap-1 rounded-full font-medium ${sizeClasses}`}
      style={{ backgroundColor: `${color}20`, color }}
    >
      <span className="w-2 h-2 rounded-full" style={{ backgroundColor: color }} />
      {name}
    </span>
  );
}
```

### API Endpoints

```bash
# Get all tags (defaults + user's custom)
GET /api/v1/car-tags
→ [{ id, name, color, isDefault }]

# Create custom tag
POST /api/v1/car-tags
{ "name": "Family Van", "color": "#8B5CF6" }
→ { id, name, color, isDefault: false }

# Update tag
PATCH /api/v1/car-tags/:id
{ "name": "Updated Name" }

# Delete tag
DELETE /api/v1/car-tags/:id
```

### File Locations

**New Backend Files:**

- `apps/api/src/db/schema/carTags.ts`
- `apps/api/src/repositories/carTag.repository.ts`
- `apps/api/src/routes/car-tags/carTags.routes.ts`
- `apps/api/src/routes/car-tags/carTags.service.ts`

**New Frontend Files:**

- `apps/web/src/components/spot/CarTagSelector.tsx`
- `apps/web/src/components/spot/TagBadge.tsx`
- `apps/web/src/components/spot/carTag.types.ts`
- `apps/web/src/stores/carTagStore.ts`

### Testing Coverage

- carTagRepository: 100%
- carTags routes: 100%
- CarTagSelector: 90%
- carTagStore: 95%

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation | PO     |
