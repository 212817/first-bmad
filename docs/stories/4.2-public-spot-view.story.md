# Story 4.2: View Shared Spot (Public View)

## Status

Done

## Story

**As a** recipient of a shared parking spot,  
**I want** to view the location and navigate to it,  
**so that** I can find the car.

## Acceptance Criteria

1. Shared link opens a public page (no auth required)
2. Page displays: address/coordinates, photo thumbnail (if any), timestamp
3. "Navigate" button opens maps deep link with walking directions
4. Page indicates this is a shared spot
5. If link is expired or invalid, show appropriate error message
6. Minimal UI - just enough to navigate

## Tasks / Subtasks

- [x] **Task 1: Create Public Shared Spot Endpoint** (AC: 1, 2, 5)
  - [x] Create `GET /v1/share/:token` endpoint (no auth)
  - [x] Look up share token
  - [x] Check if expired
  - [x] Return spot data if valid
  - [x] Return 404/410 if invalid/expired
  - [x] Write integration tests

- [x] **Task 2: Update Share Token Repository** (AC: 1, 5)
  - [x] Add `findByTokenWithSpot(token)` method
  - [x] Join with spots table
  - [x] Include photo URL from R2
  - [x] Check expiration in query or service
  - [x] Write unit tests

- [x] **Task 3: Create Shared Spot Page** (AC: 1, 2, 3, 4, 6)
  - [x] Create `apps/web/src/pages/SharedSpotPage.tsx`
  - [x] Add route `/s/:token` to router (public route)
  - [x] Fetch spot via public API
  - [x] Display address/coordinates
  - [x] Display photo (if exists)
  - [x] Display timestamp
  - [x] Show "Shared spot" indicator

- [x] **Task 4: Navigate Button (Public)** (AC: 3)
  - [x] Reuse navigation service from Story 3.2
  - [x] Add prominent "Navigate" button
  - [x] Opens maps deep link
  - [x] Primary action on page

- [x] **Task 5: Expired/Invalid Error States** (AC: 5)
  - [x] Create `apps/web/src/components/share/ShareExpiredState.tsx`
  - [x] Show "This link has expired" message
  - [x] Show "Link not found" for invalid tokens
  - [x] Suggest downloading the app

- [x] **Task 6: Minimal Public Layout** (AC: 6)
  - [x] Create simple layout without auth UI
  - [x] Show app branding
  - [x] Optional: "Get the app" CTA
  - [x] No navigation menu

- [x] **Task 7: Testing**
  - [x] Test valid token shows spot
  - [x] Test expired token shows error
  - [x] Test invalid token shows 404
  - [x] Test navigate button works
  - [x] Write Playwright E2E tests

## Dev Notes

### Architecture References

- [architecture/5-api-specification.md](../architecture/5-api-specification.md)
- [architecture-frontend/6-component-hierarchy.md](../architecture-frontend/6-component-hierarchy.md)

### Dependencies

- Story 4.1 (share tokens schema and creation)
- Story 3.2 (navigation service)

### API Endpoint

```bash
# Get shared spot (public, no auth)
GET /api/v1/share/:token

# Success Response
{
  "spot": {
    "lat": 40.7128,
    "lng": -74.006,
    "address": "Near Central Park",
    "photoUrl": "https://r2.example.com/photos/uuid.jpg",
    "savedAt": "2026-01-15T10:00:00Z"
  },
  "expiresAt": "2026-01-22T10:00:00Z"
}

# Expired Response
HTTP 410 Gone
{
  "error": "This share link has expired"
}

# Not Found Response
HTTP 404
{
  "error": "Share link not found"
}
```

### Shared Spot Page Component

```tsx
// pages/SharedSpotPage.tsx
import { useParams } from 'react-router-dom';
import { useQuery } from '@tanstack/react-query';
import { navigationService } from '@/services/navigation/navigation.service';

export function SharedSpotPage() {
  const { token } = useParams<{ token: string }>();

  const { data, isLoading, error } = useQuery({
    queryKey: ['sharedSpot', token],
    queryFn: () => fetchSharedSpot(token!),
    retry: false,
  });

  if (isLoading) {
    return <LoadingScreen />;
  }

  if (error) {
    const status = (error as any).response?.status;
    if (status === 410) {
      return <ShareExpiredState />;
    }
    return <ShareNotFoundState />;
  }

  const { spot } = data;

  const handleNavigate = () => {
    navigationService.navigateTo({
      lat: spot.lat,
      lng: spot.lng,
      address: spot.address,
    });
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white p-4 border-b">
        <div className="flex items-center gap-2">
          <Car className="w-6 h-6 text-primary" />
          <span className="font-semibold">Where Did I Park?</span>
        </div>
      </header>

      {/* Shared indicator */}
      <div className="bg-blue-50 p-3 text-center text-sm text-blue-700">
        <Share className="w-4 h-4 inline mr-1" />
        Someone shared a parking spot with you
      </div>

      {/* Photo */}
      {spot.photoUrl && (
        <img src={spot.photoUrl} alt="Parking spot" className="w-full h-48 object-cover" />
      )}

      {/* Content */}
      <div className="p-4 space-y-4">
        <div>
          <h1 className="text-xl font-bold">
            {spot.address || `${spot.lat.toFixed(5)}, ${spot.lng.toFixed(5)}`}
          </h1>
          <p className="text-sm text-gray-500">Saved {formatRelativeTime(spot.savedAt)}</p>
        </div>

        <Button onClick={handleNavigate} className="w-full" variant="primary" size="lg">
          <Navigation className="w-5 h-5 mr-2" />
          Navigate to Spot
        </Button>
      </div>

      {/* Footer */}
      <footer className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t text-center">
        <p className="text-sm text-gray-500 mb-2">Never forget where you parked</p>
        <a href="/" className="text-primary font-medium">
          Get the App →
        </a>
      </footer>
    </div>
  );
}
```

### Share Expired State

```tsx
// components/share/ShareExpiredState.tsx
export function ShareExpiredState() {
  return (
    <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center">
      <Clock className="w-16 h-16 text-gray-300 mb-4" />
      <h1 className="text-xl font-bold text-gray-800">Link Expired</h1>
      <p className="text-gray-500 mt-2 max-w-xs">
        This shared parking spot link has expired for privacy reasons. Links are valid for 7 days.
      </p>
      <a href="/" className="mt-6 text-primary font-medium">
        Get Where Did I Park? →
      </a>
    </div>
  );
}
```

### Router Configuration

```typescript
// router.tsx - add public route
{
  path: '/s/:token',
  element: <SharedSpotPage />,
  // No auth wrapper - public route
}
```

### File Locations

**New Files:**

- `apps/api/src/routes/share/share.routes.ts`
- `apps/web/src/pages/SharedSpotPage.tsx`
- `apps/web/src/components/share/ShareExpiredState.tsx`
- `apps/web/src/components/share/ShareNotFoundState.tsx`

**Modified Files:**

- `apps/api/src/routes/index.ts` - add share routes
- `apps/web/src/router.tsx` - add /s/:token route

### Security Considerations

- No sensitive user data exposed (no user ID, email)
- Photo URLs are already signed/public
- Token is unguessable (nanoid 21 chars = 126 bits entropy)
- 7-day expiration limits exposure

### Testing Coverage

- SharedSpotPage: 90%
- Public endpoint: 100%
- Error states: 95%

## Change Log

| Date       | Version | Description                      | Author |
| ---------- | ------- | -------------------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation           | PO     |
| 2026-02-06 | 1.1     | Implementation verified complete | Dev    |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### File List

**Backend (apps/api):**

- `apps/api/src/routes/share/share.routes.ts` - Public GET /v1/share/:token endpoint
- `apps/api/src/routes/share/share.service.ts` - Share service business logic
- `apps/api/src/routes/share/types.ts` - SharedSpotResponse type and mapper
- `apps/api/src/repositories/shareToken.repository.ts` - findByToken with spot join
- `apps/api/src/repositories/shareToken.types.ts` - ShareTokenWithSpot type
- `apps/api/src/app.ts` - Registers shareRoutes (modified)
- `apps/api/test/integration/share.test.ts` - Integration tests
- `apps/api/test/unit/shareToken.repository.test.ts` - Repository unit tests

**Frontend (apps/web):**

- `apps/web/src/pages/SharedSpotPage.tsx` - Public shared spot view page
- `apps/web/src/pages/__tests__/SharedSpotPage.test.tsx` - Page unit tests
- `apps/web/src/App.tsx` - Route /s/:token (modified)
- `apps/web/src/services/api/shareApi.ts` - Share API client
- `apps/web/e2e/share-spot.spec.ts` - Playwright E2E tests

### Debug Log References

None - implementation was already complete when story was assigned.

### Completion Notes

- All 7 tasks and subtasks verified complete
- API tests: 272 passing (including 4 share-specific integration tests)
- Web tests: 723 passing (including SharedSpotPage tests)
- E2E tests exist for share functionality
- Error states handled inline in SharedSpotPage (no separate components)
- Navigation uses existing navigation service with MapPickerModal
