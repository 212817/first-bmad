# Story 4.3: Set Meter Timer

## Status

Ready for Review

## Story

**As a** user with metered parking,  
**I want** to set a reminder for when my meter expires,  
**so that** I don't get a parking ticket.

## Acceptance Criteria

1. Confirmation screen shows "Set Timer" option
2. User can input duration (minutes) or select preset (30min, 1hr, 2hr)
3. Timer expiry time is calculated and saved with spot record
4. Timer countdown displays on spot detail and home screen
5. Meter expiry is stored as UTC timestamp
6. Timer is optional - most spots won't have one

## Tasks / Subtasks

- [x] **Task 1: Update Spots Schema** (AC: 5)
  - [x] Add `meterExpiresAt` column (nullable timestamp)
  - [x] Run migration
  - [x] Update Spot type definition
  - [x] Write unit tests

- [x] **Task 2: Backend - Update Spot Endpoint** (AC: 5, 6)
  - [x] Modify `PATCH /v1/spots/:spotId` to accept `meterExpiresAt`
  - [x] Validate timestamp is in future
  - [x] Allow null to clear timer
  - [x] Write integration tests

- [x] **Task 3: Create Timer Input Component** (AC: 1, 2)
  - [x] Create `apps/web/src/components/timer/MeterTimerInput.tsx`
  - [x] Preset buttons: 30min, 1hr, 2hr
  - [x] Custom input for minutes
  - [x] Calculate expiry from now + duration
  - [x] Clear button to remove timer

- [x] **Task 4: Create Timer Display Component** (AC: 4)
  - [x] Create `apps/web/src/components/timer/MeterTimerDisplay.tsx`
  - [x] Show countdown: "1h 23m remaining"
  - [x] Color code: green (>30min), yellow (10-30min), red (<10min)
  - [x] Show "Expired" when past due
  - [x] Update every minute

- [x] **Task 5: Integrate Timer Input on Confirmation** (AC: 1, 2)
  - [x] Add MeterTimerInput to ConfirmationPage
  - [x] Optional section: "Set meter timer?"
  - [x] Save timer when spot is saved
  - [x] Skip if user doesn't set one

- [x] **Task 6: Integrate Timer Display** (AC: 4)
  - [x] Add to LatestSpotCard (Story 3.1)
  - [x] Add to SpotDetailPage (Story 3.4)
  - [x] Only show if meterExpiresAt is set
  - [x] Update countdown in real-time

- [x] **Task 7: Update Spot Store** (AC: 3)
  - [x] Add `setMeterTimer(spotId, expiresAt)` action
  - [x] Add `clearMeterTimer(spotId)` action
  - [x] Update local state after save

- [x] **Task 8: Guest Mode Timer** (AC: 5, 6)
  - [x] Store meterExpiresAt in IndexedDB
  - [x] Same display behavior
  - [x] Write unit tests

- [x] **Task 9: Testing**
  - [x] Test preset buttons calculate correctly
  - [x] Test custom input works
  - [x] Test countdown updates
  - [x] Test expired state
  - [x] Test clearing timer
  - [x] Write Playwright E2E tests

## Dev Notes

### Architecture References

- [architecture/5-api-specification.md](../architecture/5-api-specification.md)
- [architecture-frontend/6-component-hierarchy.md](../architecture-frontend/6-component-hierarchy.md)

### Dependencies

- Story 2.2 (ConfirmationPage)
- Story 3.1 (LatestSpotCard)
- Story 3.4 (SpotDetailPage)

### Database Migration

```typescript
// migrations/add_meter_expires_at.ts
export async function up(db: Database) {
  await db.schema
    .alterTable('spots')
    .addColumn('meter_expires_at', 'timestamp', (col) => col.nullable());
}

export async function down(db: Database) {
  await db.schema.alterTable('spots').dropColumn('meter_expires_at');
}
```

### API Endpoint

```bash
# Set meter timer
PATCH /api/v1/spots/:spotId
Authorization: Bearer <token>
Content-Type: application/json

{
  "meterExpiresAt": "2026-01-15T12:30:00Z"
}

# Clear meter timer
PATCH /api/v1/spots/:spotId
{
  "meterExpiresAt": null
}
```

### Meter Timer Input Component

```tsx
// components/timer/MeterTimerInput.tsx
interface MeterTimerInputProps {
  value?: Date;
  onChange: (expiresAt: Date | null) => void;
}

const PRESETS = [
  { label: '30 min', minutes: 30 },
  { label: '1 hour', minutes: 60 },
  { label: '2 hours', minutes: 120 },
];

export function MeterTimerInput({ value, onChange }: MeterTimerInputProps) {
  const [customMinutes, setCustomMinutes] = useState('');

  const handlePreset = (minutes: number) => {
    const expiresAt = new Date(Date.now() + minutes * 60 * 1000);
    onChange(expiresAt);
  };

  const handleCustom = () => {
    const minutes = parseInt(customMinutes, 10);
    if (minutes > 0) {
      const expiresAt = new Date(Date.now() + minutes * 60 * 1000);
      onChange(expiresAt);
    }
  };

  const handleClear = () => {
    onChange(null);
    setCustomMinutes('');
  };

  return (
    <div className="space-y-3">
      <label className="text-sm font-medium text-gray-700">Meter Timer (optional)</label>

      {/* Presets */}
      <div className="flex gap-2">
        {PRESETS.map((preset) => (
          <button
            key={preset.minutes}
            onClick={() => handlePreset(preset.minutes)}
            className="px-4 py-2 rounded-lg border hover:bg-gray-50"
          >
            {preset.label}
          </button>
        ))}
      </div>

      {/* Custom input */}
      <div className="flex gap-2">
        <input
          type="number"
          value={customMinutes}
          onChange={(e) => setCustomMinutes(e.target.value)}
          placeholder="Custom minutes"
          className="flex-1 px-3 py-2 border rounded-lg"
          min="1"
          max="1440"
        />
        <Button onClick={handleCustom} variant="secondary">
          Set
        </Button>
      </div>

      {/* Current timer */}
      {value && (
        <div className="flex items-center justify-between bg-blue-50 p-3 rounded-lg">
          <span className="text-sm">Timer set for {formatDateTime(value)}</span>
          <button onClick={handleClear} className="text-red-500 text-sm">
            Clear
          </button>
        </div>
      )}
    </div>
  );
}
```

### Meter Timer Display Component

```tsx
// components/timer/MeterTimerDisplay.tsx
interface MeterTimerDisplayProps {
  expiresAt: Date;
  size?: 'sm' | 'md' | 'lg';
}

export function MeterTimerDisplay({ expiresAt, size = 'md' }: MeterTimerDisplayProps) {
  const [timeLeft, setTimeLeft] = useState(calculateTimeLeft(expiresAt));

  useEffect(() => {
    const interval = setInterval(() => {
      setTimeLeft(calculateTimeLeft(expiresAt));
    }, 60000); // Update every minute

    return () => clearInterval(interval);
  }, [expiresAt]);

  const isExpired = timeLeft.totalMinutes <= 0;
  const isUrgent = timeLeft.totalMinutes <= 10;
  const isWarning = timeLeft.totalMinutes <= 30;

  const colorClass = isExpired
    ? 'text-red-600 bg-red-50'
    : isUrgent
      ? 'text-red-600 bg-red-50'
      : isWarning
        ? 'text-yellow-600 bg-yellow-50'
        : 'text-green-600 bg-green-50';

  return (
    <div className={`inline-flex items-center gap-1 px-2 py-1 rounded ${colorClass}`}>
      <Clock className="w-4 h-4" />
      <span className={size === 'sm' ? 'text-xs' : 'text-sm'}>
        {isExpired ? 'Expired' : formatTimeLeft(timeLeft)}
      </span>
    </div>
  );
}

function calculateTimeLeft(expiresAt: Date) {
  const diff = new Date(expiresAt).getTime() - Date.now();
  const totalMinutes = Math.floor(diff / 60000);
  const hours = Math.floor(totalMinutes / 60);
  const minutes = totalMinutes % 60;
  return { totalMinutes, hours, minutes };
}

function formatTimeLeft({ hours, minutes }: { hours: number; minutes: number }) {
  if (hours > 0) {
    return `${hours}h ${minutes}m`;
  }
  return `${minutes}m`;
}
```

### Integration in LatestSpotCard

```tsx
// In LatestSpotCard.tsx
{
  spot.meterExpiresAt && <MeterTimerDisplay expiresAt={new Date(spot.meterExpiresAt)} />;
}
```

### File Locations

**New Files:**

- `apps/web/src/components/timer/MeterTimerInput.tsx`
- `apps/web/src/components/timer/MeterTimerDisplay.tsx`
- `apps/api/src/migrations/add_meter_expires_at.ts`

**Modified Files:**

- `apps/api/src/schema/spots.ts` - add meterExpiresAt column
- `apps/api/src/routes/spots/spots.routes.ts` - handle meterExpiresAt in PATCH
- `apps/web/src/types/spot.ts` - add meterExpiresAt to Spot type
- `apps/web/src/pages/ConfirmationPage.tsx` - add timer input
- `apps/web/src/components/spot/LatestSpotCard.tsx` - add timer display
- `apps/web/src/pages/SpotDetailPage.tsx` - add timer display

### Testing Coverage

- MeterTimerInput: 95%
- MeterTimerDisplay: 90%
- Timer calculation: 100%
- Backend PATCH: 100%

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### File List

**New Files:**

- `apps/web/src/components/timer/types.ts`
- `apps/web/src/components/timer/MeterTimerInput.tsx`
- `apps/web/src/components/timer/MeterTimerDisplay.tsx`
- `apps/web/src/components/timer/index.ts`
- `apps/web/src/components/timer/__tests__/MeterTimerInput.test.tsx`
- `apps/web/src/components/timer/__tests__/MeterTimerDisplay.test.tsx`
- `apps/api/drizzle/migrations/0005_typical_riptide.sql`

**Modified Files:**

- `packages/shared/src/db/schema.ts` - added meterExpiresAt column
- `packages/shared/src/types/index.ts` - added meterExpiresAt to ParkingSpot
- `apps/api/src/repositories/spot.repository.ts` - updated mapToSpot
- `apps/api/src/repositories/spot.types.ts` - added meterExpiresAt to UpdateSpotInput
- `apps/api/src/repositories/shareToken.repository.ts` - added meterExpiresAt to mapToSpot
- `apps/api/src/routes/spots/types.ts` - added meterExpiresAt to SpotResponse and UpdateSpotRequest
- `apps/api/src/routes/spots/spots.service.ts` - added validation and conversion
- `apps/api/test/unit/spot.repository.test.ts` - added meterExpiresAt tests
- `apps/api/test/integration/spots.test.ts` - added meterExpiresAt tests
- `apps/web/src/stores/spot.types.ts` - added meterExpiresAt to Spot, UpdateSpotInput, and SpotActions
- `apps/web/src/stores/spotStore.ts` - added setMeterTimer, clearMeterTimer, and latestSpot sync
- `apps/web/src/stores/__tests__/spotStore.test.ts` - added meterExpiresAt to mock spots, guest mode timer tests
- `apps/web/src/pages/SpotConfirmationPage.tsx` - integrated MeterTimerInput
- `apps/web/src/pages/SpotDetailPage.tsx` - integrated MeterTimerDisplay
- `apps/web/src/pages/__tests__/SpotConfirmationPage.test.tsx` - added meterExpiresAt to mock spots
- `apps/web/src/pages/__tests__/SpotDetailPage.test.tsx` - added meterExpiresAt to mock spots
- `apps/web/src/pages/__tests__/HistoryPage.test.tsx` - added meterExpiresAt to mock spots
- `apps/web/src/components/spot/SpotActions.tsx` - enabled Timer button
- `apps/web/src/components/spot/LatestSpotCard.tsx` - integrated MeterTimerDisplay
- `apps/web/src/components/spot/__tests__/SpotActions.test.tsx` - updated timer tests
- `apps/web/src/components/spot/__tests__/LatestSpotCard.test.tsx` - added timer tests
- `apps/web/src/components/spot/__tests__/SpotDetailCard.test.tsx` - added meterExpiresAt to mock spots
- `apps/web/src/components/history/__tests__/HistorySpotItem.test.tsx` - added meterExpiresAt to mock spots
- `apps/web/src/components/history/__tests__/SpotList.test.tsx` - added meterExpiresAt to mock spots
- `apps/web/src/hooks/useNavigation/__tests__/useNavigation.test.ts` - added meterExpiresAt to mock spots
- `apps/web/src/utils/__tests__/filterSpots.test.ts` - added meterExpiresAt to mock spots
- `apps/web/e2e/spot-confirmation.spec.ts` - added meter timer E2E tests, updated Timer button expectation

### Debug Log References

N/A - No blocking issues encountered

### Completion Notes

- All 9 tasks completed successfully
- Backend: Added meterExpiresAt column to spots table with migration 0005_typical_riptide.sql
- Backend: PATCH endpoint validates meterExpiresAt is in future or null
- Frontend: MeterTimerInput component with 30min/1hr/2hr presets and custom input
- Frontend: MeterTimerDisplay component with color-coded countdown (green/yellow/red)
- Integration: Timer input on SpotConfirmationPage, display on LatestSpotCard and SpotDetailPage
- Store: setMeterTimer and clearMeterTimer actions, also updates latestSpot when applicable
- Guest mode: meterExpiresAt stored in IndexedDB, same display behavior
- Testing: 25 timer unit tests, 5 guest mode timer tests, 5 E2E tests added
- All 1036 tests passing (757 web + 279 API)

## Change Log

| Date       | Version | Description             | Author    |
| ---------- | ------- | ----------------------- | --------- |
| 2026-01-15 | 1.0     | Initial story creation  | PO        |
| 2025-07-14 | 1.1     | Implementation complete | Dev Agent |
