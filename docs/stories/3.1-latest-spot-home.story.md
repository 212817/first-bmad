# Story 3.1: Display Latest Spot on Home Screen

## Status

Done

## Story

**As a** user,  
**I want** to see my most recent parking spot on the home screen,  
**so that** I can quickly navigate back without extra taps.

## Acceptance Criteria

1. Home screen shows a card with latest saved spot
2. Card displays: address (or coordinates), timestamp, car tag, photo thumbnail (if exists)
3. Card shows "Navigate" button prominently
4. If no spots saved, show empty state with prompt to save first spot
5. Latest spot updates immediately after new save
6. For guest mode, pulls from IndexedDB; for authenticated, from database

## Tasks / Subtasks

- [x] **Task 1: Create Latest Spot Card Component** (AC: 1, 2, 3)
  - [x] Create `apps/web/src/components/spot/LatestSpotCard.tsx`
  - [x] Display address or formatted coordinates
  - [x] Display relative timestamp ("2 hours ago")
  - [x] Display car tag badge (from Story 2.7)
  - [x] Display photo thumbnail (if exists)
  - [x] Add prominent "Navigate" button
  - [x] Style for mobile-first, touch-friendly

- [x] **Task 2: Backend - Get Latest Spot Endpoint** (AC: 6)
  - [x] Add `GET /v1/spots/latest` endpoint
  - [x] Return most recent spot for authenticated user
  - [x] Include all spot fields (photo, note, tag, address)
  - [x] Return 404 if no spots exist
  - [x] Write integration tests

- [x] **Task 3: Update Spot Repository** (AC: 6)
  - [x] Add `findLatestByUserId(userId)` method
  - [x] Query with `ORDER BY savedAt DESC LIMIT 1`
  - [x] Write unit tests

- [x] **Task 4: Update Spot Store for Latest** (AC: 5, 6)
  - [x] Add `latestSpot` state to spotStore
  - [x] Add `fetchLatestSpot()` action
  - [x] Handle auth vs guest mode routing
  - [x] Auto-update after new spot save
  - [x] Write unit tests

- [x] **Task 5: Guest Mode Latest Spot** (AC: 6)
  - [x] Add `getLatestSpot()` to IndexedDB service
  - [x] Query spots store sorted by savedAt
  - [x] Return most recent or null
  - [x] Write unit tests

- [x] **Task 6: Integrate into Home Page** (AC: 1, 5)
  - [x] Update `HomePage.tsx` to include LatestSpotCard
  - [x] Fetch latest spot on mount
  - [x] Update card after new spot saved
  - [x] Position below/above save button based on design

- [x] **Task 7: Empty State Component** (AC: 4)
  - [x] Create `apps/web/src/components/spot/EmptySpotState.tsx`
  - [x] Show message: "No parking spot saved yet"
  - [x] Include prompt: "Tap below to save your first spot"
  - [x] Style with illustration or icon

- [x] **Task 8: Photo Thumbnail Component** (AC: 2)
  - [x] Create `apps/web/src/components/spot/SpotThumbnail.tsx`
  - [x] Load photo from signed URL
  - [x] Show placeholder while loading
  - [x] Handle missing photo gracefully
  - [x] Optimize for small size (lazy load)

- [x] **Task 9: Testing**
  - [x] Test card displays all fields
  - [x] Test empty state shows correctly
  - [x] Test auto-update after save
  - [x] Test guest mode
  - [x] Write Playwright E2E tests

## Dev Notes

### Architecture References

- [architecture-frontend/6-component-hierarchy.md](../architecture-frontend/6-component-hierarchy.md)
- [architecture/5-api-specification.md](../architecture/5-api-specification.md)

### Dependencies

- Story 2.1 (spots database and store)
- Story 2.7 (car tags display)
- Story 2.8 (address display)

### Latest Spot Card Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ…¿ï¸ My Car                     2h agoâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”                             â”‚
â”‚ â”‚photoâ”‚  Near Central Park West     â”‚
â”‚ â”‚     â”‚  New York, NY               â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         [ ğŸ§­ Navigate ]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### API Endpoint

```bash
# Get latest spot
GET /api/v1/spots/latest
Authorization: Bearer <token>

# Response
{
  "id": "uuid",
  "lat": 40.7128,
  "lng": -74.006,
  "address": "Near Central Park West, New York",
  "photoUrl": "https://...",
  "note": "Level P2",
  "carTag": "My Car",
  "savedAt": "2026-01-15T10:00:00Z"
}

# No spots
HTTP 404
{ "error": "No spots found" }
```

### Component Implementation

```tsx
// components/spot/LatestSpotCard.tsx
interface LatestSpotCardProps {
  spot: Spot | null;
  onNavigate: () => void;
}

export function LatestSpotCard({ spot, onNavigate }: LatestSpotCardProps) {
  if (!spot) {
    return <EmptySpotState />;
  }

  return (
    <div className="bg-white rounded-xl shadow-md p-4">
      <div className="flex justify-between items-center mb-3">
        <TagBadge name={spot.carTag || 'My Car'} />
        <span className="text-sm text-gray-500">{formatRelativeTime(spot.savedAt)}</span>
      </div>

      <div className="flex gap-3 mb-4">
        {spot.photoUrl && <SpotThumbnail url={spot.photoUrl} className="w-16 h-16 rounded" />}
        <div>
          <p className="font-medium">{spot.address || formatCoords(spot.lat, spot.lng)}</p>
          {spot.note && <p className="text-sm text-gray-500">{spot.note}</p>}
        </div>
      </div>

      <button
        onClick={onNavigate}
        className="w-full h-12 bg-blue-500 text-white rounded-lg font-medium flex items-center justify-center gap-2"
      >
        <CompassIcon className="w-5 h-5" />
        Navigate
      </button>
    </div>
  );
}
```

### File Locations

**New Files:**

- `apps/web/src/components/spot/LatestSpotCard.tsx`
- `apps/web/src/components/spot/EmptySpotState.tsx`
- `apps/web/src/components/spot/SpotThumbnail.tsx`
- `apps/web/src/utils/formatters.ts`
- `apps/web/src/utils/__tests__/formatters.test.ts`
- `apps/web/src/components/spot/__tests__/LatestSpotCard.test.tsx`
- `apps/web/src/components/spot/__tests__/EmptySpotState.test.tsx`
- `apps/web/src/components/spot/__tests__/SpotThumbnail.test.tsx`
- `apps/web/e2e/latest-spot.spec.ts`

**Modified Files:**

- `apps/api/src/routes/spots/spots.routes.ts` - add latest endpoint
- `apps/api/src/routes/spots/spots.service.ts` - add getLatestSpot method
- `apps/api/src/repositories/spot.repository.ts` - add findLatestByUserId
- `apps/api/src/repositories/spot.types.ts` - add findLatestByUserId to interface
- `apps/api/test/integration/spots.test.ts` - add tests for /latest endpoint
- `apps/web/src/stores/spotStore.ts` - add latestSpot state, fetchLatestSpot action
- `apps/web/src/stores/spot.types.ts` - add latestSpot, isLoadingLatest, fetchLatestSpot
- `apps/web/src/stores/__tests__/spotStore.test.ts` - add tests for fetchLatestSpot
- `apps/web/src/services/storage/indexedDb.service.ts` - add getLatestSpot method
- `apps/web/src/services/storage/types.ts` - add getLatestSpot to interface
- `apps/web/src/services/storage/__tests__/indexedDb.service.test.ts` - add getLatestSpot tests
- `apps/web/src/components/spot/index.ts` - export new components
- `apps/web/src/components/spot/types.ts` - add new component props
- `apps/web/src/pages/HomePage.tsx` - integrate LatestSpotCard

### Testing Coverage

- LatestSpotCard: 95%
- EmptySpotState: 90%
- Latest endpoint: 100%

## QA Results

### Review Date: 2026-02-03

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent implementation** âœ…

The story has been implemented with high code quality across all components. The implementation follows architecture patterns, coding standards, and demonstrates strong test coverage. The code is well-structured, properly typed, and follows mobile-first design principles.

**Key Strengths:**

- Clean component architecture with proper separation of concerns
- Comprehensive test coverage at unit and integration levels
- Proper loading/error/empty states for all UI components
- Good accessibility with ARIA labels and semantic HTML
- Tailwind styling follows mobile-first, touch-friendly patterns
- Proper auth vs guest mode routing in the store

### Requirements Traceability

| AC  | Requirement                                                        | Test Coverage                                                     | Status |
| --- | ------------------------------------------------------------------ | ----------------------------------------------------------------- | ------ |
| 1   | Home screen shows card with latest saved spot                      | `LatestSpotCard.test.tsx`, `latest-spot.spec.ts`                  | âœ…     |
| 2   | Card displays: address/coords, timestamp, car tag, photo thumbnail | `LatestSpotCard.test.tsx` (8+ tests)                              | âœ…     |
| 3   | Card shows "Navigate" button prominently                           | `LatestSpotCard.test.tsx`, E2E test                               | âœ…     |
| 4   | Empty state with prompt when no spots                              | `EmptySpotState.test.tsx`, `latest-spot.spec.ts`                  | âœ…     |
| 5   | Latest spot updates immediately after save                         | `spotStore.test.ts`, `latest-spot.spec.ts`                        | âœ…     |
| 6   | Guest: IndexedDB, Auth: database                                   | `spotStore.test.ts`, `indexedDb.service.test.ts`, `spots.test.ts` | âœ…     |

### Test Architecture Assessment

**Unit Tests (72 tests total, all passing):**

- `LatestSpotCard.test.tsx`: 13 tests - renders, displays all fields, loading/empty states
- `EmptySpotState.test.tsx`: 5 tests - message, icon, prompt, className
- `SpotThumbnail.test.tsx`: 7 tests - loading, error, lazy load, alt text
- `formatters.test.ts`: 9 tests - relative time, coordinates
- `spotStore.test.ts`: ~20 tests for fetchLatestSpot (auth/guest modes, 404 handling)
- `indexedDb.service.test.ts`: 5 tests for getLatestSpot
- `spots.test.ts`: 5 tests for /latest endpoint

**E2E Tests (`latest-spot.spec.ts`):**

- Empty state display (AC4)
- Card appears after save (AC1, AC5)
- Timestamp display (AC2)
- Navigate button opens maps (AC3)
- Guest mode IndexedDB storage (AC6)

**Test Design Quality:** Excellent

- Tests use fake timers for time-dependent assertions
- Proper mocking of external dependencies
- Edge cases covered (no photo, no note, no address)
- Error states and loading states tested

### Compliance Check

- Coding Standards: âœ… Arrow functions, types in types.ts, Tailwind styling, proper naming
- Project Structure: âœ… Components in proper folders, exports via index.ts
- Testing Strategy: âœ… Unit tests for components, integration for API, E2E for flows
- All ACs Met: âœ… All 6 acceptance criteria have corresponding tests and implementation

### Improvements Checklist

All items are minor enhancements, not blockers:

- [x] Loading skeleton implemented with proper animations
- [x] Error handling for image load failures
- [x] Lazy loading for images (performance optimization)
- [x] Touch-manipulation CSS for better mobile experience
- [ ] Consider adding loading state for navigate button while maps URL opens
- [ ] Consider caching geocoded addresses to reduce API calls (future optimization)

### Security Review

âœ… **No security concerns identified**

- API endpoint properly requires authentication (`authMiddleware`)
- User ID from token is used for queries (no user-supplied ID injection)
- No sensitive data exposed in client components
- Photo URLs use signed URLs (handled by upstream photo service)

### Performance Considerations

âœ… **Good performance practices observed**

- Images use `loading="lazy"` attribute
- Thumbnail component has proper loading/error states
- IndexedDB query sorts in-memory (acceptable for expected data volume <100 spots)
- No unnecessary re-renders (simple component structure)

**Minor observation:** IndexedDB `getLatestSpot` fetches all spots then sorts. For very large datasets, an index-based approach would be more efficient, but this is acceptable for the expected use case.

### Refactoring Performed

None required - code quality is already high.

### Files Modified During Review

None - no changes were necessary.

### Gate Status

**Gate: PASS** â†’ [docs/qa/gates/3.1-latest-spot-home.yml](docs/qa/gates/3.1-latest-spot-home.yml)

### Recommended Status

âœ… **Ready for Done**

All acceptance criteria are fully implemented with comprehensive test coverage. The implementation follows coding standards and architectural patterns. No blocking issues identified.

---

## Change Log

| Date       | Version | Description             | Author    |
| ---------- | ------- | ----------------------- | --------- |
| 2026-01-15 | 1.0     | Initial story creation  | PO        |
| 2026-02-03 | 1.1     | Implementation complete | Dev Agent |
| 2026-02-03 | 1.2     | QA Review - PASS        | Quinn     |
