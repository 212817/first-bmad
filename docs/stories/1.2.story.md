# Story 1.2: Google OAuth Sign-In

## Status

Approved

## Story

**As a** user,  
**I want** to sign in with my Google account,  
**so that** my parking spots sync across all my devices.

## Acceptance Criteria

1. Login screen displays "Continue with Google" button
2. Clicking button initiates Google OAuth 2.0 flow
3. After successful authentication, user is redirected back to app
4. Backend validates Google ID token and creates/retrieves user record in database
5. User session is established with JWT token (stored in httpOnly cookie)
6. App displays user's email/name after sign-in
7. User record includes: id, email, auth_provider ('google'), created_at
8. Errors during auth flow display user-friendly messages
9. Auth endpoints testable via curl/Postman with documented request/response examples

## Tasks / Subtasks

- [ ] **Task 1: Setup Google OAuth Credentials** (AC: 2)
  - [ ] Create Google Cloud Console project (if not exists)
  - [ ] Enable Google+ API or People API for user info
  - [ ] Create OAuth 2.0 credentials (Client ID + Secret)
  - [ ] Configure authorized redirect URIs for dev and prod
  - [ ] Add `GOOGLE_CLIENT_ID` and `GOOGLE_CLIENT_SECRET` to `.env`
  - [ ] Add frontend `VITE_GOOGLE_CLIENT_ID` to `.env`

- [ ] **Task 2: Create User Repository** (AC: 4, 7)
  - [ ] Create `apps/api/src/repositories/user.repository.ts`
  - [ ] Create `apps/api/src/repositories/types.ts` with repository types
  - [ ] Implement `findByProviderAndId(provider, providerId)` method
  - [ ] Implement `findById(id)` method
  - [ ] Implement `create(userData)` method
  - [ ] Implement `updateLastLogin(userId)` method
  - [ ] Write unit tests for user repository

- [ ] **Task 3: Create JWT Service** (AC: 5)
  - [ ] Create `apps/api/src/services/jwt/jwt.service.ts`
  - [ ] Create `apps/api/src/services/jwt/types.ts`
  - [ ] Implement `generateAccessToken(userId, email)` - 15min expiry
  - [ ] Implement `generateRefreshToken(userId)` - 7d expiry
  - [ ] Implement `verifyAccessToken(token)` method
  - [ ] Implement `verifyRefreshToken(token)` method
  - [ ] Add `JWT_ACCESS_SECRET` and `JWT_REFRESH_SECRET` to env validation
  - [ ] Write unit tests for JWT service

- [ ] **Task 4: Create Refresh Token Repository** (AC: 5)
  - [ ] Add `refreshTokens` table migration (if not in schema)
  - [ ] Create refresh token repository functions
  - [ ] Implement `create(userId, tokenHash, expiresAt)` method
  - [ ] Implement `findByTokenHash(hash)` method
  - [ ] Implement `deleteByUserId(userId)` method for logout
  - [ ] Implement `deleteExpired()` for cleanup

- [ ] **Task 5: Create Auth Routes - Google OAuth** (AC: 2, 3, 4, 5)
  - [ ] Create `apps/api/src/routes/auth/auth.routes.ts`
  - [ ] Create `apps/api/src/routes/auth/auth.service.ts`
  - [ ] Create `apps/api/src/routes/auth/types.ts`
  - [ ] Implement `GET /auth/google` - redirect to Google consent screen
  - [ ] Implement `GET /auth/google/callback` - handle OAuth callback
  - [ ] Exchange authorization code for tokens via Google API
  - [ ] Fetch user info from Google (email, name, avatar)
  - [ ] Create or retrieve user in database
  - [ ] Generate JWT access + refresh tokens
  - [ ] Set tokens in httpOnly cookies
  - [ ] Redirect to frontend app

- [ ] **Task 6: Create Auth Routes - Session Management** (AC: 5, 6)
  - [ ] Implement `GET /auth/me` - return current user info
  - [ ] Implement `POST /auth/refresh` - refresh access token
  - [ ] Implement `POST /auth/logout` - invalidate refresh token
  - [ ] Write integration tests for all auth endpoints

- [ ] **Task 7: Create Auth Middleware** (AC: 5)
  - [ ] Create `apps/api/src/middleware/auth.middleware.ts`
  - [ ] Extract JWT from Authorization header or cookie
  - [ ] Verify token and attach user to request
  - [ ] Handle expired token errors appropriately
  - [ ] Write unit tests for auth middleware

- [ ] **Task 8: Frontend - Login Page UI** (AC: 1, 8)
  - [ ] Create `apps/web/src/pages/LoginPage.tsx`
  - [ ] Create `apps/web/src/components/auth/LoginButton.tsx`
  - [ ] Create `apps/web/src/components/auth/types.ts`
  - [ ] Style "Continue with Google" button per Google branding guidelines
  - [ ] Add loading state during OAuth redirect
  - [ ] Add error display for failed auth attempts
  - [ ] Add route `/login` in App router

- [ ] **Task 9: Frontend - Auth Store and Hook** (AC: 6)
  - [ ] Create `apps/web/src/stores/authStore.ts`
  - [ ] Create `apps/web/src/stores/types.ts` with auth state types
  - [ ] Create `apps/web/src/hooks/useAuth/useAuth.ts`
  - [ ] Create `apps/web/src/hooks/useAuth/types.ts`
  - [ ] Implement `login(provider)` - redirect to OAuth
  - [ ] Implement `logout()` - call API and clear state
  - [ ] Implement `refreshUser()` - fetch current user
  - [ ] Store user info (email, displayName, avatarUrl) in state
  - [ ] Write unit tests for useAuth hook

- [ ] **Task 10: Frontend - Auth API Service** (AC: 3, 6)
  - [ ] Create `apps/web/src/services/api/authApi.ts`
  - [ ] Implement `getOAuthUrl(provider)` - build OAuth redirect URL
  - [ ] Implement `getMe()` - fetch current user
  - [ ] Implement `refresh()` - refresh access token
  - [ ] Implement `logout()` - call logout endpoint
  - [ ] Configure axios interceptor for 401 → auto refresh

- [ ] **Task 11: Frontend - Auth Guard** (AC: 3, 6)
  - [ ] Create `apps/web/src/components/auth/AuthGuard.tsx`
  - [ ] Check auth state on mount
  - [ ] Redirect to /login if not authenticated
  - [ ] Show loading state while checking auth
  - [ ] Wrap protected routes with AuthGuard

- [ ] **Task 12: Display User Info** (AC: 6)
  - [ ] Update `apps/web/src/components/layout/Header.tsx`
  - [ ] Display user avatar (or initials) when signed in
  - [ ] Display user name/email in dropdown or header
  - [ ] Add sign out option in header/menu

- [ ] **Task 13: Documentation** (AC: 9)
  - [ ] Document auth endpoints in README or API docs
  - [ ] Include curl examples for testing OAuth flow
  - [ ] Document environment variables required
  - [ ] Document Google Cloud Console setup steps

## Dev Notes

### Previous Story (1.1) Context

Story 1.1 established the monorepo structure with:

- `apps/web/` - React frontend with Vite
- `apps/api/` - Express backend
- `packages/shared/` - Shared types and schemas
- Health endpoint at `/health`
- Database connection via Drizzle ORM to Neon

This story builds on that foundation by adding authentication.

### Authentication Flow Diagram

[Source: architecture/7-core-workflows.md]

```
┌────────┐     ┌────────┐     ┌────────┐     ┌────────┐
│  User  │     │  PWA   │     │  API   │     │ Google │
└───┬────┘     └───┬────┘     └───┬────┘     └───┬────┘
    │              │              │              │
    │ Click Login  │              │              │
    │─────────────>│              │              │
    │              │              │              │
    │              │ GET /auth/google            │
    │              │─────────────>│              │
    │              │              │              │
    │              │   Redirect   │              │
    │              │<─────────────│              │
    │              │              │              │
    │         Redirect to Google consent        │
    │<─────────────────────────────────────────>│
    │              │              │              │
    │              │  Callback with code         │
    │              │─────────────>│              │
    │              │              │              │
    │              │              │ Exchange code│
    │              │              │─────────────>│
    │              │              │              │
    │              │              │ User info    │
    │              │              │<─────────────│
    │              │              │              │
    │              │ Set cookies (access+refresh)│
    │              │<─────────────│              │
    │              │              │              │
    │  Redirect to app            │              │
    │<─────────────│              │              │
```

### API Endpoints

[Source: architecture/5-api-specification.md]

| Method | Endpoint                | Description              |
| ------ | ----------------------- | ------------------------ |
| GET    | `/auth/google`          | Initiate Google OAuth    |
| GET    | `/auth/google/callback` | Google OAuth callback    |
| POST   | `/auth/refresh`         | Refresh access token     |
| POST   | `/auth/logout`          | Invalidate refresh token |
| GET    | `/auth/me`              | Get current user         |

### User Data Model

[Source: architecture/4-data-models.md]

```typescript
// packages/shared/src/types/models.ts
export interface User {
  id: string;
  email: string;
  displayName: string | null;
  avatarUrl: string | null;
  provider: 'google' | 'apple';
  providerId: string;
  createdAt: Date;
  updatedAt: Date;
  lastLoginAt: Date;
}
```

### Database Schema - Users Table

[Source: architecture-backend/3-database-schema-drizzle.md]

```typescript
export const users = pgTable(
  'users',
  {
    id: uuid('id').primaryKey().defaultRandom(),
    email: varchar('email', { length: 255 }).notNull().unique(),
    displayName: varchar('display_name', { length: 255 }),
    avatarUrl: text('avatar_url'),
    provider: varchar('provider', { length: 20 }).notNull(), // 'google' | 'apple'
    providerId: varchar('provider_id', { length: 255 }).notNull(),
    createdAt: timestamp('created_at').defaultNow().notNull(),
    updatedAt: timestamp('updated_at').defaultNow().notNull(),
    lastLoginAt: timestamp('last_login_at').defaultNow().notNull(),
  },
  (table) => ({
    providerIdx: index('users_provider_idx').on(table.provider, table.providerId),
  })
);
```

### Database Schema - Refresh Tokens Table

[Source: architecture-backend/3-database-schema-drizzle.md]

```typescript
export const refreshTokens = pgTable(
  'refresh_tokens',
  {
    id: uuid('id').primaryKey().defaultRandom(),
    userId: uuid('user_id')
      .notNull()
      .references(() => users.id, { onDelete: 'cascade' }),
    tokenHash: varchar('token_hash', { length: 64 }).notNull(),
    expiresAt: timestamp('expires_at').notNull(),
    createdAt: timestamp('created_at').defaultNow().notNull(),
  },
  (table) => ({
    userIdx: index('refresh_tokens_user_idx').on(table.userId),
    tokenIdx: index('refresh_tokens_token_idx').on(table.tokenHash),
  })
);
```

### JWT Service Implementation

[Source: architecture-backend/9-external-services.md]

```typescript
// services/jwt/jwt.service.ts
import jwt from 'jsonwebtoken';
import { env } from '@/config/env';

export const jwtService = {
  generateAccessToken: (userId: string, email: string): string => {
    const payload = { sub: userId, email, type: 'access' };
    return jwt.sign(payload, env.JWT_ACCESS_SECRET, { expiresIn: '15m' });
  },

  generateRefreshToken: (userId: string): string => {
    const payload = { sub: userId, type: 'refresh' };
    return jwt.sign(payload, env.JWT_REFRESH_SECRET, { expiresIn: '7d' });
  },

  verifyAccessToken: (token: string) => {
    return jwt.verify(token, env.JWT_ACCESS_SECRET);
  },

  verifyRefreshToken: (token: string) => {
    return jwt.verify(token, env.JWT_REFRESH_SECRET);
  },
};
```

### Environment Variables Required

```bash
# Google OAuth
GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-client-secret

# JWT Secrets (min 32 chars each)
JWT_ACCESS_SECRET=your-access-secret-at-least-32-characters
JWT_REFRESH_SECRET=your-refresh-secret-at-least-32-characters

# Frontend
VITE_GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
VITE_API_URL=http://localhost:3001
```

### File Locations

[Source: architecture-frontend/2-project-structure.md, architecture-backend/2-project-structure.md]

**Backend:**

- `apps/api/src/routes/auth/auth.routes.ts` - Auth route handlers
- `apps/api/src/routes/auth/auth.service.ts` - Auth business logic
- `apps/api/src/routes/auth/types.ts` - Auth types
- `apps/api/src/services/jwt/jwt.service.ts` - JWT generation/validation
- `apps/api/src/repositories/user.repository.ts` - User data access
- `apps/api/src/middleware/auth.middleware.ts` - JWT verification middleware

**Frontend:**

- `apps/web/src/pages/LoginPage.tsx` - Login page
- `apps/web/src/components/auth/LoginButton.tsx` - OAuth button
- `apps/web/src/components/auth/AuthGuard.tsx` - Route protection
- `apps/web/src/hooks/useAuth/useAuth.ts` - Auth hook
- `apps/web/src/stores/authStore.ts` - Auth state
- `apps/web/src/services/api/authApi.ts` - Auth API calls

### Testing

[Source: architecture-frontend/11-testing-strategy.md, architecture-backend/11-testing-strategy.md]

**Coverage Targets:**

- Services (jwt.service, auth.service): 100%
- Repositories (user.repository): 95%
- Routes (auth.routes): 100%
- Hooks (useAuth): 100%

**Test Examples:**

```typescript
// apps/api/test/integration/auth.test.ts
import { describe, it, expect } from 'vitest';
import request from 'supertest';
import { createApp } from '@/app';

describe('Auth API', () => {
  const app = createApp();

  describe('GET /auth/google', () => {
    it('should redirect to Google OAuth', async () => {
      const response = await request(app).get('/v1/auth/google');

      expect(response.status).toBe(302);
      expect(response.headers.location).toContain('accounts.google.com');
    });
  });

  describe('GET /auth/me', () => {
    it('should return 401 without token', async () => {
      const response = await request(app).get('/v1/auth/me');
      expect(response.status).toBe(401);
    });
  });
});
```

### Coding Standards Reminders

[Source: architecture-frontend/12-coding-standards.md]

- No `useCallback`/`useMemo` unless proven needed
- Types in `types.ts` per folder
- Each hook in own folder with types.ts
- Services throw typed errors, routes don't catch

### Google OAuth Implementation Notes

1. **Authorization URL Construction:**

   ```
   https://accounts.google.com/o/oauth2/v2/auth?
     client_id={GOOGLE_CLIENT_ID}&
     redirect_uri={callback_url}&
     response_type=code&
     scope=openid email profile&
     state={csrf_token}
   ```

2. **Token Exchange:**
   - POST to `https://oauth2.googleapis.com/token`
   - Include: code, client_id, client_secret, redirect_uri, grant_type=authorization_code

3. **User Info:**
   - GET `https://www.googleapis.com/oauth2/v3/userinfo` with access token
   - Returns: sub (provider ID), email, name, picture

4. **Cookie Settings:**
   ```typescript
   res.cookie('accessToken', token, {
     httpOnly: true,
     secure: process.env.NODE_ENV === 'production',
     sameSite: 'lax',
     maxAge: 15 * 60 * 1000, // 15 minutes
   });
   ```

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation | PO     |
