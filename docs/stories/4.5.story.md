# Story 4.5: ICS Calendar Reminder Fallback

## Status

Approved

## Story

**As a** user on iOS Safari (limited notification support),  
**I want** to export a calendar reminder for my meter,  
**so that** I still get alerted before expiry.

## Acceptance Criteria

1. When timer is set on iOS Safari, offer "Add to Calendar" option
2. Generates and downloads an ICS file with reminder event
3. Event includes: title "Parking Meter Expires", time, location
4. Reminder set for 10 minutes before expiry
5. Works on any browser as alternative to notifications
6. ICS file opens in default calendar app for import

## Tasks / Subtasks

- [ ] **Task 1: Create ICS Generator Service** (AC: 2, 3, 4)
  - [ ] Create `apps/web/src/services/calendar/ics.service.ts`
  - [ ] Create `apps/web/src/services/calendar/types.ts`
  - [ ] `generateMeterReminderICS(spot, expiresAt)` method
  - [ ] Include VEVENT with VALARM (10 min before)
  - [ ] Include location (address or coordinates)
  - [ ] Write unit tests

- [ ] **Task 2: ICS File Download** (AC: 2, 6)
  - [ ] Create blob from ICS string
  - [ ] Trigger download with proper filename
  - [ ] Use `text/calendar` MIME type
  - [ ] Filename: `parking-reminder.ics`

- [ ] **Task 3: Create Add to Calendar Button** (AC: 1, 5)
  - [ ] Create `apps/web/src/components/calendar/AddToCalendarButton.tsx`
  - [ ] Show on iOS Safari when notifications denied/unsupported
  - [ ] Also available as option on any browser
  - [ ] Calendar icon with "Add to Calendar" label

- [ ] **Task 4: iOS Detection** (AC: 1)
  - [ ] Reuse `isIOS()` from Story 3.2
  - [ ] Check notification support
  - [ ] Show ICS option prominently on iOS Safari

- [ ] **Task 5: Integration with Timer Flow** (AC: 1, 5)
  - [ ] In NotificationPermissionPrompt denied handler
  - [ ] Show AddToCalendarButton
  - [ ] Also show in timer display as alternative
  - [ ] Offer both options where supported

- [ ] **Task 6: ICS Content Generation** (AC: 3, 4)
  - [ ] VCALENDAR wrapper
  - [ ] VEVENT with DTSTART, DTEND
  - [ ] SUMMARY: "Parking Meter Expires"
  - [ ] LOCATION: spot address or coordinates
  - [ ] DESCRIPTION: include spot details
  - [ ] VALARM: trigger -10 minutes

- [ ] **Task 7: Testing**
  - [ ] Test ICS file content validity
  - [ ] Test download triggers correctly
  - [ ] Test on iOS Safari
  - [ ] Test on desktop browsers
  - [ ] Validate ICS with online validator
  - [ ] Write unit tests for ICS generation

## Dev Notes

### Architecture References

- [architecture-frontend/9-external-services.md](../architecture-frontend/9-external-services.md)

### Dependencies

- Story 4.3 (MeterTimerInput)
- Story 4.4 (Notification service - fallback trigger)
- Story 3.2 (isIOS utility)

### ICS File Format

```
BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Where Did I Park//Meter Timer//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:parking-abc123@wheredidipark.app
DTSTAMP:20260115T100000Z
DTSTART:20260115T120000Z
DTEND:20260115T121500Z
SUMMARY:Parking Meter Expires
DESCRIPTION:Your parking meter at Near Central Park expires soon.
LOCATION:Near Central Park, New York
BEGIN:VALARM
ACTION:DISPLAY
DESCRIPTION:Parking meter expires in 10 minutes!
TRIGGER:-PT10M
END:VALARM
END:VEVENT
END:VCALENDAR
```

### ICS Generator Service

```typescript
// services/calendar/ics.service.ts
interface CalendarEvent {
  title: string;
  description: string;
  location: string;
  startTime: Date;
  endTime: Date;
  reminderMinutes: number;
}

export const icsService = {
  generateMeterReminder: (spot: Spot, expiresAt: Date): string => {
    const event: CalendarEvent = {
      title: 'Parking Meter Expires',
      description: `Your parking meter${spot.address ? ' at ' + spot.address : ''} expires soon.`,
      location: spot.address || `${spot.lat}, ${spot.lng}`,
      startTime: expiresAt,
      endTime: new Date(expiresAt.getTime() + 15 * 60 * 1000), // 15 min duration
      reminderMinutes: 10,
    };

    return icsService.generateICS(event);
  },

  generateICS: (event: CalendarEvent): string => {
    const uid = `parking-${Date.now()}@wheredidipark.app`;
    const dtstamp = formatICSDate(new Date());
    const dtstart = formatICSDate(event.startTime);
    const dtend = formatICSDate(event.endTime);

    return [
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      'PRODID:-//Where Did I Park//Meter Timer//EN',
      'CALSCALE:GREGORIAN',
      'METHOD:PUBLISH',
      'BEGIN:VEVENT',
      `UID:${uid}`,
      `DTSTAMP:${dtstamp}`,
      `DTSTART:${dtstart}`,
      `DTEND:${dtend}`,
      `SUMMARY:${escapeICS(event.title)}`,
      `DESCRIPTION:${escapeICS(event.description)}`,
      `LOCATION:${escapeICS(event.location)}`,
      'BEGIN:VALARM',
      'ACTION:DISPLAY',
      'DESCRIPTION:Parking meter expires in 10 minutes!',
      `TRIGGER:-PT${event.reminderMinutes}M`,
      'END:VALARM',
      'END:VEVENT',
      'END:VCALENDAR',
    ].join('\r\n');
  },

  downloadICS: (icsContent: string, filename = 'parking-reminder.ics'): void => {
    const blob = new Blob([icsContent], {
      type: 'text/calendar;charset=utf-8',
    });
    const url = URL.createObjectURL(blob);

    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    URL.revokeObjectURL(url);
  },
};

function formatICSDate(date: Date): string {
  return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
}

function escapeICS(text: string): string {
  return text
    .replace(/\\/g, '\\\\')
    .replace(/,/g, '\\,')
    .replace(/;/g, '\\;')
    .replace(/\n/g, '\\n');
}
```

### Add to Calendar Button

```tsx
// components/calendar/AddToCalendarButton.tsx
interface AddToCalendarButtonProps {
  spot: Spot;
  expiresAt: Date;
  variant?: 'primary' | 'secondary';
}

export function AddToCalendarButton({
  spot,
  expiresAt,
  variant = 'secondary',
}: AddToCalendarButtonProps) {
  const handleClick = () => {
    const icsContent = icsService.generateMeterReminder(spot, expiresAt);
    icsService.downloadICS(icsContent);
    toast.success('Calendar event downloaded!');
  };

  return (
    <Button onClick={handleClick} variant={variant}>
      <Calendar className="w-5 h-5 mr-2" />
      Add to Calendar
    </Button>
  );
}
```

### Integration in Timer Flow

```tsx
// In ConfirmationPage or MeterTimerInput
const handleNotificationDenied = () => {
  // Show ICS option
  setShowCalendarOption(true);
};

// In render
{
  showCalendarOption && spot.meterExpiresAt && (
    <div className="mt-4">
      <p className="text-sm text-gray-600 mb-2">Get a calendar reminder instead:</p>
      <AddToCalendarButton spot={spot} expiresAt={new Date(spot.meterExpiresAt)} />
    </div>
  );
}
```

### iOS Safari Detection

```tsx
// In NotificationPermissionPrompt or parent
const showIOSFallback = isIOS() && !notificationService.isSupported();

{
  showIOSFallback && (
    <div className="bg-yellow-50 p-4 rounded-lg">
      <p className="text-sm text-yellow-700 mb-2">
        iOS doesn't support browser notifications, but you can add a calendar reminder:
      </p>
      <AddToCalendarButton spot={spot} expiresAt={expiresAt} variant="primary" />
    </div>
  );
}
```

### File Locations

**New Files:**

- `apps/web/src/services/calendar/ics.service.ts`
- `apps/web/src/services/calendar/types.ts`
- `apps/web/src/components/calendar/AddToCalendarButton.tsx`

**Modified Files:**

- `apps/web/src/components/notification/NotificationPermissionPrompt.tsx` - add ICS fallback
- `apps/web/src/components/timer/MeterTimerDisplay.tsx` - optional calendar button
- `apps/web/src/pages/SpotDetailPage.tsx` - calendar option for timer

### ICS Validation

Use online validators to verify generated ICS:

- https://icalendar.org/validator.html
- Import test into Google Calendar, Apple Calendar, Outlook

### Testing Coverage

- ICS generation: 100%
- File download: 90%
- AddToCalendarButton: 95%
- Integration: 90%

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation | PO     |
