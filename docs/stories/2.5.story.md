# Story 2.5: Optional Note Field

## Status

Approved

## Story

**As a** user,  
**I want** to add a text note to my parking spot,  
**so that** I can record details like floor number or landmarks.

## Acceptance Criteria

1. Confirmation screen shows "Add Note" text input
2. Note field accepts free-form text (max 500 characters)
3. Note is saved with the spot record
4. Note displays on spot detail and history views
5. Note is optional - spot saves without it
6. Placeholder text suggests examples: "P2, near elevator", "Blue pillar", "Row G"

## Tasks / Subtasks

- [ ] **Task 1: Create Note Input Component** (AC: 1, 2, 6)
  - [ ] Create `apps/web/src/components/spot/NoteInput.tsx`
  - [ ] Expandable textarea (starts collapsed)
  - [ ] Max 500 character limit with counter
  - [ ] Placeholder examples text
  - [ ] Auto-focus when expanded
  - [ ] Mobile-friendly keyboard handling

- [ ] **Task 2: Backend - Update Spot Endpoint** (AC: 3)
  - [ ] Add `PATCH /v1/spots/:id` endpoint
  - [ ] Accept partial updates (note, photoUrl, carTag)
  - [ ] Validate note length (max 500)
  - [ ] Return updated spot
  - [ ] Write integration tests

- [ ] **Task 3: Update Spot Store** (AC: 3)
  - [ ] Add `updateSpot(id, data)` action
  - [ ] Implement optimistic update
  - [ ] Handle API errors with rollback
  - [ ] Support guest mode (IndexedDB update)

- [ ] **Task 4: Integrate into Confirmation Screen** (AC: 1, 5)
  - [ ] Add NoteInput to SpotActions section
  - [ ] Trigger from "Add Note" button
  - [ ] Save note immediately on blur/done
  - [ ] Show note preview when collapsed

- [ ] **Task 5: Display Note in Spot Detail** (AC: 4)
  - [ ] Update SpotDetailCard to show note
  - [ ] Truncate long notes with "more" link
  - [ ] Style note distinctly from address

- [ ] **Task 6: Display Note in History View** (AC: 4)
  - [ ] Show note preview in spot list items
  - [ ] Truncate to 1-2 lines
  - [ ] Help distinguish spots with similar locations

- [ ] **Task 7: Character Counter** (AC: 2)
  - [ ] Show "X/500" character count
  - [ ] Warn when near limit (>450)
  - [ ] Prevent input beyond 500

- [ ] **Task 8: Testing**
  - [ ] Test note save flow
  - [ ] Test character limit
  - [ ] Test note display in detail/history
  - [ ] Test guest mode note save
  - [ ] Write Playwright E2E tests

## Dev Notes

### Architecture References

- [architecture/5-api-specification.md](../architecture/5-api-specification.md) - Spot update endpoint

### Note Input Component

```tsx
// components/spot/NoteInput.tsx
import { useState } from 'react';

interface NoteInputProps {
  value: string;
  onChange: (note: string) => void;
  onSave: () => void;
}

const MAX_LENGTH = 500;
const PLACEHOLDER = 'P2, near elevator • Blue pillar • Row G';

export function NoteInput({ value, onChange, onSave }: NoteInputProps) {
  const [isExpanded, setIsExpanded] = useState(false);
  const remaining = MAX_LENGTH - value.length;
  const isNearLimit = remaining < 50;

  const handleChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    const newValue = e.target.value.slice(0, MAX_LENGTH);
    onChange(newValue);
  };

  const handleBlur = () => {
    if (value.trim()) {
      onSave();
    }
    setIsExpanded(false);
  };

  if (!isExpanded && !value) {
    return (
      <button onClick={() => setIsExpanded(true)} className="flex items-center gap-2 text-gray-500">
        <PencilIcon className="w-4 h-4" />
        Add Note
      </button>
    );
  }

  return (
    <div className="space-y-1">
      <textarea
        value={value}
        onChange={handleChange}
        onBlur={handleBlur}
        placeholder={PLACEHOLDER}
        autoFocus={isExpanded}
        rows={3}
        className="w-full p-3 border rounded-lg resize-none focus:ring-2 focus:ring-blue-500"
      />
      <div className={`text-xs text-right ${isNearLimit ? 'text-amber-500' : 'text-gray-400'}`}>
        {value.length}/{MAX_LENGTH}
      </div>
    </div>
  );
}
```

### PATCH Endpoint

```typescript
// routes/spots/spots.routes.ts
router.patch('/:id', authMiddleware, async (req, res) => {
  const { id } = req.params;
  const { note, photoUrl, carTag } = req.body;

  // Validate
  if (note && note.length > 500) {
    throw new ValidationError('Note must be 500 characters or less');
  }

  const spot = await spotRepository.update(id, {
    ...(note !== undefined && { note }),
    ...(photoUrl !== undefined && { photoUrl }),
    ...(carTag !== undefined && { carTag }),
  });

  res.json(spot);
});
```

### Spot Store Update

```typescript
// stores/spotStore.ts
updateSpot: async (id: string, data: Partial<Spot>) => {
  const { isGuest } = useGuestStore.getState();

  // Optimistic update
  set((state) => ({
    currentSpot:
      state.currentSpot?.id === id ? { ...state.currentSpot, ...data } : state.currentSpot,
  }));

  try {
    if (isGuest) {
      const spot = await indexedDbService.getItem<Spot>('spots', id);
      await indexedDbService.setItem('spots', id, { ...spot, ...data });
    } else {
      await fetch(`/api/v1/spots/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
    }
  } catch (error) {
    // Rollback on error
    // Refetch spot from source
    throw error;
  }
};
```

### Note Display in SpotDetailCard

```tsx
// components/spot/SpotDetailCard.tsx
{
  spot.note && (
    <div className="mt-3 p-2 bg-gray-50 rounded text-sm text-gray-700">
      <span className="font-medium">Note: </span>
      {spot.note}
    </div>
  );
}
```

### Note in History List

```tsx
// components/spot/SpotListItem.tsx
<div className="flex-1 min-w-0">
  <p className="font-medium truncate">{spot.address || 'Saved spot'}</p>
  {spot.note && <p className="text-sm text-gray-500 truncate">{spot.note}</p>}
  <p className="text-xs text-gray-400">{formatRelativeTime(spot.savedAt)}</p>
</div>
```

### File Locations

**New Files:**

- `apps/web/src/components/spot/NoteInput.tsx`

**Modified Files:**

- `apps/api/src/routes/spots/spots.routes.ts` - add PATCH
- `apps/web/src/stores/spotStore.ts` - add updateSpot
- `apps/web/src/components/spot/SpotDetailCard.tsx` - display note
- `apps/web/src/components/spot/SpotListItem.tsx` - display note

### Testing Coverage

- NoteInput: 95%
- PATCH endpoint: 100%
- updateSpot: 100%

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation | PO     |
