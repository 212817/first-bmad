# Story 5.4: Download My Data (Export)

## Status

Approved

## Story

**As a** user,  
**I want** to download all my parking data,  
**so that** I have a copy for my records.

## Acceptance Criteria

1. "Download my data" option in Settings
2. Generates a JSON file containing all user data: spots, tags, preferences
3. Includes photo URLs (or base64 images for offline access)
4. Download triggers immediately; no email required
5. Works for authenticated users; guest mode exports IndexedDB data
6. File is named with date: `where-did-i-park-export-2026-01-12.json`

## Tasks / Subtasks

- [ ] **Task 1: Backend - Export Data Endpoint** (AC: 1, 2, 3)
  - [ ] Create `GET /v1/users/me/export` endpoint
  - [ ] Gather all user spots with photos
  - [ ] Include car tags
  - [ ] Include user preferences
  - [ ] Return JSON response
  - [ ] Write integration tests

- [ ] **Task 2: Export Data Format** (AC: 2, 3)
  - [ ] Define export schema/type
  - [ ] Include metadata: exportDate, version
  - [ ] Include spots array with all fields
  - [ ] Include tags array
  - [ ] Include preferences

- [ ] **Task 3: Frontend Export Trigger** (AC: 1, 4)
  - [ ] Add "Download My Data" button in Settings
  - [ ] Show loading state during fetch
  - [ ] Trigger file download on success
  - [ ] Handle errors gracefully

- [ ] **Task 4: File Download Utility** (AC: 4, 6)
  - [ ] Create `apps/web/src/utils/download.ts`
  - [ ] `downloadJSON(data, filename)` function
  - [ ] Generate filename with date
  - [ ] Use blob and download link

- [ ] **Task 5: Guest Mode Export** (AC: 5)
  - [ ] Export all IndexedDB data locally
  - [ ] Same format as authenticated export
  - [ ] No API call needed
  - [ ] Write unit tests

- [ ] **Task 6: Progress Indicator** (AC: 4)
  - [ ] Show spinner during export
  - [ ] Large data sets may take time
  - [ ] Consider streaming for very large exports

- [ ] **Task 7: Testing**
  - [ ] Test export includes all data
  - [ ] Test file downloads correctly
  - [ ] Test filename format
  - [ ] Test guest mode export
  - [ ] Write Playwright E2E tests

## Dev Notes

### Architecture References

- [architecture/5-api-specification.md](../architecture/5-api-specification.md)
- [architecture/6-security-considerations.md](../architecture/6-security-considerations.md)

### Dependencies

- Story 5.1 (Settings page trigger)

### Export Data Format

```typescript
// types/export.ts
interface DataExport {
  meta: {
    exportDate: string; // ISO timestamp
    version: '1.0';
    userEmail: string | null; // null for guests
  };
  spots: Array<{
    id: string;
    lat: number;
    lng: number;
    address: string | null;
    note: string | null;
    photoUrl: string | null;
    carTag: string | null;
    meterExpiresAt: string | null;
    savedAt: string;
  }>;
  tags: Array<{
    id: string;
    name: string;
    isDefault: boolean;
  }>;
  preferences: {
    retentionDays: number | null;
  };
}
```

### API Endpoint

```bash
# Export user data
GET /api/v1/users/me/export
Authorization: Bearer <token>

# Response
{
  "meta": {
    "exportDate": "2026-01-15T10:00:00Z",
    "version": "1.0",
    "userEmail": "john@example.com"
  },
  "spots": [
    {
      "id": "uuid-1",
      "lat": 40.7128,
      "lng": -74.006,
      "address": "Near Central Park",
      "note": "Level P2",
      "photoUrl": "https://r2.example.com/photos/uuid.jpg",
      "carTag": "My Car",
      "meterExpiresAt": null,
      "savedAt": "2026-01-15T10:00:00Z"
    }
  ],
  "tags": [
    { "id": "uuid-t1", "name": "My Car", "isDefault": true },
    { "id": "uuid-t2", "name": "Work Car", "isDefault": false }
  ],
  "preferences": {
    "retentionDays": 30
  }
}
```

### Backend Export Handler

```typescript
// routes/users/users.routes.ts
router.get('/me/export', authMiddleware, async (req, res) => {
  const userId = req.user.id;

  const [user, spots, tags] = await Promise.all([
    userRepository.findById(userId),
    spotRepository.findAllByUserId(userId), // No pagination, all spots
    carTagRepository.findByUserId(userId),
  ]);

  const exportData: DataExport = {
    meta: {
      exportDate: new Date().toISOString(),
      version: '1.0',
      userEmail: user?.email || null,
    },
    spots: spots.map((spot) => ({
      id: spot.id,
      lat: spot.lat,
      lng: spot.lng,
      address: spot.address,
      note: spot.note,
      photoUrl: spot.photoUrl,
      carTag: spot.carTag,
      meterExpiresAt: spot.meterExpiresAt?.toISOString() || null,
      savedAt: spot.savedAt.toISOString(),
    })),
    tags: tags.map((tag) => ({
      id: tag.id,
      name: tag.name,
      isDefault: tag.isDefault,
    })),
    preferences: {
      retentionDays: user?.retentionDays ?? 30,
    },
  };

  res.json(exportData);
});
```

### Download Utility

```typescript
// utils/download.ts
export function downloadJSON(data: object, filename: string): void {
  const jsonString = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonString], { type: 'application/json' });
  const url = URL.createObjectURL(blob);

  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  URL.revokeObjectURL(url);
}

export function generateExportFilename(): string {
  const date = new Date().toISOString().split('T')[0]; // 2026-01-15
  return `where-did-i-park-export-${date}.json`;
}
```

### Settings Export Button

```tsx
// In SettingsPage.tsx
const [isExporting, setIsExporting] = useState(false);

const handleExport = async () => {
  setIsExporting(true);

  try {
    let exportData: DataExport;

    if (isGuest) {
      exportData = await exportGuestData();
    } else {
      const response = await apiClient.get('/v1/users/me/export');
      exportData = response.data;
    }

    downloadJSON(exportData, generateExportFilename());
    toast.success('Data exported successfully!');
  } catch (error) {
    toast.error('Failed to export data');
  } finally {
    setIsExporting(false);
  }
};

// In render
<SettingsButton
  onClick={handleExport}
  icon={Download}
  label={isExporting ? 'Exporting...' : 'Download My Data'}
  disabled={isExporting}
/>;
```

### Guest Mode Export

```typescript
// services/export.service.ts
export async function exportGuestData(): Promise<DataExport> {
  const spots = await IndexedDBService.getAllSpots();
  const tags = await IndexedDBService.getAllTags();
  const retentionDays = getGuestRetentionDays();

  return {
    meta: {
      exportDate: new Date().toISOString(),
      version: '1.0',
      userEmail: null,
    },
    spots: spots.map((spot) => ({
      ...spot,
      savedAt: spot.savedAt.toISOString(),
      meterExpiresAt: spot.meterExpiresAt?.toISOString() || null,
    })),
    tags,
    preferences: {
      retentionDays,
    },
  };
}
```

### File Locations

**New Files:**

- `apps/web/src/utils/download.ts`
- `apps/web/src/services/export.service.ts`
- `apps/web/src/types/export.ts`

**Modified Files:**

- `apps/api/src/routes/users/users.routes.ts` - add export endpoint
- `apps/api/src/repositories/spot.repository.ts` - add findAllByUserId
- `apps/web/src/pages/SettingsPage.tsx` - add export button handler

### Testing Coverage

- Export endpoint: 100%
- Download utility: 95%
- Guest export: 95%

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation | PO     |
