# Story 3.3: Spot History List

## Status

Approved

## Story

**As a** user,  
**I want** to view all my saved parking spots,  
**so that** I can find a previous location or review my parking history.

## Acceptance Criteria

1. History screen accessible from navigation/menu
2. Displays list of spots in reverse chronological order (newest first)
3. Each list item shows: address/coordinates, timestamp, car tag, photo thumbnail
4. Tapping a spot opens spot detail screen
5. List is scrollable with smooth performance (virtualization if needed)
6. For authenticated users, fetches from database with pagination
7. For guests, fetches from IndexedDB
8. Empty state shown if no spots exist

## Tasks / Subtasks

- [ ] **Task 0: Install Dependencies** (prerequisite)
  - [ ] `npm install react-window react-window-infinite-loader`
  - [ ] `npm install -D @types/react-window @types/react-window-infinite-loader`

- [ ] **Task 1: Create History Page** (AC: 1)
  - [ ] Create `apps/web/src/pages/HistoryPage.tsx`
  - [ ] Add route `/history` to router
  - [ ] Add to navigation menu/bottom nav
  - [ ] Page title "Spot History"

- [ ] **Task 2: Backend - Get Spots Endpoint with Pagination** (AC: 6)
  - [ ] Update `GET /v1/spots` endpoint
  - [ ] Add query params: `limit` (default 20), `cursor` (for pagination)
  - [ ] Return `{ spots: [], nextCursor: string | null }`
  - [ ] Order by `savedAt DESC`
  - [ ] Write integration tests

- [ ] **Task 3: Update Spot Repository for Pagination** (AC: 6)
  - [ ] Update `findByUserId(userId, limit, cursor)`
  - [ ] Implement cursor-based pagination
  - [ ] Use `savedAt` as cursor field
  - [ ] Write unit tests

- [ ] **Task 4: Create Spot List Item Component** (AC: 3, 4)
  - [ ] Create `apps/web/src/components/spot/SpotListItem.tsx`
  - [ ] Display address or coordinates
  - [ ] Display relative timestamp
  - [ ] Display car tag badge
  - [ ] Display photo thumbnail (small)
  - [ ] **Display note preview if exists (deferred from Story 2.5 Task 6)**
  - [ ] Make entire item tappable
  - [ ] Navigate to detail on tap

- [ ] **Task 5: Create Spot List Component** (AC: 2, 5)
  - [ ] Create `apps/web/src/components/spot/SpotList.tsx`
  - [ ] Render list of SpotListItem components
  - [ ] Implement virtualization for long lists (react-window or similar)
  - [ ] Support infinite scroll / load more
  - [ ] Show loading state

- [ ] **Task 6: Update Spot Store for History** (AC: 6, 7)
  - [ ] Add `spots: Spot[]` state
  - [ ] Add `hasMore: boolean` state
  - [ ] Add `nextCursor: string | null` state
  - [ ] Implement `fetchSpots(cursor?)` action
  - [ ] Implement `loadMore()` action
  - [ ] Route to correct storage (API vs IndexedDB)
  - [ ] Write unit tests

- [ ] **Task 7: Guest Mode History** (AC: 7)
  - [ ] Update IndexedDB service `getSpots(limit, offset)`
  - [ ] Sort by savedAt descending
  - [ ] Support pagination via offset
  - [ ] Write unit tests

- [ ] **Task 8: Empty State** (AC: 8)
  - [ ] Reuse `EmptySpotState` from Story 3.1
  - [ ] Or create history-specific variant
  - [ ] Message: "No parking spots saved yet"

- [ ] **Task 9: Navigation Menu Integration** (AC: 1)
  - [ ] Add "History" to bottom navigation or sidebar
  - [ ] Use clock/history icon
  - [ ] Highlight active route

- [ ] **Task 10: Infinite Scroll Implementation** (AC: 5, 6)
  - [ ] Detect scroll near bottom
  - [ ] Trigger `loadMore()` when near end
  - [ ] Show loading indicator at bottom
  - [ ] Stop when `hasMore === false`

- [ ] **Task 11: Testing**
  - [ ] Test list renders correctly
  - [ ] Test pagination loads more
  - [ ] Test tap navigates to detail
  - [ ] Test empty state
  - [ ] Test guest mode
  - [ ] Write Playwright E2E tests

## Dev Notes

### Architecture References

- [architecture-frontend/6-component-hierarchy.md](../architecture-frontend/6-component-hierarchy.md)
- [architecture/5-api-specification.md](../architecture/5-api-specification.md)

### Dependencies

- Story 2.1 (spots database and schema)
- Story 3.1 (EmptySpotState component)
- Story 3.4 (SpotDetailPage - navigation target) â€” **Note:** 3.3 and 3.4 can be developed in parallel; define route `/spot/:spotId` first

### API Endpoint

```bash
# Get spots with pagination
GET /api/v1/spots?limit=20&cursor=2026-01-15T10:00:00Z
Authorization: Bearer <token>

# Response
{
  "spots": [
    {
      "id": "uuid-1",
      "lat": 40.7128,
      "lng": -74.006,
      "address": "Near Central Park",
      "photoUrl": "https://...",
      "carTag": "My Car",
      "savedAt": "2026-01-15T10:00:00Z"
    },
    // ... more spots
  ],
  "nextCursor": "2026-01-10T08:30:00Z"  // null when no more
}
```

### Cursor-Based Pagination

```typescript
// repositories/spot.repository.ts
findByUserId: async (userId: string, limit = 20, cursor?: string) => {
  const query = db
    .select()
    .from(spots)
    .where(eq(spots.userId, userId))
    .orderBy(desc(spots.savedAt))
    .limit(limit + 1); // Fetch one extra to check hasMore

  if (cursor) {
    query.where(lt(spots.savedAt, new Date(cursor)));
  }

  const results = await query;

  const hasMore = results.length > limit;
  const items = hasMore ? results.slice(0, -1) : results;
  const nextCursor = hasMore ? items[items.length - 1].savedAt : null;

  return { spots: items, nextCursor };
};
```

### SpotListItem Component

```tsx
// components/spot/SpotListItem.tsx
interface SpotListItemProps {
  spot: Spot;
  onClick: () => void;
}

export function SpotListItem({ spot, onClick }: SpotListItemProps) {
  return (
    <button
      onClick={onClick}
      className="w-full flex items-center gap-3 p-3 hover:bg-gray-50 border-b"
    >
      {spot.photoUrl ? (
        <SpotThumbnail url={spot.photoUrl} className="w-12 h-12 rounded" />
      ) : (
        <div className="w-12 h-12 bg-gray-100 rounded flex items-center justify-center">
          <MapPin className="w-6 h-6 text-gray-400" />
        </div>
      )}

      <div className="flex-1 text-left min-w-0">
        <p className="font-medium truncate">{spot.address || formatCoords(spot.lat, spot.lng)}</p>
        {spot.note && <p className="text-sm text-gray-500 truncate">{spot.note}</p>}
        <p className="text-xs text-gray-400">{formatRelativeTime(spot.savedAt)}</p>
      </div>

      <TagBadge name={spot.carTag || 'My Car'} size="sm" />

      <ChevronRight className="w-5 h-5 text-gray-400" />
    </button>
  );
}
```

### Virtualized List (for performance)

```tsx
// components/spot/SpotList.tsx
import { FixedSizeList as List } from 'react-window';
import InfiniteLoader from 'react-window-infinite-loader';

interface SpotListProps {
  spots: Spot[];
  hasMore: boolean;
  loadMore: () => void;
  onSpotClick: (spot: Spot) => void;
}

export function SpotList({ spots, hasMore, loadMore, onSpotClick }: SpotListProps) {
  const itemCount = hasMore ? spots.length + 1 : spots.length;

  const isItemLoaded = (index: number) => !hasMore || index < spots.length;

  const Row = ({ index, style }: { index: number; style: React.CSSProperties }) => {
    if (!isItemLoaded(index)) {
      return (
        <div style={style} className="flex items-center justify-center p-4">
          <Spinner />
        </div>
      );
    }

    return (
      <div style={style}>
        <SpotListItem spot={spots[index]} onClick={() => onSpotClick(spots[index])} />
      </div>
    );
  };

  return (
    <InfiniteLoader isItemLoaded={isItemLoaded} itemCount={itemCount} loadMoreItems={loadMore}>
      {({ onItemsRendered, ref }) => (
        <List
          height={window.innerHeight - 120}
          itemCount={itemCount}
          itemSize={80}
          onItemsRendered={onItemsRendered}
          ref={ref}
          width="100%"
        >
          {Row}
        </List>
      )}
    </InfiniteLoader>
  );
}
```

### History Page

```tsx
// pages/HistoryPage.tsx
export function HistoryPage() {
  const navigate = useNavigate();
  const { spots, hasMore, isLoading, fetchSpots, loadMore } = useSpotStore();

  useEffect(() => {
    fetchSpots();
  }, []);

  const handleSpotClick = (spot: Spot) => {
    navigate(`/spot/${spot.id}`);
  };

  if (isLoading && spots.length === 0) {
    return <LoadingScreen />;
  }

  if (spots.length === 0) {
    return <EmptySpotState />;
  }

  return (
    <div className="min-h-screen">
      <header className="sticky top-0 bg-white border-b p-4">
        <h1 className="text-xl font-bold">Spot History</h1>
      </header>

      <SpotList spots={spots} hasMore={hasMore} loadMore={loadMore} onSpotClick={handleSpotClick} />
    </div>
  );
}
```

### File Locations

**New Files:**

- `apps/web/src/pages/HistoryPage.tsx`
- `apps/web/src/components/spot/SpotList.tsx`
- `apps/web/src/components/spot/SpotListItem.tsx`

**Modified Files:**

- `apps/api/src/routes/spots/spots.routes.ts` - add pagination
- `apps/api/src/repositories/spot.repository.ts` - cursor pagination
- `apps/web/src/stores/spotStore.ts` - add history state
- `apps/web/src/router.tsx` - add /history route
- `apps/web/src/components/navigation/BottomNav.tsx` - add History tab

### Dependencies (npm)

```json
{
  "react-window": "^1.8.10",
  "react-window-infinite-loader": "^1.0.9"
}
```

### Testing Coverage

- HistoryPage: 90%
- SpotList: 95%
- SpotListItem: 95%
- Pagination: 100%

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation | PO     |
