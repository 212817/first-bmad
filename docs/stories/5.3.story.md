# Story 5.3: Data Retention Preferences

## Status

Approved

## Story

**As a** user,  
**I want** to control how long my parking data is retained,  
**so that** I can manage my privacy.

## Acceptance Criteria

1. Settings screen shows retention preference (default: 30 days)
2. Options: 7 days, 30 days, 90 days, 1 year, Never auto-delete
3. Changing preference saves to user profile
4. Backend cleanup job respects user preference
5. Spots older than retention period are automatically deleted (with photos)
6. Guest mode: retention enforced locally via app

## Tasks / Subtasks

- [ ] **Task 1: Update User Schema** (AC: 1, 3)
  - [ ] Add `retentionDays` column (integer, nullable, default 30)
  - [ ] `null` or `-1` means "Never auto-delete"
  - [ ] Run migration
  - [ ] Update User type definition

- [ ] **Task 2: Backend - Update User Preferences Endpoint** (AC: 3)
  - [ ] Create/update `PATCH /v1/users/me/preferences` endpoint
  - [ ] Accept `retentionDays` (7, 30, 90, 365, null)
  - [ ] Validate allowed values
  - [ ] Write integration tests

- [ ] **Task 3: Create Retention Settings Page** (AC: 1, 2)
  - [ ] Create `apps/web/src/pages/RetentionSettingsPage.tsx`
  - [ ] Add route `/settings/retention` to router
  - [ ] Display current preference
  - [ ] Radio buttons for options

- [ ] **Task 4: Retention Options Component** (AC: 2)
  - [ ] Create `apps/web/src/components/settings/RetentionOptions.tsx`
  - [ ] Options: 7 days, 30 days, 90 days, 1 year, Never
  - [ ] Show description for each option
  - [ ] Highlight current selection

- [ ] **Task 5: Save Retention Preference** (AC: 3)
  - [ ] Call API on selection change
  - [ ] Show success toast
  - [ ] Update local user state
  - [ ] Handle errors

- [ ] **Task 6: Guest Mode Retention** (AC: 6)
  - [ ] Store preference in localStorage
  - [ ] Default to 30 days for guests
  - [ ] Enforce locally in IndexedDB cleanup
  - [ ] Write unit tests

- [ ] **Task 7: Retention Info Text** (AC: 5)
  - [ ] Display explanation of what gets deleted
  - [ ] "Spots older than X days will be automatically deleted"
  - [ ] "Photos are also deleted when spots are removed"

- [ ] **Task 8: Testing**
  - [ ] Test preference saves correctly
  - [ ] Test UI reflects current preference
  - [ ] Test guest mode stores locally
  - [ ] Write Playwright E2E tests

## Dev Notes

### Architecture References

- [architecture/5-api-specification.md](../architecture/5-api-specification.md)
- [architecture/6-security-considerations.md](../architecture/6-security-considerations.md)

### Dependencies

- Story 5.1 (Settings page)
- Story 5.8 (Retention cleanup job)

### Database Migration

```typescript
// migrations/add_retention_days.ts
export async function up(db: Database) {
  await db.schema
    .alterTable('users')
    .addColumn('retention_days', 'integer', (col) => col.nullable().defaultTo(30));
}
```

### API Endpoint

```bash
# Update user preferences
PATCH /api/v1/users/me/preferences
Authorization: Bearer <token>
Content-Type: application/json

{
  "retentionDays": 90
}

# Set to never delete
{
  "retentionDays": null
}

# Response
{
  "retentionDays": 90
}
```

### Retention Settings Page

```tsx
// pages/RetentionSettingsPage.tsx
const RETENTION_OPTIONS = [
  { value: 7, label: '7 days', description: 'Delete spots after 1 week' },
  {
    value: 30,
    label: '30 days',
    description: 'Delete spots after 1 month (default)',
  },
  { value: 90, label: '90 days', description: 'Delete spots after 3 months' },
  { value: 365, label: '1 year', description: 'Delete spots after 1 year' },
  {
    value: null,
    label: 'Never',
    description: 'Keep spots until you delete them',
  },
];

export function RetentionSettingsPage() {
  const { user, updatePreferences } = useAuthStore();
  const [selected, setSelected] = useState(user?.retentionDays ?? 30);
  const [isSaving, setIsSaving] = useState(false);

  const handleChange = async (value: number | null) => {
    setSelected(value);
    setIsSaving(true);

    try {
      await updatePreferences({ retentionDays: value });
      toast.success('Preference saved');
    } catch {
      toast.error('Failed to save preference');
    } finally {
      setIsSaving(false);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      <header className="bg-white p-4 border-b flex items-center">
        <BackButton />
        <h1 className="text-xl font-bold ml-2">Data Retention</h1>
      </header>

      <div className="p-4 space-y-4">
        <p className="text-sm text-gray-600">
          Choose how long to keep your parking history. Older spots and their photos will be
          automatically deleted.
        </p>

        <div className="bg-white rounded-lg divide-y">
          {RETENTION_OPTIONS.map((option) => (
            <label
              key={String(option.value)}
              className="flex items-start gap-3 p-4 cursor-pointer hover:bg-gray-50"
            >
              <input
                type="radio"
                name="retention"
                checked={selected === option.value}
                onChange={() => handleChange(option.value)}
                className="mt-1"
                disabled={isSaving}
              />
              <div>
                <p className="font-medium">{option.label}</p>
                <p className="text-sm text-gray-500">{option.description}</p>
              </div>
            </label>
          ))}
        </div>

        <div className="bg-yellow-50 p-4 rounded-lg">
          <p className="text-sm text-yellow-700">
            <Info className="w-4 h-4 inline mr-1" />
            When spots are deleted, their associated photos are also removed permanently.
          </p>
        </div>
      </div>
    </div>
  );
}
```

### Guest Mode Implementation

```typescript
// For guests, store in localStorage
const GUEST_RETENTION_KEY = 'guestRetentionDays';

export function getGuestRetentionDays(): number | null {
  const stored = localStorage.getItem(GUEST_RETENTION_KEY);
  if (stored === 'null') return null;
  return stored ? parseInt(stored, 10) : 30; // Default 30 days
}

export function setGuestRetentionDays(days: number | null): void {
  localStorage.setItem(GUEST_RETENTION_KEY, String(days));
}

// Call local cleanup on app load for guests
export async function cleanupExpiredGuestSpots(): Promise<void> {
  const retentionDays = getGuestRetentionDays();
  if (retentionDays === null) return; // Never delete

  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - retentionDays);

  await IndexedDBService.deleteSpotsBefore(cutoff);
}
```

### File Locations

**New Files:**

- `apps/web/src/pages/RetentionSettingsPage.tsx`
- `apps/web/src/components/settings/RetentionOptions.tsx`
- `apps/api/src/migrations/add_retention_days.ts`

**Modified Files:**

- `apps/api/src/schema/users.ts` - add retentionDays column
- `apps/api/src/routes/users/users.routes.ts` - add preferences endpoint
- `apps/web/src/stores/authStore.ts` - add updatePreferences action
- `apps/web/src/router.tsx` - add /settings/retention route

### Testing Coverage

- RetentionSettingsPage: 90%
- Preferences endpoint: 100%
- Guest retention: 95%

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation | PO     |
