# Story 3.5: Delete Individual Spot

## Status

Approved

## Story

**As a** user,  
**I want** to delete a saved parking spot,  
**so that** I can remove outdated or unwanted locations from my history.

## Acceptance Criteria

1. Delete button visible on spot detail screen
2. Tapping delete shows confirmation dialog
3. Confirmation dialog has "Cancel" and "Delete" buttons
4. Cancel returns to detail screen without deleting
5. Confirm deletes spot and returns to history list
6. Associated photo is deleted from storage (R2 for auth, IndexedDB for guest)
7. Success toast shown after deletion
8. If viewing last spot, return to empty state
9. For authenticated users, deletes from database
10. For guests, deletes from IndexedDB

## Tasks / Subtasks

- [ ] **Task 1: Create Delete Confirmation Dialog** (AC: 2, 3, 4)
  - [ ] Create `apps/web/src/components/spot/DeleteConfirmDialog.tsx`
  - [ ] Use accessible dialog pattern
  - [ ] Include spot address in message
  - [ ] Cancel and Delete buttons
  - [ ] Delete button should be red/destructive style

- [ ] **Task 2: Backend - Delete Spot Endpoint** (AC: 9)
  - [ ] Create `DELETE /v1/spots/:spotId` endpoint
  - [ ] Validate user owns spot
  - [ ] Return 204 No Content on success
  - [ ] Return 404 if not found
  - [ ] Write integration tests

- [ ] **Task 3: R2 Photo Cleanup** (AC: 6)
  - [ ] In delete handler, get spot photoUrl first
  - [ ] Extract photo key from URL
  - [ ] Call R2 delete object
  - [ ] Handle missing photo gracefully
  - [ ] Log but don't fail if R2 delete fails

- [ ] **Task 4: Spot Repository - Delete Method** (AC: 9)
  - [ ] Add `deleteById(spotId, userId)` method
  - [ ] Return deleted spot (for photo cleanup)
  - [ ] Validate ownership in query
  - [ ] Write unit tests

- [ ] **Task 5: Update Spot Store** (AC: 5, 7, 8)
  - [ ] Add `deleteSpot(spotId)` action
  - [ ] Remove from local spots array
  - [ ] Update latestSpot if deleted
  - [ ] Show success toast
  - [ ] Handle navigation after delete

- [ ] **Task 6: Guest Mode Delete** (AC: 6, 10)
  - [ ] Delete from IndexedDB
  - [ ] Delete photo blob from IndexedDB
  - [ ] Write unit tests

- [ ] **Task 7: Wire Up Delete Flow** (AC: 1-5)
  - [ ] Import dialog in SpotDetailPage
  - [ ] State for dialog open/close
  - [ ] Handle confirm action
  - [ ] Navigate after success

- [ ] **Task 8: Testing**
  - [ ] Test dialog shows on delete click
  - [ ] Test cancel closes dialog
  - [ ] Test confirm deletes spot
  - [ ] Test navigates to history after
  - [ ] Test photo deleted from R2
  - [ ] Test guest mode deletion
  - [ ] Write Playwright E2E tests

## Dev Notes

### Architecture References

- [architecture/5-api-specification.md](../architecture/5-api-specification.md)
- [architecture/9-testing-strategy.md](../architecture/9-testing-strategy.md)

### Dependencies

- Story 2.1 (spots table)
- Story 2.3 (R2 photo storage)
- Story 3.4 (SpotDetailPage)

### API Endpoint

```bash
# Delete spot
DELETE /api/v1/spots/:spotId
Authorization: Bearer <token>

# Success Response
HTTP 204 No Content

# Error Response (not found or not owned)
HTTP 404
{
  "error": "Spot not found"
}
```

### Delete Confirmation Dialog

```tsx
// components/spot/DeleteConfirmDialog.tsx
import * as AlertDialog from '@radix-ui/react-alert-dialog';

interface DeleteConfirmDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  spotAddress?: string;
  onConfirm: () => void;
  isDeleting?: boolean;
}

export function DeleteConfirmDialog({
  open,
  onOpenChange,
  spotAddress,
  onConfirm,
  isDeleting,
}: DeleteConfirmDialogProps) {
  return (
    <AlertDialog.Root open={open} onOpenChange={onOpenChange}>
      <AlertDialog.Portal>
        <AlertDialog.Overlay className="fixed inset-0 bg-black/50" />
        <AlertDialog.Content className="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-6 w-[90%] max-w-md">
          <AlertDialog.Title className="text-lg font-semibold">
            Delete Parking Spot?
          </AlertDialog.Title>
          <AlertDialog.Description className="mt-2 text-gray-600">
            This will permanently delete your saved spot
            {spotAddress && <span className="font-medium"> at {spotAddress}</span>}. This action
            cannot be undone.
          </AlertDialog.Description>

          <div className="flex gap-3 mt-6 justify-end">
            <AlertDialog.Cancel asChild>
              <Button variant="secondary" disabled={isDeleting}>
                Cancel
              </Button>
            </AlertDialog.Cancel>
            <AlertDialog.Action asChild>
              <Button variant="destructive" onClick={onConfirm} disabled={isDeleting}>
                {isDeleting ? 'Deleting...' : 'Delete'}
              </Button>
            </AlertDialog.Action>
          </div>
        </AlertDialog.Content>
      </AlertDialog.Portal>
    </AlertDialog.Root>
  );
}
```

### Backend Delete Handler

```typescript
// routes/spots/spots.routes.ts
router.delete('/:spotId', authMiddleware, async (req, res) => {
  const { spotId } = req.params;
  const userId = req.user.id;

  // Get spot first (for photo cleanup)
  const spot = await spotRepository.findById(spotId, userId);

  if (!spot) {
    return res.status(404).json({ error: 'Spot not found' });
  }

  // Delete spot from database
  await spotRepository.deleteById(spotId, userId);

  // Cleanup photo from R2 (fire and forget)
  if (spot.photoUrl) {
    try {
      const key = extractPhotoKey(spot.photoUrl);
      await r2Client.deleteObject({ Bucket: R2_BUCKET, Key: key });
    } catch (error) {
      // Log but don't fail the request
      console.error('Failed to delete photo from R2:', error);
    }
  }

  return res.status(204).send();
});
```

### Spot Repository Delete Method

```typescript
// repositories/spot.repository.ts
deleteById: async (spotId: string, userId: string): Promise<void> => {
  await db.delete(spots).where(and(eq(spots.id, spotId), eq(spots.userId, userId)));
};

findById: async (spotId: string, userId: string): Promise<Spot | null> => {
  const [spot] = await db
    .select()
    .from(spots)
    .where(and(eq(spots.id, spotId), eq(spots.userId, userId)))
    .limit(1);

  return spot || null;
};
```

### Spot Store Delete Action

```typescript
// stores/spotStore.ts - add to existing
deleteSpot: async (spotId: string) => {
  const { user } = useAuthStore.getState();

  try {
    if (user) {
      await apiClient.delete(`/v1/spots/${spotId}`);
    } else {
      await IndexedDBService.deleteSpot(spotId);
    }

    // Remove from local state
    set((state) => {
      const newSpots = state.spots.filter((s) => s.id !== spotId);
      const newLatest = state.latestSpot?.id === spotId ? newSpots[0] || null : state.latestSpot;

      return {
        spots: newSpots,
        latestSpot: newLatest,
      };
    });

    toast.success('Spot deleted');
    return true;
  } catch (error) {
    toast.error('Failed to delete spot');
    return false;
  }
};
```

### Usage in SpotDetailPage

```tsx
// In SpotDetailPage.tsx
const [deleteOpen, setDeleteOpen] = useState(false);
const [isDeleting, setIsDeleting] = useState(false);
const { deleteSpot } = useSpotStore();

const handleDelete = async () => {
  setIsDeleting(true);
  const success = await deleteSpot(spot.id);
  setIsDeleting(false);

  if (success) {
    setDeleteOpen(false);
    navigate('/history');
  }
};

// In JSX
<DeleteConfirmDialog
  open={deleteOpen}
  onOpenChange={setDeleteOpen}
  spotAddress={spot.address}
  onConfirm={handleDelete}
  isDeleting={isDeleting}
/>;
```

### IndexedDB Delete

```typescript
// services/indexeddb.service.ts
export const IndexedDBService = {
  deleteSpot: async (spotId: string): Promise<void> => {
    const db = await openDB('parking-spots', 1);

    // Get spot to find photo key
    const spot = await db.get('spots', spotId);

    // Delete spot
    await db.delete('spots', spotId);

    // Delete photo if exists
    if (spot?.photoKey) {
      await db.delete('photos', spot.photoKey);
    }
  },
};
```

### File Locations

**New Files:**

- `apps/web/src/components/spot/DeleteConfirmDialog.tsx`

**Modified Files:**

- `apps/api/src/routes/spots/spots.routes.ts` - add DELETE endpoint
- `apps/api/src/repositories/spot.repository.ts` - add delete methods
- `apps/web/src/stores/spotStore.ts` - add deleteSpot action
- `apps/web/src/pages/SpotDetailPage.tsx` - wire up delete
- `apps/web/src/services/indexeddb.service.ts` - add deleteSpot

### Testing Coverage

- DeleteConfirmDialog: 95%
- DELETE endpoint: 100%
- R2 cleanup: 90%
- Spot store delete: 95%

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation | PO     |
