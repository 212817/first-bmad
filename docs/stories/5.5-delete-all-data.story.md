# Story 5.5: Delete All My Data

## Status

Approved

## Story

**As a** user,  
**I want** to delete all my parking data,  
**so that** I can remove my information from the service.

## Acceptance Criteria

1. "Delete all my data" option in Settings
2. Confirmation dialog with clear warning
3. Deletes all spots, photos, and user record from database
4. Deletes all photos from Cloudflare R2
5. Signs user out after deletion
6. For guests, clears IndexedDB storage
7. Action is irreversible; dialog makes this clear

## Tasks / Subtasks

- [ ] **Task 1: Backend - Delete User Data Endpoint** (AC: 3, 4)
  - [ ] Create `DELETE /v1/users/me/data` endpoint
  - [ ] Delete all user's spots from database
  - [ ] Delete all user's photos from R2
  - [ ] Keep user account (for login)
  - [ ] Write integration tests

- [ ] **Task 2: R2 Batch Photo Deletion** (AC: 4)
  - [ ] Get all photo keys for user
  - [ ] Batch delete from R2 (up to 1000 at once)
  - [ ] Handle partial failures gracefully
  - [ ] Log deletion activity

- [ ] **Task 3: Create Delete Data Confirmation Page** (AC: 1, 2, 7)
  - [ ] Create `apps/web/src/pages/DeleteDataPage.tsx`
  - [ ] Add route `/settings/delete-data` to router
  - [ ] Show warning message
  - [ ] Require explicit confirmation

- [ ] **Task 4: Confirmation Dialog** (AC: 2, 7)
  - [ ] Create `apps/web/src/components/settings/DeleteDataConfirmation.tsx`
  - [ ] Red warning styling
  - [ ] "This action cannot be undone"
  - [ ] Require typing "DELETE" to confirm
  - [ ] Cancel and Delete buttons

- [ ] **Task 5: Execute Deletion** (AC: 3, 4, 5)
  - [ ] Call DELETE endpoint
  - [ ] Show loading state
  - [ ] Sign out user after success
  - [ ] Redirect to home/login
  - [ ] Handle errors

- [ ] **Task 6: Guest Mode Deletion** (AC: 6)
  - [ ] Clear all IndexedDB data
  - [ ] Clear localStorage preferences
  - [ ] Show success message
  - [ ] Reset app state

- [ ] **Task 7: Testing**
  - [ ] Test confirmation required
  - [ ] Test data actually deleted
  - [ ] Test photos deleted from R2
  - [ ] Test user signed out after
  - [ ] Test guest mode clears IndexedDB
  - [ ] Write Playwright E2E tests

## Dev Notes

### Architecture References

- [architecture/5-api-specification.md](../architecture/5-api-specification.md)
- [architecture/6-security-considerations.md](../architecture/6-security-considerations.md)

### Dependencies

- Story 5.1 (Settings page)
- Story 1.5 (Sign out functionality)

### API Endpoint

```bash
# Delete all user data (keeps account)
DELETE /api/v1/users/me/data
Authorization: Bearer <token>

# Response
HTTP 204 No Content

# On error
HTTP 500
{
  "error": "Failed to delete all data. Please try again."
}
```

### Backend Delete Handler

```typescript
// routes/users/users.routes.ts
router.delete('/me/data', authMiddleware, async (req, res) => {
  const userId = req.user.id;

  try {
    // Get all spots to find photo URLs
    const spots = await spotRepository.findAllByUserId(userId);

    // Extract photo keys
    const photoKeys = spots
      .filter((spot) => spot.photoUrl)
      .map((spot) => extractPhotoKey(spot.photoUrl!));

    // Delete photos from R2 in batches
    if (photoKeys.length > 0) {
      await r2Service.deleteObjects(photoKeys);
    }

    // Delete all spots (cascade deletes share_tokens)
    await spotRepository.deleteAllByUserId(userId);

    // Delete car tags
    await carTagRepository.deleteAllByUserId(userId);

    // Reset user preferences
    await userRepository.resetPreferences(userId);

    console.log(
      `Deleted all data for user ${userId}: ${spots.length} spots, ${photoKeys.length} photos`
    );

    return res.status(204).send();
  } catch (error) {
    console.error('Failed to delete user data:', error);
    return res.status(500).json({ error: 'Failed to delete all data. Please try again.' });
  }
});
```

### R2 Batch Delete

```typescript
// services/r2.service.ts
export const r2Service = {
  deleteObjects: async (keys: string[]): Promise<void> => {
    // R2 supports up to 1000 objects per delete request
    const BATCH_SIZE = 1000;

    for (let i = 0; i < keys.length; i += BATCH_SIZE) {
      const batch = keys.slice(i, i + BATCH_SIZE);

      await r2Client.send(
        new DeleteObjectsCommand({
          Bucket: R2_BUCKET,
          Delete: {
            Objects: batch.map((key) => ({ Key: key })),
            Quiet: true,
          },
        })
      );
    }
  },
};
```

### Delete Data Confirmation Page

```tsx
// pages/DeleteDataPage.tsx
export function DeleteDataPage() {
  const navigate = useNavigate();
  const { isGuest, signOut } = useAuthStore();
  const [confirmText, setConfirmText] = useState('');
  const [isDeleting, setIsDeleting] = useState(false);

  const canDelete = confirmText === 'DELETE';

  const handleDelete = async () => {
    if (!canDelete) return;

    setIsDeleting(true);

    try {
      if (isGuest) {
        await clearAllGuestData();
      } else {
        await apiClient.delete('/v1/users/me/data');
        await signOut();
      }

      toast.success('All data deleted');
      navigate('/');
    } catch (error) {
      toast.error('Failed to delete data');
    } finally {
      setIsDeleting(false);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      <header className="bg-white p-4 border-b flex items-center">
        <BackButton />
        <h1 className="text-xl font-bold ml-2">Delete All Data</h1>
      </header>

      <div className="p-4 space-y-6">
        <div className="bg-red-50 border border-red-200 rounded-lg p-4">
          <div className="flex items-start gap-3">
            <AlertTriangle className="w-6 h-6 text-red-500 shrink-0" />
            <div>
              <h2 className="font-semibold text-red-800">Warning</h2>
              <p className="text-sm text-red-700 mt-1">
                This will permanently delete all your parking spots and photos. This action cannot
                be undone.
              </p>
            </div>
          </div>
        </div>

        <div className="bg-white rounded-lg p-4 space-y-4">
          <p className="text-sm text-gray-600">
            To confirm, type <span className="font-mono font-bold">DELETE</span> below:
          </p>

          <input
            type="text"
            value={confirmText}
            onChange={(e) => setConfirmText(e.target.value.toUpperCase())}
            placeholder="Type DELETE to confirm"
            className="w-full px-4 py-3 border rounded-lg font-mono"
            disabled={isDeleting}
          />

          <div className="flex gap-3">
            <Button
              onClick={() => navigate(-1)}
              variant="secondary"
              className="flex-1"
              disabled={isDeleting}
            >
              Cancel
            </Button>
            <Button
              onClick={handleDelete}
              variant="destructive"
              className="flex-1"
              disabled={!canDelete || isDeleting}
            >
              {isDeleting ? 'Deleting...' : 'Delete All Data'}
            </Button>
          </div>
        </div>

        {!isGuest && (
          <p className="text-sm text-gray-500 text-center">
            Your account will remain active. Only your parking data will be deleted.
          </p>
        )}
      </div>
    </div>
  );
}
```

### Guest Data Clearing

```typescript
// services/guest.service.ts
export async function clearAllGuestData(): Promise<void> {
  // Clear IndexedDB
  await IndexedDBService.clearAll();

  // Clear localStorage
  localStorage.removeItem(GUEST_RETENTION_KEY);
  localStorage.removeItem(GUEST_TAGS_KEY);

  // Reset any in-memory stores
  useSpotStore.getState().reset();
  useCarTagsStore.getState().reset();
}
```

### File Locations

**New Files:**

- `apps/web/src/pages/DeleteDataPage.tsx`
- `apps/web/src/components/settings/DeleteDataConfirmation.tsx`
- `apps/api/src/services/r2.service.ts` - add batch delete

**Modified Files:**

- `apps/api/src/routes/users/users.routes.ts` - add DELETE endpoint
- `apps/api/src/repositories/spot.repository.ts` - add deleteAllByUserId
- `apps/api/src/repositories/carTag.repository.ts` - add deleteAllByUserId
- `apps/web/src/router.tsx` - add /settings/delete-data route

### Testing Coverage

- DeleteDataPage: 90%
- Delete endpoint: 100%
- R2 batch delete: 95%
- Guest data clearing: 95%

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation | PO     |
