# Story 1.3: Apple Sign-In

## Status

Postponed

## Story

**As a** user on an Apple device,  
**I want** to sign in with my Apple ID,  
**so that** I can use my preferred authentication method and sync my spots.

## Acceptance Criteria

1. Login screen displays "Continue with Apple" button (proper Apple branding)
2. Clicking button initiates Sign in with Apple web flow
3. After successful authentication, user is redirected back to app
4. Backend validates Apple identity token and creates/retrieves user record
5. User session is established with JWT token
6. Handles Apple's privacy email relay (hidden email) appropriately
7. Works correctly on Safari iOS and other browsers
8. Errors during auth flow display user-friendly messages

## Tasks / Subtasks

- [ ] **Task 1: Setup Apple Developer Account & Credentials** (AC: 2)
  - [ ] Ensure Apple Developer Program membership is active
  - [ ] Register App ID with "Sign in with Apple" capability
  - [ ] Create Services ID for web authentication
  - [ ] Configure domains and return URLs
  - [ ] Generate private key for client secret
  - [ ] Add environment variables:
    - `APPLE_CLIENT_ID` (Services ID)
    - `APPLE_TEAM_ID`
    - `APPLE_KEY_ID`
    - `APPLE_PRIVATE_KEY`

- [ ] **Task 2: Create Apple Auth Service** (AC: 2, 3, 4)
  - [ ] Create `apps/api/src/services/apple/apple.service.ts`
  - [ ] Create `apps/api/src/services/apple/types.ts`
  - [ ] Implement `generateClientSecret()` - JWT signed with Apple private key
  - [ ] Implement `getAuthorizationUrl()` - build Apple auth URL
  - [ ] Implement `exchangeCodeForTokens(code)` - token exchange
  - [ ] Implement `verifyIdentityToken(idToken)` - validate Apple JWT
  - [ ] Write unit tests for Apple service

- [ ] **Task 3: Add Apple Auth Routes** (AC: 2, 3, 4, 5)
  - [ ] Add `GET /auth/apple` to `auth.routes.ts` - redirect to Apple
  - [ ] Add `POST /auth/apple/callback` to handle Apple callback (POST for web)
  - [ ] Extract user info from identity token (sub, email, name)
  - [ ] Handle first-time sign-in (Apple only sends name on first auth)
  - [ ] Create or retrieve user in database (reuse user repository)
  - [ ] Generate JWT tokens and set cookies (reuse from Story 1.2)
  - [ ] Redirect to frontend app
  - [ ] Write integration tests for Apple auth endpoints

- [ ] **Task 4: Handle Apple Privacy Email Relay** (AC: 6)
  - [ ] Detect privaterelay.appleid.com emails
  - [ ] Store relay email as user's email (it's stable per app)
  - [ ] Display appropriate UI for relay emails (show "Apple ID" not email)
  - [ ] Document behavior in user-facing help text

- [ ] **Task 5: Frontend - Apple Login Button** (AC: 1, 7)
  - [ ] Add "Continue with Apple" button to `LoginPage.tsx`
  - [ ] Create `AppleLoginButton.tsx` component with proper Apple branding
  - [ ] Use official Apple button styles (black/white variants)
  - [ ] Add Apple Sign-in JavaScript SDK for Safari optimization (optional)
  - [ ] Handle click → redirect to `/auth/apple`
  - [ ] Test on Safari iOS, Chrome, Firefox

- [ ] **Task 6: Update Auth Store for Apple** (AC: 5)
  - [ ] Update `authStore.ts` to handle Apple provider
  - [ ] Update `useAuth` hook `login()` to support 'apple' provider
  - [ ] Update user display to handle Apple relay emails gracefully

- [ ] **Task 7: Error Handling** (AC: 8)
  - [ ] Handle Apple auth cancellation gracefully
  - [ ] Handle token validation failures
  - [ ] Display user-friendly error messages
  - [ ] Log errors for debugging (without exposing sensitive data)

- [ ] **Task 8: Testing & Documentation**
  - [ ] Test full flow on iOS Safari
  - [ ] Test on desktop browsers (Chrome, Firefox, Safari)
  - [ ] Document Apple Developer Console setup steps
  - [ ] Document environment variables required
  - [ ] Add curl examples for testing (where applicable)

## Dev Notes

### Previous Story (1.2) Context

Story 1.2 implemented:

- Google OAuth flow with JWT tokens
- User repository (`user.repository.ts`)
- JWT service (`jwt.service.ts`)
- Auth middleware (`auth.middleware.ts`)
- Auth store and useAuth hook on frontend
- Login page with Google button

This story adds Apple as a second OAuth provider, reusing most of the auth infrastructure.

### Apple Sign-In Flow Diagram

```
┌────────┐     ┌────────┐     ┌────────┐     ┌────────┐
│  User  │     │  PWA   │     │  API   │     │ Apple  │
└───┬────┘     └───┬────┘     └───┬────┘     └───┬────┘
    │              │              │              │
    │ Click Apple  │              │              │
    │─────────────>│              │              │
    │              │              │              │
    │              │ GET /auth/apple             │
    │              │─────────────>│              │
    │              │              │              │
    │              │   Redirect   │              │
    │              │<─────────────│              │
    │              │              │              │
    │         Redirect to Apple Sign-In         │
    │<─────────────────────────────────────────>│
    │              │              │              │
    │              │ POST /auth/apple/callback   │
    │              │─────────────>│              │
    │              │              │              │
    │              │              │ Verify token │
    │              │              │─────────────>│
    │              │              │              │
    │              │              │ User info    │
    │              │              │<─────────────│
    │              │              │              │
    │              │ Set cookies  │              │
    │              │<─────────────│              │
    │              │              │              │
    │  Redirect to app            │              │
    │<─────────────│              │              │
```

### API Endpoints

[Source: architecture/5-api-specification.md]

| Method | Endpoint               | Description                           |
| ------ | ---------------------- | ------------------------------------- |
| GET    | `/auth/apple`          | Initiate Apple Sign-In                |
| POST   | `/auth/apple/callback` | Apple Sign-In callback (POST for web) |

### Key Differences from Google OAuth

| Aspect           | Google             | Apple                       |
| ---------------- | ------------------ | --------------------------- |
| Callback method  | GET                | POST (form_post)            |
| Client secret    | Static string      | JWT signed with private key |
| User name        | Always provided    | Only on first sign-in       |
| Email            | Real email         | May be private relay        |
| Token validation | Google public keys | Apple public keys           |

### Apple Identity Token Claims

```typescript
interface AppleIdentityToken {
  iss: 'https://appleid.apple.com';
  sub: string; // Unique user ID (stable per app)
  aud: string; // Your client ID
  iat: number; // Issued at
  exp: number; // Expiration
  email?: string; // May be relay email
  email_verified?: boolean;
  is_private_email?: boolean; // True if using relay
  nonce?: string;
}
```

### Apple Client Secret Generation

[Source: Apple Developer Documentation]

```typescript
// services/apple/apple.service.ts
import jwt from 'jsonwebtoken';
import { env } from '@/config/env';

export const appleService = {
  generateClientSecret: (): string => {
    const now = Math.floor(Date.now() / 1000);

    const payload = {
      iss: env.APPLE_TEAM_ID,
      iat: now,
      exp: now + 86400 * 180, // 180 days max
      aud: 'https://appleid.apple.com',
      sub: env.APPLE_CLIENT_ID,
    };

    return jwt.sign(payload, env.APPLE_PRIVATE_KEY, {
      algorithm: 'ES256',
      keyid: env.APPLE_KEY_ID,
    });
  },
};
```

### Apple Authorization URL

```
https://appleid.apple.com/auth/authorize?
  client_id={APPLE_CLIENT_ID}&
  redirect_uri={callback_url}&
  response_type=code id_token&
  response_mode=form_post&
  scope=name email&
  state={csrf_token}
```

### Apple Token Exchange

```typescript
// POST https://appleid.apple.com/auth/token
const response = await fetch('https://appleid.apple.com/auth/token', {
  method: 'POST',
  headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
  body: new URLSearchParams({
    client_id: env.APPLE_CLIENT_ID,
    client_secret: appleService.generateClientSecret(),
    code: authorizationCode,
    grant_type: 'authorization_code',
    redirect_uri: callbackUrl,
  }),
});
```

### Apple Public Keys for Token Verification

```typescript
// Fetch Apple's public keys
const keysResponse = await fetch('https://appleid.apple.com/auth/keys');
const { keys } = await keysResponse.json();

// Use jose or jsonwebtoken to verify with public key
import { createRemoteJWKSet, jwtVerify } from 'jose';

const JWKS = createRemoteJWKSet(new URL('https://appleid.apple.com/auth/keys'));
const { payload } = await jwtVerify(identityToken, JWKS, {
  issuer: 'https://appleid.apple.com',
  audience: env.APPLE_CLIENT_ID,
});
```

### Environment Variables Required

```bash
# Apple Sign-In (add to existing .env)
APPLE_CLIENT_ID=com.yourapp.service  # Services ID
APPLE_TEAM_ID=XXXXXXXXXX             # 10-char Team ID
APPLE_KEY_ID=XXXXXXXXXX              # Key ID from Apple
APPLE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----"
```

### File Locations (Reuse + New)

**Reuse from Story 1.2:**

- `apps/api/src/repositories/user.repository.ts`
- `apps/api/src/services/jwt/jwt.service.ts`
- `apps/api/src/middleware/auth.middleware.ts`
- `apps/web/src/stores/authStore.ts`
- `apps/web/src/hooks/useAuth/useAuth.ts`

**New files:**

- `apps/api/src/services/apple/apple.service.ts`
- `apps/api/src/services/apple/types.ts`
- `apps/web/src/components/auth/AppleLoginButton.tsx`

**Modified files:**

- `apps/api/src/routes/auth/auth.routes.ts` - add Apple routes
- `apps/api/src/routes/auth/auth.service.ts` - add Apple handler
- `apps/api/src/config/env.ts` - add Apple env vars
- `apps/web/src/pages/LoginPage.tsx` - add Apple button

### Apple Button Branding Guidelines

[Source: Apple Human Interface Guidelines]

- Must use official Apple button styles
- Black button on light backgrounds, white on dark
- "Sign in with Apple" or "Continue with Apple" text
- Apple logo must be included
- Minimum size: 140x30 points

```tsx
// components/auth/AppleLoginButton.tsx
export function AppleLoginButton({ onClick }: { onClick: () => void }) {
  return (
    <button
      onClick={onClick}
      className="flex items-center justify-center gap-2 w-full h-12 bg-black text-white rounded-lg font-medium hover:bg-gray-800 transition-colors"
    >
      <AppleLogo className="w-5 h-5" />
      Continue with Apple
    </button>
  );
}
```

### Handling Private Relay Email

```typescript
// In auth.service.ts
const isPrivateRelay = payload.is_private_email === true;
const displayName = isPrivateRelay && !payload.email ? 'Apple User' : payload.email?.split('@')[0];

// Store the relay email - it's stable and unique per app
const user = await userRepository.create({
  email: payload.email, // Even if it's a relay
  provider: 'apple',
  providerId: payload.sub,
  displayName,
  // Note: Apple only sends name on FIRST sign-in
  // Must store it then, won't get it again
});
```

### Testing

[Source: architecture-backend/11-testing-strategy.md]

**Coverage Targets:**

- Apple service: 100%
- Auth routes (Apple): 100%

**Test Example:**

```typescript
// apps/api/test/integration/auth-apple.test.ts
import { describe, it, expect, vi } from 'vitest';
import request from 'supertest';
import { createApp } from '@/app';

describe('Apple Auth API', () => {
  const app = createApp();

  describe('GET /v1/auth/apple', () => {
    it('should redirect to Apple Sign-In', async () => {
      const response = await request(app).get('/v1/auth/apple');

      expect(response.status).toBe(302);
      expect(response.headers.location).toContain('appleid.apple.com');
    });
  });

  describe('POST /v1/auth/apple/callback', () => {
    it('should handle valid Apple callback', async () => {
      // Mock Apple token verification
      vi.mock('@/services/apple/apple.service');

      // Test callback handling
      // (Full test requires mocking Apple's response)
    });
  });
});
```

### Coding Standards Reminders

[Source: architecture-frontend/12-coding-standards.md, architecture-backend/12-coding-standards.md]

- Types in `types.ts` per folder
- Services throw typed errors
- No try/catch in routes - let middleware handle
- No useCallback/useMemo unless proven needed

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation | PO     |
