# Story 2.4: Photo Upload from Gallery

## Status

Approved

## Story

**As a** user who denied camera permission or prefers gallery photos,  
**I want** to upload a photo from my device,  
**so that** I can still attach a visual to my parking spot.

## Acceptance Criteria

1. "Upload from Gallery" option available on confirmation screen
2. Opens device file picker for images
3. Selected photo is compressed and EXIF-stripped same as camera capture
4. Photo is uploaded to Cloudflare R2
5. Works on all supported browsers (iOS Safari, Android Chrome, desktop)
6. Handles large photos gracefully (resize before compression if needed)

## Tasks / Subtasks

- [ ] **Task 1: Create File Picker Hook** (AC: 2)
  - [ ] Create `apps/web/src/hooks/useFilePicker/useFilePicker.ts`
  - [ ] Create `apps/web/src/hooks/useFilePicker/types.ts`
  - [ ] Implement `pickImage()` - trigger file input
  - [ ] Accept image MIME types (image/jpeg, image/png, image/webp)
  - [ ] Return selected File object
  - [ ] Handle cancel (no file selected)
  - [ ] Write unit tests

- [ ] **Task 2: Create Gallery Upload Button** (AC: 1)
  - [ ] Create `apps/web/src/components/camera/GalleryUploadButton.tsx`
  - [ ] Hidden file input with visible button trigger
  - [ ] Style consistently with camera button
  - [ ] Show "Upload from Gallery" text with icon

- [ ] **Task 3: Integrate with Image Processor** (AC: 3, 6)
  - [ ] Reuse `imageProcessor.service.ts` from Story 2.3
  - [ ] Pass gallery file through compression
  - [ ] Pass through EXIF stripper
  - [ ] Handle very large files (>5MB) gracefully
  - [ ] Add resize step before compression for large images

- [ ] **Task 4: Integrate with Photo Upload Flow** (AC: 4)
  - [ ] Reuse `usePhotoUpload` hook from Story 2.3
  - [ ] Gallery upload uses same R2 upload flow
  - [ ] Show same progress indicator
  - [ ] Update spot with photo URL on success

- [ ] **Task 5: Add to Confirmation Screen** (AC: 1)
  - [ ] Add "Upload from Gallery" as secondary option
  - [ ] Show as alternative to camera capture
  - [ ] Position below or next to camera button
  - [ ] Show when camera permission denied (primary)

- [ ] **Task 6: Cross-Browser Testing** (AC: 5)
  - [ ] Test on iOS Safari (file picker behavior)
  - [ ] Test on Android Chrome
  - [ ] Test on desktop Chrome/Firefox/Safari
  - [ ] Verify file picker opens correctly on each
  - [ ] Handle iOS HEIC format conversion

- [ ] **Task 7: Large File Handling** (AC: 6)
  - [ ] Detect files >5MB
  - [ ] Show warning/loading for large files
  - [ ] Resize to max 2000px before compression
  - [ ] Ensure final output â‰¤200KB

- [ ] **Task 8: Guest Mode Gallery Upload**
  - [ ] Same IndexedDB storage as camera capture
  - [ ] Compress to smaller size for IndexedDB
  - [ ] Test with large gallery photos

- [ ] **Task 9: Testing & Documentation**
  - [ ] Test file picker on mobile browsers
  - [ ] Test with various image sizes
  - [ ] Test with HEIC images (iOS)
  - [ ] Write Playwright E2E tests

## Dev Notes

### Architecture References

- Builds on Story 2.3 infrastructure
- Reuses: imageProcessor, usePhotoUpload, R2 service

### File Picker Implementation

```typescript
// hooks/useFilePicker/useFilePicker.ts
export function useFilePicker() {
  const inputRef = useRef<HTMLInputElement>(null);
  const [isSelecting, setIsSelecting] = useState(false);

  const pickImage = (): Promise<File | null> => {
    return new Promise((resolve) => {
      const input = inputRef.current;
      if (!input) {
        resolve(null);
        return;
      }

      setIsSelecting(true);

      const handleChange = (e: Event) => {
        const target = e.target as HTMLInputElement;
        const file = target.files?.[0] || null;
        setIsSelecting(false);
        input.value = ""; // Reset for next selection
        resolve(file);
      };

      const handleCancel = () => {
        setIsSelecting(false);
        resolve(null);
      };

      input.addEventListener("change", handleChange, { once: true });
      // Handle cancel (user closes picker without selecting)
      window.addEventListener(
        "focus",
        () => {
          setTimeout(handleCancel, 300);
        },
        { once: true }
      );

      input.click();
    });
  };

  const FileInput = () => (
    <input
      ref={inputRef}
      type="file"
      accept="image/jpeg,image/png,image/webp,image/heic"
      capture={false} // Allow gallery, not just camera
      className="hidden"
    />
  );

  return { pickImage, FileInput, isSelecting };
}
```

### Gallery Upload Button

```tsx
// components/camera/GalleryUploadButton.tsx
import { Upload } from 'lucide-react';
import { useFilePicker } from '@/hooks/useFilePicker';
import { usePhotoUpload } from '@/hooks/usePhotoUpload';
import { imageProcessor } from '@/services/image/imageProcessor.service';

interface GalleryUploadButtonProps {
  onPhotoUploaded: (url: string) => void;
}

export function GalleryUploadButton({ onPhotoUploaded }: GalleryUploadButtonProps) {
  const { pickImage, FileInput, isSelecting } = useFilePicker();
  const { uploadPhoto, isUploading, progress } = usePhotoUpload();

  const handleUpload = async () => {
    const file = await pickImage();
    if (!file) return;

    // Process image
    const stripped = await imageProcessor.stripExifData(file);
    const compressed = await imageProcessor.compressImage(stripped);

    // Upload
    const url = await uploadPhoto(compressed);
    onPhotoUploaded(url);
  };

  return (
    <>
      <FileInput />
      <button
        onClick={handleUpload}
        disabled={isSelecting || isUploading}
        className="flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
      >
        <Upload className="w-5 h-5" />
        <span>Upload from Gallery</span>
      </button>
      {isUploading && <ProgressBar progress={progress} />}
    </>
  );
}
```

### HEIC Handling (iOS)

```typescript
// Handle HEIC format from iOS devices
const processFile = async (file: File): Promise<Blob> => {
  // Check if HEIC
  if (file.type === 'image/heic' || file.name.toLowerCase().endsWith('.heic')) {
    // Convert HEIC to JPEG using heic2any library (or canvas)
    // Note: Browser support varies, may need polyfill
    const converted = await convertHeicToJpeg(file);
    return imageProcessor.compressImage(converted);
  }

  return imageProcessor.compressImage(file);
};

// Alternative: Let canvas handle conversion
// Drawing HEIC to canvas auto-converts on supported browsers
```

### Large File Warning

```tsx
// components/ui/LargeFileWarning.tsx
export function LargeFileWarning({ fileSize }: { fileSize: number }) {
  const sizeMB = (fileSize / (1024 * 1024)).toFixed(1);

  if (fileSize < 5 * 1024 * 1024) return null;

  return (
    <div className="text-amber-600 text-sm flex items-center gap-1">
      <AlertCircle className="w-4 h-4" />
      <span>Large file ({sizeMB}MB) - compressing...</span>
    </div>
  );
}
```

### Integration in Confirmation Screen

```tsx
// In SpotConfirmationPage or SpotActions
<div className="space-y-2">
  {cameraPermission === 'granted' ? (
    <CameraButton onClick={openCamera} />
  ) : (
    <CameraButton onClick={requestCamera} label="Enable Camera" />
  )}

  <GalleryUploadButton onPhotoUploaded={handlePhotoUploaded} />
</div>
```

### File Locations

**New Files:**

- `apps/web/src/hooks/useFilePicker/useFilePicker.ts`
- `apps/web/src/hooks/useFilePicker/types.ts`
- `apps/web/src/components/camera/GalleryUploadButton.tsx`

**Modified Files:**

- `apps/web/src/components/spot/SpotActions.tsx` - add gallery option

### Dependencies

- Story 2.3 (Photo Capture) must be complete first
- Reuses imageProcessor and usePhotoUpload

### Testing Coverage

- useFilePicker: 90%
- GalleryUploadButton: 90%
- HEIC handling: 80%

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation | PO     |
