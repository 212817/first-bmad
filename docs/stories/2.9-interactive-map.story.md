# Story 2.9: Interactive Map with Marker Adjustment

## Status

Approved

## Story

**As a** user,  
**I want** to see my parking spot on an interactive map and adjust the marker if needed,  
**so that** I can visually confirm the location and correct GPS inaccuracies.

## Acceptance Criteria

1. Confirmation screen displays an interactive map instead of placeholder
2. Map uses free, open-source solution (Leaflet with OpenStreetMap)
3. Map supports hybrid view (satellite imagery with street labels) where available
4. Saved spot location is marked with a draggable pin/marker
5. User can drag marker to adjust location if GPS was inaccurate
6. Adjusted coordinates are saved to the spot record
7. Map is responsive and works well on mobile devices
8. Map loads quickly and doesn't block the save flow

## Tasks / Subtasks

- [ ] **Task 1: Install Leaflet Dependencies** (prerequisite)
  - [ ] `pnpm add leaflet react-leaflet`
  - [ ] `pnpm add -D @types/leaflet`
  - [ ] Import Leaflet CSS in app entry point

- [ ] **Task 2: Create Map Component** (AC: 1, 2, 7)
  - [ ] Create `apps/web/src/components/map/SpotMap.tsx`
  - [ ] Create `apps/web/src/components/map/types.ts`
  - [ ] Initialize Leaflet map with OpenStreetMap tiles
  - [ ] Center map on spot coordinates
  - [ ] Set appropriate zoom level (17-18 for parking)
  - [ ] Make component responsive (full width, fixed height)
  - [ ] Add loading state while tiles load
  - [ ] Export from `apps/web/src/components/map/index.ts`

- [ ] **Task 3: Implement Hybrid/Satellite View** (AC: 3)
  - [ ] Add tile layer switcher
  - [ ] Use free satellite imagery (ESRI World Imagery, Mapbox Satellite if free tier)
  - [ ] Options: OpenStreetMap (default), Satellite, Hybrid (satellite + labels)
  - [ ] Persist user preference in localStorage
  - [ ] Layer control UI (toggle button or dropdown)

- [ ] **Task 4: Add Draggable Marker** (AC: 4, 5)
  - [ ] Create custom marker icon (parking pin style)
  - [ ] Place marker at spot coordinates
  - [ ] Make marker draggable
  - [ ] Show visual feedback when dragging
  - [ ] Emit `onPositionChange(lat, lng)` on drag end
  - [ ] Snap back to original if cancelled

- [ ] **Task 5: Save Adjusted Location** (AC: 6)
  - [ ] Add "Confirm Location" button when marker moved
  - [ ] Call `updateSpot(id, { lat, lng })` with new coordinates
  - [ ] Update PATCH endpoint to accept lat/lng changes
  - [ ] Show success feedback on save
  - [ ] Trigger reverse geocoding for new address

- [ ] **Task 6: Integrate into Confirmation Screen** (AC: 1, 8)
  - [ ] Replace map placeholder in SpotDetailCard with SpotMap
  - [ ] Pass spot coordinates and callbacks
  - [ ] Handle edit mode (show/hide adjust controls)
  - [ ] Ensure map doesn't block initial render (lazy load)

- [ ] **Task 7: Mobile Optimization** (AC: 7)
  - [ ] Enable touch gestures (pinch zoom, drag)
  - [ ] Ensure marker is easily tappable
  - [ ] Prevent body scroll when interacting with map
  - [ ] Test on various screen sizes

- [ ] **Task 8: Testing**
  - [ ] Unit tests for SpotMap component
  - [ ] Test marker drag events
  - [ ] Test tile layer switching
  - [ ] Test coordinate saving
  - [ ] E2E tests for map interaction

## Dev Notes

### Architecture References

- [architecture-frontend/3-component-architecture.md](../architecture-frontend/3-component-architecture.md)

### Recommended Tile Providers (Free)

```typescript
// OpenStreetMap (default, street view)
const OSM_TILES = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
const OSM_ATTR = '&copy; OpenStreetMap contributors';

// ESRI World Imagery (satellite, free)
const ESRI_SATELLITE =
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
const ESRI_ATTR = 'Tiles &copy; Esri';

// ESRI Labels (overlay for hybrid)
const ESRI_LABELS =
  'https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}';

// CartoDB Positron (light, clean)
const CARTO_LIGHT = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
```

### SpotMap Component Structure

```tsx
// components/map/SpotMap.tsx
import { MapContainer, TileLayer, Marker, useMapEvents } from 'react-leaflet';
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';

interface SpotMapProps {
  lat: number;
  lng: number;
  editable?: boolean;
  onPositionChange?: (lat: number, lng: number) => void;
}

export const SpotMap = ({ lat, lng, editable = false, onPositionChange }: SpotMapProps) => {
  const [position, setPosition] = useState<[number, number]>([lat, lng]);
  const [isDirty, setIsDirty] = useState(false);

  const handleDragEnd = (e: L.DragEndEvent) => {
    const marker = e.target;
    const pos = marker.getLatLng();
    setPosition([pos.lat, pos.lng]);
    setIsDirty(true);
  };

  const handleConfirm = () => {
    onPositionChange?.(position[0], position[1]);
    setIsDirty(false);
  };

  return (
    <div className="relative h-48 rounded-lg overflow-hidden">
      <MapContainer center={position} zoom={17} scrollWheelZoom={false} className="h-full w-full">
        <TileLayer url={OSM_TILES} attribution={OSM_ATTR} />
        <Marker
          position={position}
          draggable={editable}
          eventHandlers={{ dragend: handleDragEnd }}
        />
      </MapContainer>

      {isDirty && (
        <button
          onClick={handleConfirm}
          className="absolute bottom-2 left-1/2 -translate-x-1/2 px-4 py-2 bg-indigo-600 text-white rounded-lg"
        >
          Confirm Location
        </button>
      )}
    </div>
  );
};
```

### Layer Switcher UI

```tsx
// Tile layer options for user selection
const TILE_LAYERS = {
  street: { url: OSM_TILES, name: 'Street' },
  satellite: { url: ESRI_SATELLITE, name: 'Satellite' },
  hybrid: {
    base: ESRI_SATELLITE,
    overlay: ESRI_LABELS,
    name: 'Hybrid',
  },
};

// Toggle button in corner of map
<div className="absolute top-2 right-2 z-[1000] bg-white rounded-lg shadow">
  <button onClick={toggleLayer}>üó∫Ô∏è</button>
</div>;
```

### PATCH Endpoint Update

```typescript
// Add lat/lng to updateSpot validation
const updateSpotSchema = z.object({
  note: z.string().max(500).optional(),
  photoUrl: z.string().url().optional().nullable(),
  carTag: z.string().max(50).optional().nullable(),
  lat: z.number().min(-90).max(90).optional(),
  lng: z.number().min(-180).max(180).optional(),
});
```

### File Locations

**New Files:**

- `apps/web/src/components/map/SpotMap.tsx`
- `apps/web/src/components/map/types.ts`
- `apps/web/src/components/map/index.ts`
- `apps/web/src/components/map/__tests__/SpotMap.test.tsx`

**Modified Files:**

- `apps/web/src/components/spot/SpotDetailCard.tsx` - integrate SpotMap
- `apps/web/src/pages/SpotConfirmationPage.tsx` - pass edit callbacks
- `apps/api/src/routes/spots/spots.service.ts` - accept lat/lng updates
- `apps/web/package.json` - add leaflet dependencies

### Dependencies

- `leaflet` - Map library
- `react-leaflet` - React bindings for Leaflet
- `@types/leaflet` - TypeScript types

### Testing Coverage

- SpotMap: 95%
- PATCH lat/lng: 100%

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-02-02 | 1.0     | Initial story creation | Dev    |

## Dev Agent Record

### Agent Model Used

_To be filled during implementation_

### File List

_To be filled during implementation_

### Debug Log References

_To be filled during implementation_

### Completion Notes

_To be filled during implementation_
