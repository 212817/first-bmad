# Story 2.9: Interactive Map with Marker Adjustment

## Status

In Progress

## Story

**As a** user,  
**I want** to see my parking spot on an interactive map and adjust the marker if needed,  
**so that** I can visually confirm the location and correct GPS inaccuracies.

## Acceptance Criteria

1. Confirmation screen displays an interactive map instead of placeholder
2. Map uses free, open-source solution (Leaflet with OpenStreetMap)
3. Map supports hybrid view (satellite imagery with street labels) where available
4. Saved spot location is marked with a draggable pin/marker
5. User can drag marker to adjust location if GPS was inaccurate
6. Adjusted coordinates are saved to the spot record
7. Map is responsive and works well on mobile devices
8. Map loads quickly and doesn't block the save flow

## Tasks / Subtasks

- [x] **Task 1: Install Leaflet Dependencies** (prerequisite)
  - [x] `pnpm add leaflet react-leaflet`
  - [x] `pnpm add -D @types/leaflet`
  - [x] Import Leaflet CSS in app entry point

- [x] **Task 2: Create Map Component** (AC: 1, 2, 7)
  - [x] Create `apps/web/src/components/map/SpotMap.tsx`
  - [x] Create `apps/web/src/components/map/types.ts`
  - [x] Initialize Leaflet map with OpenStreetMap tiles
  - [x] Center map on spot coordinates
  - [x] Set appropriate zoom level (17-18 for parking)
  - [x] Make component responsive (full width, fixed height)
  - [x] Add loading state while tiles load
  - [x] Export from `apps/web/src/components/map/index.ts`

- [x] **Task 3: Implement Hybrid/Satellite View** (AC: 3)
  - [x] Add tile layer switcher
  - [x] Use free satellite imagery (ESRI World Imagery)
  - [x] Options: OpenStreetMap (default), Satellite, Hybrid (satellite + labels)
  - [x] Persist user preference in localStorage
  - [x] Layer control UI (dropdown menu)

- [x] **Task 4: Add Draggable Marker** (AC: 4, 5)
  - [x] Use Leaflet default marker icon (resolved bundler issues)
  - [x] Place marker at spot coordinates
  - [x] Make marker draggable (editable prop)
  - [x] Show drag hint when editable
  - [x] Emit `onPositionChange(lat, lng)` on confirm
  - [x] Snap back to original if cancelled

- [x] **Task 5: Save Adjusted Location** (AC: 6)
  - [x] Add "Confirm Location" button when marker moved
  - [x] Call `updateSpot(id, { lat, lng })` with new coordinates
  - [x] Update PATCH endpoint to accept lat/lng changes
  - [x] Address cleared on coordinate change to allow re-geocoding
  - [x] Trigger reverse geocoding for new address

- [x] **Task 6: Integrate into Confirmation Screen** (AC: 1, 8)
  - [x] Replace map placeholder in SpotDetailCard with SpotMap
  - [x] Pass spot coordinates and callbacks
  - [x] Handle edit mode (editable prop, disabled for guests)
  - [x] Lazy load SpotMap with Suspense (doesn't block render)

- [x] **Task 7: Mobile Optimization** (AC: 7)
  - [x] Touch gestures enabled by default (Leaflet built-in)
  - [x] Marker size appropriate for touch (Leaflet default 25x41px)
  - [x] Map container prevents body scroll during interaction
  - [x] Responsive design with full width container

- [x] **Task 8: Testing**
  - [x] Unit tests for SpotMap component (19 tests)
  - [x] Unit tests for LayerSwitcher component (13 tests)
  - [x] Test tile layer switching and localStorage persistence
  - [x] Test coordinate update in backend (5 new tests)
  - [x] Updated SpotDetailCard tests for map integration

## Dev Notes

### Architecture References

- [architecture-frontend/3-component-architecture.md](../architecture-frontend/3-component-architecture.md)

### Recommended Tile Providers (Free)

```typescript
// OpenStreetMap (default, street view)
const OSM_TILES = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
const OSM_ATTR = '&copy; OpenStreetMap contributors';

// ESRI World Imagery (satellite, free)
const ESRI_SATELLITE =
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
const ESRI_ATTR = 'Tiles &copy; Esri';

// ESRI Labels (overlay for hybrid)
const ESRI_LABELS =
  'https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}';

// CartoDB Positron (light, clean)
const CARTO_LIGHT = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
```

### SpotMap Component Structure

```tsx
// components/map/SpotMap.tsx
import { MapContainer, TileLayer, Marker, useMapEvents } from 'react-leaflet';
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';

interface SpotMapProps {
  lat: number;
  lng: number;
  editable?: boolean;
  onPositionChange?: (lat: number, lng: number) => void;
}

export const SpotMap = ({ lat, lng, editable = false, onPositionChange }: SpotMapProps) => {
  const [position, setPosition] = useState<[number, number]>([lat, lng]);
  const [isDirty, setIsDirty] = useState(false);

  const handleDragEnd = (e: L.DragEndEvent) => {
    const marker = e.target;
    const pos = marker.getLatLng();
    setPosition([pos.lat, pos.lng]);
    setIsDirty(true);
  };

  const handleConfirm = () => {
    onPositionChange?.(position[0], position[1]);
    setIsDirty(false);
  };

  return (
    <div className="relative h-48 rounded-lg overflow-hidden">
      <MapContainer center={position} zoom={17} scrollWheelZoom={false} className="h-full w-full">
        <TileLayer url={OSM_TILES} attribution={OSM_ATTR} />
        <Marker
          position={position}
          draggable={editable}
          eventHandlers={{ dragend: handleDragEnd }}
        />
      </MapContainer>

      {isDirty && (
        <button
          onClick={handleConfirm}
          className="absolute bottom-2 left-1/2 -translate-x-1/2 px-4 py-2 bg-indigo-600 text-white rounded-lg"
        >
          Confirm Location
        </button>
      )}
    </div>
  );
};
```

### Layer Switcher UI

```tsx
// Tile layer options for user selection
const TILE_LAYERS = {
  street: { url: OSM_TILES, name: 'Street' },
  satellite: { url: ESRI_SATELLITE, name: 'Satellite' },
  hybrid: {
    base: ESRI_SATELLITE,
    overlay: ESRI_LABELS,
    name: 'Hybrid',
  },
};

// Toggle button in corner of map
<div className="absolute top-2 right-2 z-[1000] bg-white rounded-lg shadow">
  <button onClick={toggleLayer}>üó∫Ô∏è</button>
</div>;
```

### PATCH Endpoint Update

```typescript
// Add lat/lng to updateSpot validation
const updateSpotSchema = z.object({
  note: z.string().max(500).optional(),
  photoUrl: z.string().url().optional().nullable(),
  carTag: z.string().max(50).optional().nullable(),
  lat: z.number().min(-90).max(90).optional(),
  lng: z.number().min(-180).max(180).optional(),
});
```

### File Locations

**New Files:**

- `apps/web/src/components/map/SpotMap.tsx`
- `apps/web/src/components/map/types.ts`
- `apps/web/src/components/map/index.ts`
- `apps/web/src/components/map/__tests__/SpotMap.test.tsx`

**Modified Files:**

- `apps/web/src/components/spot/SpotDetailCard.tsx` - integrate SpotMap
- `apps/web/src/pages/SpotConfirmationPage.tsx` - pass edit callbacks
- `apps/api/src/routes/spots/spots.service.ts` - accept lat/lng updates
- `apps/web/package.json` - add leaflet dependencies

### Dependencies

- `leaflet` - Map library
- `react-leaflet` - React bindings for Leaflet
- `@types/leaflet` - TypeScript types

### Testing Coverage

- SpotMap: 95%
- PATCH lat/lng: 100%

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-02-02 | 1.0     | Initial story creation | Dev    |
| 2026-02-03 | 1.1     | Implementation complete | James (Claude Opus 4.5) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### File List

**New Files:**
- `apps/web/src/components/map/SpotMap.tsx` - Interactive Leaflet map component
- `apps/web/src/components/map/LayerSwitcher.tsx` - Map layer toggle dropdown
- `apps/web/src/components/map/types.ts` - TypeScript types and tile layer configs
- `apps/web/src/components/map/index.ts` - Barrel exports
- `apps/web/src/components/map/__tests__/SpotMap.test.tsx` - 19 unit tests
- `apps/web/src/components/map/__tests__/LayerSwitcher.test.tsx` - 13 unit tests

**Modified Files:**
- `apps/web/src/main.tsx` - Added Leaflet CSS import
- `apps/web/src/components/spot/SpotDetailCard.tsx` - Integrated lazy-loaded SpotMap
- `apps/web/src/components/spot/types.ts` - Added editable and onPositionChange props
- `apps/web/src/components/spot/__tests__/SpotDetailCard.test.tsx` - Updated for map mock
- `apps/web/src/pages/SpotConfirmationPage.tsx` - Added handlePositionChange callback
- `apps/web/src/stores/spot.types.ts` - Added lat/lng to UpdateSpotInput
- `apps/api/src/routes/spots/types.ts` - Added lat/lng to UpdateSpotRequest
- `apps/api/src/routes/spots/spots.service.ts` - Handle coordinate updates with re-geocoding
- `apps/api/test/unit/spots.service.test.ts` - Added 5 tests for coordinate updates
- `apps/web/package.json` - Added leaflet, react-leaflet, @types/leaflet

### Debug Log References

None - implementation went smoothly

### Completion Notes

- All 8 tasks completed
- 37 new tests added (32 frontend map + 5 backend)
- All 689 tests passing (449 frontend + 240 backend)
- Lint passes with only pre-existing warnings
- Map component lazy-loaded with Suspense to avoid blocking initial render
- Marker adjustment disabled for guest users (only authenticated users can adjust)
- Layer preference persisted in localStorage
- Coordinate updates trigger async reverse geocoding to refresh address
