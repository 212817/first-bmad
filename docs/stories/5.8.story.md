# Story 5.8: Auto-Delete Expired Spots (Retention Cleanup)

## Status

Approved

## Story

**As a** system,  
**I want** to automatically delete spots older than a user's retention preference,  
**so that** old parking data doesn't accumulate and user privacy is respected.

## Acceptance Criteria

1. Scheduled job runs daily to check for expired spots
2. Deletes spots based on each user's retention preference setting
3. Default retention is 90 days for new accounts
4. Associated photos are deleted from R2 before spot deletion
5. Guest users have a fixed 30-day retention
6. Job logs deleted spots count for monitoring
7. Spot deletion cascades: photos removed from R2 first

## Tasks / Subtasks

- [ ] **Task 0: Install Dependencies** (Prereq)
  - [ ] Verify node-cron installed (from Story 5.7)
  - [ ] If not: `npm install node-cron && npm install -D @types/node-cron`

- [ ] **Task 1: Create Retention Cleanup Job** (AC: 1, 2)
  - [ ] Create `apps/api/src/jobs/retentionCleanup.job.ts`
  - [ ] Schedule to run daily after storage cleanup
  - [ ] Query for expired spots per user retention
  - [ ] Process deletions in batches

- [ ] **Task 2: Find Expired Spots Logic** (AC: 2, 3, 5)
  - [ ] Join spots with users to get retention preference
  - [ ] Calculate expiry date per user
  - [ ] Default to 90 days if no preference set
  - [ ] Guest users use 30-day fixed retention
  - [ ] Return spots where savedAt < (now - retention)

- [ ] **Task 3: Delete Photos Before Spots** (AC: 4, 7)
  - [ ] For each expired spot with photoUrl
  - [ ] Delete photo from R2 first
  - [ ] Handle R2 deletion failures gracefully
  - [ ] Continue even if photo already deleted

- [ ] **Task 4: Batch Delete Expired Spots** (AC: 2)
  - [ ] Delete in batches of 100
  - [ ] Use transaction for consistency
  - [ ] Track deleted count
  - [ ] Handle partial failures

- [ ] **Task 5: Job Logging** (AC: 6)
  - [ ] Log job start time
  - [ ] Log number of spots processed
  - [ ] Log number of photos deleted
  - [ ] Log any errors encountered
  - [ ] Log job completion time

- [ ] **Task 6: Job Scheduling** (AC: 1)
  - [ ] Use node-cron
  - [ ] Schedule for 4 AM UTC daily (after storage cleanup)
  - [ ] Add manual trigger for testing
  - [ ] Document job schedule

- [ ] **Task 7: Testing**
  - [ ] Test retention calculation
  - [ ] Test user preference lookup
  - [ ] Test guest retention
  - [ ] Test cascade delete (photo â†’ spot)
  - [ ] Write integration tests

## Dev Notes

### Architecture References

- [architecture/7-data-models.md](../architecture/7-data-models.md)
- [architecture/8-infrastructure.md](../architecture/8-infrastructure.md)

### Dependencies

- Story 5.3 (Data Retention Preferences)
- Story 5.7 (Storage cleanup - runs first)

### Retention Options

From Story 5.3:

- 7 days (1 week)
- 30 days (1 month) - **default per PRD**
- 90 days (3 months)
- 365 days (1 year)
- forever (null/-1 retention)

### Retention Cleanup Job

```typescript
// jobs/retentionCleanup.job.ts
import cron from 'node-cron';
import { db } from '@/db';
import { spots, users } from '@/schema';
import { r2Service } from '@/services/r2.service';
import { and, lte, isNull, isNotNull, sql } from 'drizzle-orm';

const BATCH_SIZE = 100;
const GUEST_RETENTION_DAYS = 30;
const DEFAULT_RETENTION_DAYS = 30; // Align with PRD default

interface SpotToDelete {
  id: string;
  photoUrl: string | null;
  userId: string;
}

export function scheduleRetentionCleanup() {
  // Run daily at 4 AM UTC (after storage cleanup at 3 AM)
  cron.schedule('0 4 * * *', async () => {
    console.log('[RetentionCleanup] Starting daily retention cleanup...');
    await runRetentionCleanup();
  });
}

export async function runRetentionCleanup(): Promise<{
  spotsDeleted: number;
  photosDeleted: number;
}> {
  console.log('[RetentionCleanup] Job started at', new Date().toISOString());

  let totalSpotsDeleted = 0;
  let totalPhotosDeleted = 0;

  try {
    // Get expired spots with their user's retention preference
    const expiredSpots = await findExpiredSpots();

    console.log(`[RetentionCleanup] Found ${expiredSpots.length} expired spots`);

    // Process in batches
    for (let i = 0; i < expiredSpots.length; i += BATCH_SIZE) {
      const batch = expiredSpots.slice(i, i + BATCH_SIZE);
      const { spotsDeleted, photosDeleted } = await deleteBatch(batch);

      totalSpotsDeleted += spotsDeleted;
      totalPhotosDeleted += photosDeleted;

      console.log(
        `[RetentionCleanup] Batch processed: ${spotsDeleted} spots, ${photosDeleted} photos`
      );
    }

    console.log(
      `[RetentionCleanup] Completed: ${totalSpotsDeleted} spots deleted, ${totalPhotosDeleted} photos deleted`
    );
  } catch (error) {
    console.error('[RetentionCleanup] Job failed:', error);
    throw error;
  }

  return { spotsDeleted: totalSpotsDeleted, photosDeleted: totalPhotosDeleted };
}

async function findExpiredSpots(): Promise<SpotToDelete[]> {
  // Complex query: join spots with users, calculate expiry per user
  const result = await db.execute<SpotToDelete>(sql`
    SELECT s.id, s.photo_url as "photoUrl", s.user_id as "userId"
    FROM spots s
    LEFT JOIN users u ON s.user_id = u.id
    WHERE 
      -- Registered users with retention preference
      (u.id IS NOT NULL AND u.retention_days IS NOT NULL AND u.retention_days != 0
        AND s.saved_at < NOW() - (u.retention_days || ' days')::interval)
      OR
      -- Registered users with default retention (90 days)
      (u.id IS NOT NULL AND (u.retention_days IS NULL OR u.retention_days = 0)
        AND s.saved_at < NOW() - interval '${DEFAULT_RETENTION_DAYS} days')
      OR
      -- Guest users (30 days fixed)
      (u.id IS NULL AND s.saved_at < NOW() - interval '${GUEST_RETENTION_DAYS} days')
    ORDER BY s.saved_at ASC
    LIMIT 10000
  `);

  return result.rows;
}

async function deleteBatch(spots: SpotToDelete[]): Promise<{
  spotsDeleted: number;
  photosDeleted: number;
}> {
  let photosDeleted = 0;

  // Delete photos first
  for (const spot of spots) {
    if (spot.photoUrl) {
      try {
        const photoKey = extractPhotoKey(spot.photoUrl);
        await r2Service.deleteObject(photoKey);
        photosDeleted++;
      } catch (error) {
        // Log but continue - photo may already be deleted
        console.warn(`[RetentionCleanup] Failed to delete photo for spot ${spot.id}:`, error);
      }
    }
  }

  // Delete spots in transaction
  const spotIds = spots.map((s) => s.id);
  await db.delete(spots).where(inArray(spots.id, spotIds));

  return { spotsDeleted: spots.length, photosDeleted };
}

function extractPhotoKey(photoUrl: string): string {
  // Extract R2 key from URL
  const url = new URL(photoUrl);
  return url.pathname.slice(1); // Remove leading /
}
```

### User Schema with Retention

```typescript
// Already added in Story 5.3
retentionDays: integer('retention_days').default(30),
// null or 0 = use default (30 days)
// -1 = forever (never delete)
// positive number = days to keep
```

### Forever Retention Handling

```typescript
// Users with "forever" retention are excluded from cleanup
// retention_days = -1 means never auto-delete

// Updated query to exclude forever
WHERE u.retention_days IS NULL OR u.retention_days >= 0
```

### File Locations

**New Files:**

- `apps/api/src/jobs/retentionCleanup.job.ts`

**Modified Files:**

- `apps/api/src/index.ts` - schedule job on startup

### Job Registration

```typescript
// index.ts
import { scheduleStorageCleanup } from '@/jobs/storageCleanup.job';
import { scheduleRetentionCleanup } from '@/jobs/retentionCleanup.job';

// On startup
if (process.env.NODE_ENV === 'production') {
  scheduleStorageCleanup();
  scheduleRetentionCleanup();
  console.log('Scheduled jobs registered');
}
```

### Manual Trigger Endpoint

```typescript
// routes/admin/admin.routes.ts
router.post('/cleanup/retention', adminAuthMiddleware, async (req, res) => {
  const result = await runRetentionCleanup();
  res.json(result);
});
```

### Monitoring Output

```
[RetentionCleanup] Starting daily retention cleanup...
[RetentionCleanup] Job started at 2026-01-15T04:00:00.123Z
[RetentionCleanup] Found 342 expired spots
[RetentionCleanup] Batch processed: 100 spots, 87 photos
[RetentionCleanup] Batch processed: 100 spots, 92 photos
[RetentionCleanup] Batch processed: 100 spots, 78 photos
[RetentionCleanup] Batch processed: 42 spots, 31 photos
[RetentionCleanup] Completed: 342 spots deleted, 288 photos deleted
```

### Testing Coverage

- Retention calculation: 95%
- Expiry query logic: 90%
- Cascade deletion: 95%
- Guest vs registered: 90%

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation | PO     |
