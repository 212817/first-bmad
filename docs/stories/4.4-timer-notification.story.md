# Story 4.4: Browser Notification for Timer

## Status

Approved

## Story

**As a** user with a meter timer set,  
**I want** to receive a notification before my meter expires,  
**so that** I have time to return or add more time.

## Acceptance Criteria

1. App requests notification permission when timer is set
2. Notification fires 10 minutes before expiry (configurable in future)
3. Notification includes: "Meter expiring soon!" and spot address
4. Clicking notification opens the app to spot detail
5. Works on Chrome, Firefox, Edge, and Android browsers
6. If notification permission denied, inform user and suggest ICS fallback

## Tasks / Subtasks

- [ ] **Task 1: Create Notification Service** (AC: 1, 2, 3)
  - [ ] Create `apps/web/src/services/notification/notification.service.ts`
  - [ ] Create `apps/web/src/services/notification/types.ts`
  - [ ] `requestPermission()` - request browser permission
  - [ ] `getPermissionStatus()` - check current status
  - [ ] `scheduleNotification(spot, expiresAt)` - schedule timer
  - [ ] Write unit tests

- [ ] **Task 2: Create useNotification Hook** (AC: 1, 6)
  - [ ] Create `apps/web/src/hooks/useNotification/useNotification.ts`
  - [ ] Create `apps/web/src/hooks/useNotification/types.ts`
  - [ ] `requestPermission()` - with UI feedback
  - [ ] `isSupported` - check browser support
  - [ ] `permissionStatus` - current status
  - [ ] Write unit tests

- [ ] **Task 3: Service Worker for Notifications** (AC: 2, 4)
  - [ ] Update `apps/web/public/sw.js` (or create if not exists)
  - [ ] Handle scheduled notification display
  - [ ] Handle notification click → open app
  - [ ] Focus existing tab or open new one

- [ ] **Task 4: Schedule Notification on Timer Set** (AC: 2)
  - [ ] In MeterTimerInput, after timer saved
  - [ ] Calculate notification time (expiry - 10 minutes)
  - [ ] Use `setTimeout` or service worker
  - [ ] Store notification ID for cancellation

- [ ] **Task 5: Permission Request UI** (AC: 1, 6)
  - [ ] Create `apps/web/src/components/notification/NotificationPermissionPrompt.tsx`
  - [ ] Show when setting timer for first time
  - [ ] Explain why notifications are useful
  - [ ] Handle denied state gracefully
  - [ ] Suggest ICS fallback if denied

- [ ] **Task 6: Notification Click Handler** (AC: 4)
  - [ ] Service worker listens for `notificationclick`
  - [ ] Extract spotId from notification data
  - [ ] Open `/spot/:spotId` URL
  - [ ] Focus existing window if open

- [ ] **Task 7: Cancel Notification** (AC: 2)
  - [ ] Cancel when timer is cleared
  - [ ] Cancel when spot is deleted
  - [ ] Store notification timeout IDs in memory/storage

- [ ] **Task 8: Testing**
  - [ ] Test permission request flow
  - [ ] Test notification fires at correct time
  - [ ] Test click opens correct page
  - [ ] Test denied permission shows fallback
  - [ ] Write Playwright E2E tests (mock notifications)

## Dev Notes

### Architecture References

- [architecture-frontend/9-external-services.md](../architecture-frontend/9-external-services.md)
- [architecture-frontend/7-state-management.md](../architecture-frontend/7-state-management.md)

### Dependencies

- Story 4.3 (MeterTimerInput)
- Story 4.5 (ICS fallback when denied)

### Browser Support

| Browser          | Support         |
| ---------------- | --------------- |
| Chrome (Desktop) | ✅ Full         |
| Chrome (Android) | ✅ Full         |
| Firefox          | ✅ Full         |
| Edge             | ✅ Full         |
| Safari (macOS)   | ⚠️ Limited      |
| Safari (iOS)     | ❌ No (use ICS) |

### Notification Service Implementation

```typescript
// services/notification/notification.service.ts
const NOTIFICATION_LEAD_TIME = 10 * 60 * 1000; // 10 minutes

interface NotificationData {
  spotId: string;
  type: 'meter-expiring';
}

export const notificationService = {
  isSupported: (): boolean => {
    return 'Notification' in window && 'serviceWorker' in navigator;
  },

  getPermissionStatus: (): NotificationPermission | 'unsupported' => {
    if (!notificationService.isSupported()) return 'unsupported';
    return Notification.permission;
  },

  requestPermission: async (): Promise<NotificationPermission> => {
    if (!notificationService.isSupported()) {
      throw new Error('Notifications not supported');
    }
    return await Notification.requestPermission();
  },

  scheduleMeterNotification: (spot: Spot): number | null => {
    if (!spot.meterExpiresAt) return null;

    const expiresAt = new Date(spot.meterExpiresAt).getTime();
    const notifyAt = expiresAt - NOTIFICATION_LEAD_TIME;
    const delay = notifyAt - Date.now();

    if (delay <= 0) return null; // Already past notification time

    const timeoutId = window.setTimeout(() => {
      notificationService.showNotification(spot);
    }, delay);

    return timeoutId;
  },

  showNotification: async (spot: Spot): Promise<void> => {
    if (Notification.permission !== 'granted') return;

    const registration = await navigator.serviceWorker.ready;

    await registration.showNotification('Meter Expiring Soon!', {
      body: spot.address || 'Your parking meter expires in 10 minutes',
      icon: '/icons/icon-192.png',
      badge: '/icons/badge-72.png',
      tag: `meter-${spot.id}`,
      data: {
        spotId: spot.id,
        type: 'meter-expiring',
      } as NotificationData,
      requireInteraction: true,
      actions: [
        { action: 'view', title: 'View Spot' },
        { action: 'dismiss', title: 'Dismiss' },
      ],
    });
  },

  cancelNotification: (timeoutId: number): void => {
    clearTimeout(timeoutId);
  },
};
```

### Service Worker Notification Handler

```javascript
// public/sw.js
self.addEventListener('notificationclick', (event) => {
  const notification = event.notification;
  const data = notification.data;

  notification.close();

  if (event.action === 'dismiss') return;

  // Open or focus the app
  event.waitUntil(
    clients.matchAll({ type: 'window', includeUncontrolled: true }).then((clientList) => {
      // Try to find existing window
      for (const client of clientList) {
        if (client.url.includes(self.registration.scope)) {
          client.navigate(`/spot/${data.spotId}`);
          return client.focus();
        }
      }
      // Open new window
      return clients.openWindow(`/spot/${data.spotId}`);
    })
  );
});
```

### useNotification Hook

```typescript
// hooks/useNotification/useNotification.ts
export function useNotification() {
  const [permission, setPermission] = useState<NotificationPermission | 'unsupported'>(
    notificationService.getPermissionStatus()
  );

  const requestPermission = async () => {
    try {
      const result = await notificationService.requestPermission();
      setPermission(result);
      return result;
    } catch {
      setPermission('unsupported');
      return 'denied';
    }
  };

  return {
    isSupported: notificationService.isSupported(),
    permission,
    requestPermission,
    scheduleNotification: notificationService.scheduleMeterNotification,
    cancelNotification: notificationService.cancelNotification,
  };
}
```

### Permission Prompt Component

```tsx
// components/notification/NotificationPermissionPrompt.tsx
interface NotificationPermissionPromptProps {
  onGranted: () => void;
  onDenied: () => void;
}

export function NotificationPermissionPrompt({
  onGranted,
  onDenied,
}: NotificationPermissionPromptProps) {
  const { requestPermission, isSupported } = useNotification();

  const handleEnable = async () => {
    const result = await requestPermission();
    if (result === 'granted') {
      onGranted();
    } else {
      onDenied();
    }
  };

  if (!isSupported) {
    return (
      <div className="bg-yellow-50 p-4 rounded-lg">
        <p className="text-sm text-yellow-700">
          Browser notifications aren't supported.
          <button onClick={onDenied} className="underline ml-1">
            Use calendar reminder instead
          </button>
        </p>
      </div>
    );
  }

  return (
    <div className="bg-blue-50 p-4 rounded-lg">
      <h3 className="font-medium text-blue-800">Get Reminded</h3>
      <p className="text-sm text-blue-600 mt-1">
        Enable notifications to get alerted 10 minutes before your meter expires.
      </p>
      <div className="flex gap-2 mt-3">
        <Button onClick={handleEnable} size="sm">
          Enable Notifications
        </Button>
        <Button onClick={onDenied} variant="ghost" size="sm">
          No thanks
        </Button>
      </div>
    </div>
  );
}
```

### Integration with Timer Input

```tsx
// In ConfirmationPage or MeterTimerInput
const handleTimerSet = async (expiresAt: Date) => {
  // Save timer to spot
  await setMeterTimer(spotId, expiresAt);

  // Request notification permission if not granted
  if (permission === 'default') {
    setShowPermissionPrompt(true);
  } else if (permission === 'granted') {
    // Schedule notification
    const timeoutId = scheduleNotification(spot);
    // Store timeoutId for cleanup
  }
};
```

### File Locations

**New Files:**

- `apps/web/src/services/notification/notification.service.ts`
- `apps/web/src/services/notification/types.ts`
- `apps/web/src/hooks/useNotification/useNotification.ts`
- `apps/web/src/hooks/useNotification/types.ts`
- `apps/web/src/components/notification/NotificationPermissionPrompt.tsx`

**Modified Files:**

- `apps/web/public/sw.js` - add notification click handler
- `apps/web/src/pages/ConfirmationPage.tsx` - integrate permission prompt
- `apps/web/src/components/timer/MeterTimerInput.tsx` - schedule notification

### Testing Coverage

- Notification service: 90%
- useNotification hook: 95%
- Permission prompt: 90%
- Service worker handler: 80% (mocked)

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation | PO     |
