# Story 3.2: Navigate to Spot via Maps Deep Link

## Status

Approved

## Story

**As a** user,  
**I want** to tap "Navigate" and get walking directions in my preferred maps app,  
**so that** I can find my way back to my car.

## Acceptance Criteria

1. "Navigate" button appears on latest spot card and spot detail screen
2. Tapping opens a deep link to Google Maps or Apple Maps with walking directions
3. On iOS, prefer Apple Maps; on Android and others, prefer Google Maps
4. Deep link format: Google Maps: `https://www.google.com/maps/dir/?api=1&destination={lat},{lng}&travelmode=walking`
5. Deep link format: Apple Maps: `https://maps.apple.com/?daddr={lat},{lng}&dirflg=w`
6. If coordinates unavailable (address-only spot), use address in deep link
7. Works correctly on all supported browsers and platforms

## Tasks / Subtasks

- [ ] **Task 1: Create Navigation Service** (AC: 2, 3, 4, 5)
  - [ ] Create `apps/web/src/services/navigation/navigation.service.ts`
  - [ ] Create `apps/web/src/services/navigation/types.ts`
  - [ ] Implement `getNavigationUrl(spot)` - returns correct deep link
  - [ ] Detect platform (iOS vs other) using user agent
  - [ ] Generate Google Maps URL for non-iOS
  - [ ] Generate Apple Maps URL for iOS
  - [ ] Write unit tests

- [ ] **Task 2: Create useNavigation Hook** (AC: 1, 2)
  - [ ] Create `apps/web/src/hooks/useNavigation/useNavigation.ts`
  - [ ] Create `apps/web/src/hooks/useNavigation/types.ts`
  - [ ] Implement `navigateToSpot(spot)` - opens map URL
  - [ ] Use `window.open()` or `location.href` as appropriate
  - [ ] Track navigation events (optional analytics)
  - [ ] Write unit tests

- [ ] **Task 3: Platform Detection** (AC: 3)
  - [ ] Create `apps/web/src/utils/platform.ts`
  - [ ] Implement `isIOS()` - detect iOS devices
  - [ ] Implement `isAndroid()` - detect Android
  - [ ] Use `navigator.userAgent` or `navigator.platform`
  - [ ] Handle edge cases (iPadOS, etc.)
  - [ ] Write unit tests

- [ ] **Task 4: Address-Only Navigation** (AC: 6)
  - [ ] Handle spots without coordinates
  - [ ] Encode address for URL: `encodeURIComponent(address)`
  - [ ] Google Maps: `https://www.google.com/maps/dir/?api=1&destination={address}&travelmode=walking`
  - [ ] Apple Maps: `https://maps.apple.com/?daddr={address}&dirflg=w`
  - [ ] Test with various address formats

- [ ] **Task 5: Integrate Navigate Button** (AC: 1)
  - [ ] Update `LatestSpotCard` (Story 3.1) to use navigation
  - [ ] Will update `SpotDetailScreen` (Story 3.4)
  - [ ] Consistent button styling across locations
  - [ ] Show compass/navigation icon

- [ ] **Task 6: Cross-Platform Testing** (AC: 7)
  - [ ] Test on iOS Safari (should open Apple Maps)
  - [ ] Test on Android Chrome (should open Google Maps)
  - [ ] Test on desktop browsers
  - [ ] Test PWA installed mode
  - [ ] Document any platform-specific behaviors

- [ ] **Task 7: Testing**
  - [ ] Test URL generation for coordinates
  - [ ] Test URL generation for address-only
  - [ ] Test platform detection
  - [ ] Test button opens correct app
  - [ ] Write Playwright E2E tests (mock navigation)

## Dev Notes

### Architecture References

- [architecture-frontend/9-external-services.md](../architecture-frontend/9-external-services.md)

### Dependencies

- Story 3.1 (LatestSpotCard with Navigate button)
- Story 2.6 (address-only spots)

### Navigation Service Implementation

```typescript
// services/navigation/navigation.service.ts
import { isIOS } from '@/utils/platform';

interface NavigationTarget {
  lat?: number;
  lng?: number;
  address?: string;
}

export const navigationService = {
  getNavigationUrl: (target: NavigationTarget): string => {
    const useAppleMaps = isIOS();

    if (target.lat && target.lng) {
      // Coordinate-based navigation
      if (useAppleMaps) {
        return `https://maps.apple.com/?daddr=${target.lat},${target.lng}&dirflg=w`;
      }
      return `https://www.google.com/maps/dir/?api=1&destination=${target.lat},${target.lng}&travelmode=walking`;
    }

    if (target.address) {
      // Address-based navigation
      const encodedAddress = encodeURIComponent(target.address);
      if (useAppleMaps) {
        return `https://maps.apple.com/?daddr=${encodedAddress}&dirflg=w`;
      }
      return `https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}&travelmode=walking`;
    }

    throw new Error('No valid navigation target');
  },

  navigateTo: (target: NavigationTarget): void => {
    const url = navigationService.getNavigationUrl(target);
    window.open(url, '_blank');
  },
};
```

### Platform Detection

```typescript
// utils/platform.ts
export const isIOS = (): boolean => {
  const userAgent = navigator.userAgent || navigator.vendor;

  // Check for iOS devices
  if (/iPad|iPhone|iPod/.test(userAgent)) {
    return true;
  }

  // Check for iPadOS (reports as Mac but has touch)
  if (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1) {
    return true;
  }

  return false;
};

export const isAndroid = (): boolean => {
  return /Android/i.test(navigator.userAgent);
};

export const isMobile = (): boolean => {
  return isIOS() || isAndroid();
};
```

### useNavigation Hook

```typescript
// hooks/useNavigation/useNavigation.ts
import { navigationService } from '@/services/navigation/navigation.service';

export function useNavigation() {
  const navigateToSpot = (spot: Spot) => {
    navigationService.navigateTo({
      lat: spot.lat,
      lng: spot.lng,
      address: spot.address,
    });
  };

  return { navigateToSpot };
}
```

### Deep Link Formats

**Google Maps (Walking Directions):**

```
https://www.google.com/maps/dir/?api=1&destination=40.7128,-74.0060&travelmode=walking
https://www.google.com/maps/dir/?api=1&destination=123+Main+St+New+York&travelmode=walking
```

**Apple Maps (Walking Directions):**

```
https://maps.apple.com/?daddr=40.7128,-74.0060&dirflg=w
https://maps.apple.com/?daddr=123+Main+St+New+York&dirflg=w
```

**Parameters:**

- `daddr` / `destination` - Destination coordinates or address
- `dirflg=w` / `travelmode=walking` - Walking directions

### Navigate Button Component

```tsx
// components/spot/NavigateButton.tsx
import { useNavigation } from '@/hooks/useNavigation';
import { Compass } from 'lucide-react';

interface NavigateButtonProps {
  spot: Spot;
  variant?: 'primary' | 'secondary';
}

export function NavigateButton({ spot, variant = 'primary' }: NavigateButtonProps) {
  const { navigateToSpot } = useNavigation();

  const handleClick = () => {
    navigateToSpot(spot);
  };

  const isPrimary = variant === 'primary';

  return (
    <button
      onClick={handleClick}
      disabled={!spot.lat && !spot.lng && !spot.address}
      className={`flex items-center justify-center gap-2 h-12 rounded-lg font-medium ${
        isPrimary ? 'w-full bg-blue-500 text-white' : 'px-4 border border-blue-500 text-blue-500'
      }`}
    >
      <Compass className="w-5 h-5" />
      Navigate
    </button>
  );
}
```

### File Locations

**New Files:**

- `apps/web/src/services/navigation/navigation.service.ts`
- `apps/web/src/services/navigation/types.ts`
- `apps/web/src/hooks/useNavigation/useNavigation.ts`
- `apps/web/src/hooks/useNavigation/types.ts`
- `apps/web/src/utils/platform.ts`
- `apps/web/src/components/spot/NavigateButton.tsx`

**Modified Files:**

- `apps/web/src/components/spot/LatestSpotCard.tsx` - use NavigateButton

### Testing Coverage

- navigationService: 100%
- platform utils: 100%
- useNavigation: 95%
- NavigateButton: 90%

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation | PO     |
