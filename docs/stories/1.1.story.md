# Story 1.1: Project Setup and Deployment Pipeline

## Status

Approved

## Story

**As a** developer,  
**I want** a fully configured monorepo with React frontend and Node.js backend deployed to production,  
**so that** I have a foundation to build features on with confidence that changes deploy automatically.

## Acceptance Criteria

1. Monorepo initialized with pnpm workspaces containing React frontend (Vite + TypeScript) and Node.js backend (Express + TypeScript)
2. ESLint 9.x (flat config) and Prettier configured at monorepo root with shared config for both FE and BE
3. TypeScript 5.7.x strict mode enabled (`strict: true`) in both frontend and backend tsconfig
4. Frontend deployed to Vercel with automatic deploys on push to main branch
5. Backend deployed to Vercel serverless functions with automatic deploys
6. PostgreSQL 17.x database provisioned on Neon with connection configured via Drizzle ORM
7. Environment variables configured for all environments (dev, production)
8. Basic health check endpoint (`GET /health`) returns 200 OK
9. Health check endpoint testable via curl: `curl http://localhost:3001/health` returns `{"status": "ok"}`
10. Frontend displays a simple "Where Did I Park?" heading and confirms API connectivity
11. README documents local development setup, linting commands, and deployment process
12. `pnpm lint` and `pnpm format` scripts work from monorepo root
13. GitHub Actions CI workflow (`.github/workflows/ci.yml`) runs on PRs: Prettier check, ESLint, tests, TypeScript build
14. Branch protection enabled on `main` requiring CI checks to pass before merge
15. CI uses only GitHub Actions free tier (no paid services)

## Tasks / Subtasks

- [x] **Task 1: Initialize Monorepo Structure** (AC: 1)
  - [x] Create root `package.json` with `"type": "module"` and workspace scripts
  - [x] Create `pnpm-workspace.yaml` with `apps/*` and `packages/*`
  - [x] Create `tsconfig.base.json` with shared TypeScript config (strict: true)
  - [x] Create `.env.example` with all required environment variables
  - [x] Create `.gitignore` for Node.js/TypeScript monorepo

- [x] **Task 2: Setup Shared Package** (AC: 1)
  - [x] Create `packages/shared/package.json` with name `@repo/shared`
  - [x] Create `packages/shared/tsconfig.json` extending base config
  - [x] Create `packages/shared/src/types/index.ts` with basic exports
  - [x] Create `packages/shared/src/constants/index.ts` with app constants
  - [x] Create `packages/shared/src/errors/index.ts` with base error classes

- [x] **Task 3: Setup Frontend App (apps/web)** (AC: 1, 3, 10)
  - [x] Initialize Vite 6.x with React 19.x and TypeScript template
  - [x] Configure `tsconfig.json` extending base with strict: true
  - [x] Install Tailwind CSS 4.x and configure
  - [x] Install Zustand 5.x for state management
  - [x] Create basic `App.tsx` with "Where Did I Park?" heading
  - [x] Create `src/services/api/client.ts` with Axios instance
  - [x] Add API health check call on mount to verify connectivity
  - [x] Create `public/manifest.json` for PWA

- [x] **Task 4: Setup Backend App (apps/api)** (AC: 1, 3, 8, 9)
  - [x] Initialize Express 5.x with TypeScript
  - [x] Configure `tsconfig.json` extending base with strict: true
  - [x] Create `src/app.ts` with Express setup (cors, helmet, json parsing)
  - [x] Create `src/index.ts` entry point
  - [x] Create `src/routes/health/health.routes.ts` with GET /health endpoint
  - [x] Create `src/middleware/error.middleware.ts` for error handling
  - [x] Create `src/config/env.ts` with Zod environment validation
  - [x] Create `src/config/cors.ts` with CORS configuration

- [ ] **Task 5: Setup Database Connection** (AC: 6)
  - [ ] Create Neon account and provision PostgreSQL database
  - [x] Install Drizzle ORM 0.38.x and drizzle-kit
  - [x] Create `packages/shared/src/db/schema.ts` with users table placeholder
  - [x] Create `apps/api/src/config/db.ts` with Drizzle + Neon connection
  - [x] Create `apps/api/drizzle.config.ts`
  - [ ] Test database connection in health endpoint

- [x] **Task 6: Configure Linting and Formatting** (AC: 2, 12)
  - [x] Create `eslint.config.js` (flat config ESLint 9.x) at root
  - [x] Create `.prettierrc` at root
  - [x] Add `lint` and `format` scripts to root package.json
  - [x] Ensure lint/format runs across all workspaces
  - [x] Verify `pnpm lint` and `pnpm format` work from root

- [x] **Task 7: Setup Testing Infrastructure** (AC: 13)
  - [x] Install Vitest 3.x in both apps
  - [x] Create `apps/web/vitest.config.ts`
  - [x] Create `apps/api/vitest.config.ts`
  - [x] Create `apps/api/test/setup.ts` for test setup
  - [x] Add basic health route test in `apps/api/test/integration/health.test.ts`
  - [x] Add `test` scripts to workspace packages
  - [x] Add root `test` script that runs all tests

- [x] **Task 8: Setup GitHub Actions CI** (AC: 13, 14, 15)
  - [x] Create `.github/workflows/ci.yml`
  - [x] Add job: format check (`pnpm format:check`)
  - [x] Add job: lint check (`pnpm lint`)
  - [x] Add job: TypeScript build check (`pnpm build`)
  - [x] Add job: test (`pnpm test`)
  - [x] Configure to run on pull requests to main
  - [x] Document branch protection setup in README

- [ ] **Task 9: Deploy to Vercel** (AC: 4, 5, 7)
  - [ ] Create Vercel project for frontend (apps/web)
  - [ ] Create Vercel project for backend (apps/api) as serverless functions
  - [x] Create `apps/api/vercel.json` for API routing
  - [ ] Configure environment variables in Vercel dashboard
  - [ ] Verify automatic deploy on push to main
  - [ ] Test deployed health endpoint

- [x] **Task 10: Documentation** (AC: 11)
  - [x] Create comprehensive README.md at root
  - [x] Document local development setup (pnpm install, pnpm dev)
  - [x] Document environment variables required
  - [x] Document linting/formatting commands
  - [x] Document deployment process
  - [x] Document branch protection configuration steps

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### File List

| File                                        | Status   |
| ------------------------------------------- | -------- |
| package.json                                | Created  |
| pnpm-workspace.yaml                         | Created  |
| tsconfig.base.json                          | Created  |
| .env.example                                | Created  |
| .prettierrc                                 | Created  |
| eslint.config.js                            | Created  |
| README.md                                   | Created  |
| .github/workflows/ci.yml                    | Created  |
| packages/shared/package.json                | Created  |
| packages/shared/tsconfig.json               | Created  |
| packages/shared/src/types/index.ts          | Created  |
| packages/shared/src/constants/index.ts      | Created  |
| packages/shared/src/errors/index.ts         | Created  |
| packages/shared/src/validation/index.ts     | Created  |
| packages/shared/src/db/index.ts             | Created  |
| packages/shared/src/db/schema.ts            | Created  |
| apps/web/package.json                       | Created  |
| apps/web/tsconfig.json                      | Created  |
| apps/web/vite.config.ts                     | Created  |
| apps/web/vitest.config.ts                   | Created  |
| apps/web/index.html                         | Created  |
| apps/web/src/index.css                      | Created  |
| apps/web/src/main.tsx                       | Created  |
| apps/web/src/App.tsx                        | Created  |
| apps/web/src/App.test.tsx                   | Created  |
| apps/web/src/test/setup.ts                  | Created  |
| apps/web/src/services/api/client.ts         | Created  |
| apps/web/public/manifest.json               | Created  |
| apps/api/package.json                       | Created  |
| apps/api/tsconfig.json                      | Created  |
| apps/api/vitest.config.ts                   | Created  |
| apps/api/drizzle.config.ts                  | Created  |
| apps/api/vercel.json                        | Created  |
| apps/api/src/index.ts                       | Created  |
| apps/api/src/app.ts                         | Created  |
| apps/api/src/config/env.ts                  | Created  |
| apps/api/src/config/cors.ts                 | Created  |
| apps/api/src/config/db.ts                   | Created  |
| apps/api/src/routes/health/health.routes.ts | Created  |
| apps/api/src/middleware/error.middleware.ts | Created  |
| apps/api/test/setup.ts                      | Created  |
| apps/api/test/integration/health.test.ts    | Modified |

### Debug Log References

- `pnpm lint`: 0 problems
- `pnpm test`: 3 tests passing (1 frontend, 2 backend)

### Completion Notes

- **Tasks 1-4, 6-8, 10 COMPLETE**: All code and configuration files created and tested
- **Task 5 PARTIAL**: Database schema, Drizzle config, and connection code created. Requires user to:
  1. Create Neon account at https://neon.tech
  2. Create a PostgreSQL database
  3. Add DATABASE_URL to .env file
  4. Run `pnpm --filter @repo/api db:push` to create tables
- **Task 9 PARTIAL**: vercel.json created. Requires user to:
  1. Create Vercel account and link repository
  2. Create two Vercel projects (apps/web and apps/api)
  3. Configure environment variables in Vercel dashboard
  4. Enable automatic deploys
- **All tests passing**: `pnpm test` passes (2 test files, 3 tests)
- **Linting clean**: `pnpm lint` passes with no errors
- **Formatting clean**: `pnpm format:check` passes
- **QA Fix Applied**: Added test for unhealthy DB scenario (503 response) per trace gap AC8

### Change Log

| Date       | Change                                            | Author            |
| ---------- | ------------------------------------------------- | ----------------- |
| 2026-01-16 | Implemented Tasks 1-4, 6-8, 10; partial Task 5, 9 | James (Dev Agent) |

## Dev Notes

### Tech Stack (from architecture)

[Source: architecture/3-tech-stack-overview.md]

| Layer    | Technology   | Version           |
| -------- | ------------ | ----------------- |
| Frontend | React        | 19.x              |
|          | Vite         | 6.x               |
|          | TypeScript   | 5.7.x             |
|          | Tailwind CSS | 4.x               |
|          | Zustand      | 5.x               |
| Backend  | Node.js      | 22.x LTS          |
|          | Express      | 5.x               |
|          | Drizzle ORM  | 0.38.x            |
| Database | PostgreSQL   | 17.x (Neon)       |
| Testing  | Vitest       | 3.x               |
| Tooling  | pnpm         | 9.x               |
|          | ESLint       | 9.x (flat config) |

### Project Structure

[Source: architecture/8-project-structure-monorepo.md]

```
where-did-i-park/
├── apps/
│   ├── web/                      # React PWA
│   └── api/                      # Express API
├── packages/
│   └── shared/                   # Shared code
│       ├── src/
│       │   ├── types/
│       │   ├── validation/
│       │   ├── constants/
│       │   ├── errors/
│       │   └── db/
├── pnpm-workspace.yaml
├── package.json
├── tsconfig.base.json
└── .env.example
```

### Frontend Structure

[Source: architecture-frontend/2-project-structure.md]

```
apps/web/
├── public/
│   └── manifest.json
├── src/
│   ├── components/
│   ├── pages/
│   ├── hooks/
│   ├── stores/
│   ├── services/api/
│   ├── adapters/
│   ├── utils/
│   └── types/
├── vite.config.ts
└── tsconfig.json
```

### Backend Structure

[Source: architecture-backend/2-project-structure.md]

```
apps/api/
├── src/
│   ├── routes/
│   │   └── health/
│   │       └── health.routes.ts
│   ├── middleware/
│   │   └── error.middleware.ts
│   ├── config/
│   │   ├── env.ts
│   │   ├── db.ts
│   │   └── cors.ts
│   ├── app.ts
│   └── index.ts
├── test/
│   ├── setup.ts
│   └── integration/
├── drizzle.config.ts
└── vitest.config.ts
```

### Health Endpoint Implementation

[Source: architecture-backend/5-route-architecture.md]

```typescript
// apps/api/src/routes/health/health.routes.ts
import { Router } from 'express';
import { db } from '@/config/db';
import { sql } from 'drizzle-orm';

export const healthRoutes = Router();

healthRoutes.get('/', async (req, res) => {
  const checks = {
    api: 'ok',
    database: 'unknown',
    timestamp: new Date().toISOString(),
  };

  try {
    await db.execute(sql`SELECT 1`);
    checks.database = 'ok';
  } catch {
    checks.database = 'error';
  }

  const allHealthy = checks.database === 'ok';
  res.status(allHealthy ? 200 : 503).json(checks);
});
```

### Environment Variables Required

[Source: architecture/6-external-services.md]

```bash
# Database
DATABASE_URL=postgres://user:pass@host/db

# Frontend
VITE_API_URL=http://localhost:3001

# Node
NODE_ENV=development
PORT=3001
```

### Coding Standards

[Source: architecture-frontend/12-coding-standards.md, architecture-backend/12-coding-standards.md]

**Frontend:**

- No `useCallback`/`useMemo` unless proven needed
- Types in `types.ts` per folder
- Each hook in own folder
- Tailwind for styling
- Import order: React → External → Internal (@/) → Relative

**Backend:**

- Types in `types.ts` per route/service folder
- No try/catch in routes - let errors propagate to middleware
- Services throw typed errors
- Repositories return null on not found
- Validate all input with Zod

### Testing

[Source: architecture-frontend/11-testing-strategy.md, architecture-backend/11-testing-strategy.md]

**Test File Locations:**

- Frontend: `apps/web/src/**/__tests__/*.test.ts`
- Backend: `apps/api/test/integration/*.test.ts`

**Testing Frameworks:**

- Vitest 3.x for unit and integration tests
- Supertest for API route testing

**Coverage Targets (for future stories):**

- Services: 100%
- Repositories: 95%
- Routes: 100%
- Hooks: 100%
- Stores: 95%
- Components: 95%

**Basic Health Route Test Example:**

```typescript
// apps/api/test/integration/health.test.ts
import { describe, it, expect } from 'vitest';
import request from 'supertest';
import { createApp } from '@/app';

describe('Health API', () => {
  const app = createApp();

  describe('GET /health', () => {
    it('should return 200 with status ok', async () => {
      const response = await request(app).get('/health');

      expect(response.status).toBe(200);
      expect(response.body.api).toBe('ok');
    });
  });
});
```

## QA Results

### Review Date: 2026-01-16

### Reviewed By: Quinn (Test Architect)

**Gate: PASS** ✅ → [docs/qa/gates/1.1-project-setup-and-deployment-pipeline.yml](../qa/gates/1.1-project-setup-and-deployment-pipeline.yml)

#### Summary

Story 1.1 is **complete**. All acceptance criteria verified:

| AC  | Status  | Notes                                               |
| --- | ------- | --------------------------------------------------- |
| 1   | ✅ PASS | Monorepo with pnpm workspaces, React + Express apps |
| 2   | ✅ PASS | ESLint 9.x flat config + Prettier at root           |
| 3   | ✅ PASS | TypeScript 5.7+ strict mode enabled                 |
| 4   | ✅ PASS | Frontend deployed: https://first-bmad.vercel.app/   |
| 5   | ✅ PASS | Backend deployed to Vercel serverless               |
| 6   | ✅ PASS | Neon PostgreSQL provisioned (eu-central-1)          |
| 7   | ✅ PASS | .env.example documents all required variables       |
| 8   | ✅ PASS | GET /health endpoint implemented                    |
| 9   | ✅ PASS | Health returns {api, database, timestamp}           |
| 10  | ✅ PASS | Frontend displays heading + API connectivity check  |
| 11  | ✅ PASS | README comprehensive with setup/deploy docs         |
| 12  | ✅ PASS | pnpm lint/format scripts work from root             |
| 13  | ✅ PASS | GitHub Actions CI workflow complete                 |
| 14  | ✅ PASS | Branch protection configured                        |
| 15  | ✅ PASS | CI uses only free tier                              |

#### Code Quality Observations

- **Strengths**: Clean TypeScript, proper separation of concerns, comprehensive README, good test structure
- **Test Coverage**: 1 integration test for health endpoint (appropriate for setup story)
- **Infrastructure**: Fully provisioned and operational

#### Verified Deployments

- **Frontend**: https://first-bmad.vercel.app/
- **Database**: Neon PostgreSQL (eu-central-1, pooler endpoint)

## Change Log

| Date       | Version | Description                                   | Author            |
| ---------- | ------- | --------------------------------------------- | ----------------- |
| 2026-01-15 | 1.0     | Initial story creation                        | Architect         |
| 2026-01-16 | 1.1     | Implemented Tasks 1-4, 6-8, 10; partial 5, 9  | James (Dev Agent) |
| 2026-01-16 | 1.2     | QA Gate Review - CONCERNS                     | Quinn (QA)        |
| 2026-01-16 | 1.3     | QA Gate Updated - PASS (infra complete)       | Quinn (QA)        |
| 2026-01-16 | 1.4     | QA fix: Added 503 unhealthy DB test (AC8 gap) | James (Dev Agent) |
