# Story 4.3: Set Meter Timer

## Status

Approved

## Story

**As a** user with metered parking,  
**I want** to set a reminder for when my meter expires,  
**so that** I don't get a parking ticket.

## Acceptance Criteria

1. Confirmation screen shows "Set Timer" option
2. User can input duration (minutes) or select preset (30min, 1hr, 2hr)
3. Timer expiry time is calculated and saved with spot record
4. Timer countdown displays on spot detail and home screen
5. Meter expiry is stored as UTC timestamp
6. Timer is optional - most spots won't have one

## Tasks / Subtasks

- [ ] **Task 1: Update Spots Schema** (AC: 5)
  - [ ] Add `meterExpiresAt` column (nullable timestamp)
  - [ ] Run migration
  - [ ] Update Spot type definition
  - [ ] Write unit tests

- [ ] **Task 2: Backend - Update Spot Endpoint** (AC: 5, 6)
  - [ ] Modify `PATCH /v1/spots/:spotId` to accept `meterExpiresAt`
  - [ ] Validate timestamp is in future
  - [ ] Allow null to clear timer
  - [ ] Write integration tests

- [ ] **Task 3: Create Timer Input Component** (AC: 1, 2)
  - [ ] Create `apps/web/src/components/timer/MeterTimerInput.tsx`
  - [ ] Preset buttons: 30min, 1hr, 2hr
  - [ ] Custom input for minutes
  - [ ] Calculate expiry from now + duration
  - [ ] Clear button to remove timer

- [ ] **Task 4: Create Timer Display Component** (AC: 4)
  - [ ] Create `apps/web/src/components/timer/MeterTimerDisplay.tsx`
  - [ ] Show countdown: "1h 23m remaining"
  - [ ] Color code: green (>30min), yellow (10-30min), red (<10min)
  - [ ] Show "Expired" when past due
  - [ ] Update every minute

- [ ] **Task 5: Integrate Timer Input on Confirmation** (AC: 1, 2)
  - [ ] Add MeterTimerInput to ConfirmationPage
  - [ ] Optional section: "Set meter timer?"
  - [ ] Save timer when spot is saved
  - [ ] Skip if user doesn't set one

- [ ] **Task 6: Integrate Timer Display** (AC: 4)
  - [ ] Add to LatestSpotCard (Story 3.1)
  - [ ] Add to SpotDetailPage (Story 3.4)
  - [ ] Only show if meterExpiresAt is set
  - [ ] Update countdown in real-time

- [ ] **Task 7: Update Spot Store** (AC: 3)
  - [ ] Add `setMeterTimer(spotId, expiresAt)` action
  - [ ] Add `clearMeterTimer(spotId)` action
  - [ ] Update local state after save

- [ ] **Task 8: Guest Mode Timer** (AC: 5, 6)
  - [ ] Store meterExpiresAt in IndexedDB
  - [ ] Same display behavior
  - [ ] Write unit tests

- [ ] **Task 9: Testing**
  - [ ] Test preset buttons calculate correctly
  - [ ] Test custom input works
  - [ ] Test countdown updates
  - [ ] Test expired state
  - [ ] Test clearing timer
  - [ ] Write Playwright E2E tests

## Dev Notes

### Architecture References

- [architecture/5-api-specification.md](../architecture/5-api-specification.md)
- [architecture-frontend/6-component-hierarchy.md](../architecture-frontend/6-component-hierarchy.md)

### Dependencies

- Story 2.2 (ConfirmationPage)
- Story 3.1 (LatestSpotCard)
- Story 3.4 (SpotDetailPage)

### Database Migration

```typescript
// migrations/add_meter_expires_at.ts
export async function up(db: Database) {
  await db.schema
    .alterTable('spots')
    .addColumn('meter_expires_at', 'timestamp', (col) => col.nullable());
}

export async function down(db: Database) {
  await db.schema.alterTable('spots').dropColumn('meter_expires_at');
}
```

### API Endpoint

```bash
# Set meter timer
PATCH /api/v1/spots/:spotId
Authorization: Bearer <token>
Content-Type: application/json

{
  "meterExpiresAt": "2026-01-15T12:30:00Z"
}

# Clear meter timer
PATCH /api/v1/spots/:spotId
{
  "meterExpiresAt": null
}
```

### Meter Timer Input Component

```tsx
// components/timer/MeterTimerInput.tsx
interface MeterTimerInputProps {
  value?: Date;
  onChange: (expiresAt: Date | null) => void;
}

const PRESETS = [
  { label: '30 min', minutes: 30 },
  { label: '1 hour', minutes: 60 },
  { label: '2 hours', minutes: 120 },
];

export function MeterTimerInput({ value, onChange }: MeterTimerInputProps) {
  const [customMinutes, setCustomMinutes] = useState('');

  const handlePreset = (minutes: number) => {
    const expiresAt = new Date(Date.now() + minutes * 60 * 1000);
    onChange(expiresAt);
  };

  const handleCustom = () => {
    const minutes = parseInt(customMinutes, 10);
    if (minutes > 0) {
      const expiresAt = new Date(Date.now() + minutes * 60 * 1000);
      onChange(expiresAt);
    }
  };

  const handleClear = () => {
    onChange(null);
    setCustomMinutes('');
  };

  return (
    <div className="space-y-3">
      <label className="text-sm font-medium text-gray-700">Meter Timer (optional)</label>

      {/* Presets */}
      <div className="flex gap-2">
        {PRESETS.map((preset) => (
          <button
            key={preset.minutes}
            onClick={() => handlePreset(preset.minutes)}
            className="px-4 py-2 rounded-lg border hover:bg-gray-50"
          >
            {preset.label}
          </button>
        ))}
      </div>

      {/* Custom input */}
      <div className="flex gap-2">
        <input
          type="number"
          value={customMinutes}
          onChange={(e) => setCustomMinutes(e.target.value)}
          placeholder="Custom minutes"
          className="flex-1 px-3 py-2 border rounded-lg"
          min="1"
          max="1440"
        />
        <Button onClick={handleCustom} variant="secondary">
          Set
        </Button>
      </div>

      {/* Current timer */}
      {value && (
        <div className="flex items-center justify-between bg-blue-50 p-3 rounded-lg">
          <span className="text-sm">Timer set for {formatDateTime(value)}</span>
          <button onClick={handleClear} className="text-red-500 text-sm">
            Clear
          </button>
        </div>
      )}
    </div>
  );
}
```

### Meter Timer Display Component

```tsx
// components/timer/MeterTimerDisplay.tsx
interface MeterTimerDisplayProps {
  expiresAt: Date;
  size?: 'sm' | 'md' | 'lg';
}

export function MeterTimerDisplay({ expiresAt, size = 'md' }: MeterTimerDisplayProps) {
  const [timeLeft, setTimeLeft] = useState(calculateTimeLeft(expiresAt));

  useEffect(() => {
    const interval = setInterval(() => {
      setTimeLeft(calculateTimeLeft(expiresAt));
    }, 60000); // Update every minute

    return () => clearInterval(interval);
  }, [expiresAt]);

  const isExpired = timeLeft.totalMinutes <= 0;
  const isUrgent = timeLeft.totalMinutes <= 10;
  const isWarning = timeLeft.totalMinutes <= 30;

  const colorClass = isExpired
    ? 'text-red-600 bg-red-50'
    : isUrgent
      ? 'text-red-600 bg-red-50'
      : isWarning
        ? 'text-yellow-600 bg-yellow-50'
        : 'text-green-600 bg-green-50';

  return (
    <div className={`inline-flex items-center gap-1 px-2 py-1 rounded ${colorClass}`}>
      <Clock className="w-4 h-4" />
      <span className={size === 'sm' ? 'text-xs' : 'text-sm'}>
        {isExpired ? 'Expired' : formatTimeLeft(timeLeft)}
      </span>
    </div>
  );
}

function calculateTimeLeft(expiresAt: Date) {
  const diff = new Date(expiresAt).getTime() - Date.now();
  const totalMinutes = Math.floor(diff / 60000);
  const hours = Math.floor(totalMinutes / 60);
  const minutes = totalMinutes % 60;
  return { totalMinutes, hours, minutes };
}

function formatTimeLeft({ hours, minutes }: { hours: number; minutes: number }) {
  if (hours > 0) {
    return `${hours}h ${minutes}m`;
  }
  return `${minutes}m`;
}
```

### Integration in LatestSpotCard

```tsx
// In LatestSpotCard.tsx
{
  spot.meterExpiresAt && <MeterTimerDisplay expiresAt={new Date(spot.meterExpiresAt)} />;
}
```

### File Locations

**New Files:**

- `apps/web/src/components/timer/MeterTimerInput.tsx`
- `apps/web/src/components/timer/MeterTimerDisplay.tsx`
- `apps/api/src/migrations/add_meter_expires_at.ts`

**Modified Files:**

- `apps/api/src/schema/spots.ts` - add meterExpiresAt column
- `apps/api/src/routes/spots/spots.routes.ts` - handle meterExpiresAt in PATCH
- `apps/web/src/types/spot.ts` - add meterExpiresAt to Spot type
- `apps/web/src/pages/ConfirmationPage.tsx` - add timer input
- `apps/web/src/components/spot/LatestSpotCard.tsx` - add timer display
- `apps/web/src/pages/SpotDetailPage.tsx` - add timer display

### Testing Coverage

- MeterTimerInput: 95%
- MeterTimerDisplay: 90%
- Timer calculation: 100%
- Backend PATCH: 100%

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation | PO     |
