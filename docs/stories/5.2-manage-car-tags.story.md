# Story 5.2: Manage Car Tags

## Status

Approved

## Story

**As a** user,  
**I want** to create and manage custom car tags,  
**so that** I can organize my parking spots by vehicle.

## Acceptance Criteria

1. Accessible from Settings screen
2. Lists all car tags (default + custom)
3. User can add new custom tags
4. User can edit custom tag names
5. User can delete custom tags (default tags cannot be deleted)
6. Deleting a tag doesn't delete spots; spots keep the tag name as text
7. Changes sync to database for authenticated users

## Tasks / Subtasks

- [ ] **Task 1: Create Car Tags Management Page** (AC: 1, 2)
  - [ ] Create `apps/web/src/pages/ManageTagsPage.tsx`
  - [ ] Add route `/settings/tags` to router
  - [ ] Fetch and display all tags
  - [ ] Show default tags with badge/indicator

- [ ] **Task 2: Backend - CRUD Tags Endpoints** (AC: 3, 4, 5, 7)
  - [ ] Create `POST /v1/car-tags` - create new tag (extends Story 2.7)
  - [ ] Create `PATCH /v1/car-tags/:tagId` - update tag name
  - [ ] Create `DELETE /v1/car-tags/:tagId` - delete tag
  - [ ] Prevent deletion of default tags
  - [ ] Write integration tests

- [ ] **Task 3: Car Tags Schema Update** (AC: 2, 5)
  - [ ] Add `isDefault` boolean to car_tags table
  - [ ] Seed default tags: "My Car", "Rental", "Other" (align with Story 2.7)
  - [ ] Run migration
  - [ ] Write unit tests

- [ ] **Task 4: Car Tags Repository** (AC: 3, 4, 5, 7)
  - [ ] Create `apps/api/src/repositories/carTag.repository.ts`
  - [ ] `findByUserId(userId)` method
  - [ ] `create(userId, name)` method
  - [ ] `update(tagId, userId, name)` method
  - [ ] `delete(tagId, userId)` method - validate not default
  - [ ] Write unit tests

- [ ] **Task 5: Add Tag Form** (AC: 3)
  - [ ] Create `apps/web/src/components/tags/AddTagForm.tsx`
  - [ ] Text input for tag name
  - [ ] Validation: required, max length, unique
  - [ ] Submit creates new tag
  - [ ] Clear form after success

- [ ] **Task 6: Tag List Item Component** (AC: 2, 4, 5)
  - [ ] Create `apps/web/src/components/tags/TagListItem.tsx`
  - [ ] Display tag name
  - [ ] Edit button (inline edit or modal)
  - [ ] Delete button (disabled for defaults)
  - [ ] Show "Default" badge

- [ ] **Task 7: Delete Tag Confirmation** (AC: 5, 6)
  - [ ] Create confirmation dialog
  - [ ] Warn that spots keep tag name as text
  - [ ] Cancel and Delete buttons

- [ ] **Task 8: Update Car Tags Store** (AC: 3, 4, 5, 7)
  - [ ] Add CRUD actions to carTagsStore
  - [ ] `createTag(name)` action
  - [ ] `updateTag(tagId, name)` action
  - [ ] `deleteTag(tagId)` action
  - [ ] Handle optimistic updates

- [ ] **Task 9: Guest Mode Tags** (AC: 2, 3, 4, 5)
  - [ ] Store custom tags in IndexedDB
  - [ ] CRUD operations on local storage
  - [ ] Same UI behavior
  - [ ] Write unit tests

- [ ] **Task 10: Testing**
  - [ ] Test list displays all tags
  - [ ] Test add new tag
  - [ ] Test edit tag name
  - [ ] Test delete custom tag
  - [ ] Test cannot delete default tags
  - [ ] Write Playwright E2E tests

## Dev Notes

### Architecture References

- [architecture/5-api-specification.md](../architecture/5-api-specification.md)
- [architecture-frontend/7-state-management.md](../architecture-frontend/7-state-management.md)

### Dependencies

- Story 2.7 (car tags base functionality)
- Story 5.1 (Settings page)

### Database Schema Update

```typescript
// schema/carTags.ts
export const carTags = pgTable(
  'car_tags',
  {
    id: uuid('id').defaultRandom().primaryKey(),
    userId: uuid('user_id')
      .notNull()
      .references(() => users.id, { onDelete: 'cascade' }),
    name: varchar('name', { length: 50 }).notNull(),
    color: varchar('color', { length: 7 }).default('#3B82F6'),
    isDefault: boolean('is_default').default(false).notNull(),
    createdAt: timestamp('created_at').defaultNow().notNull(),
  },
  (table) => ({
    userNameUnique: uniqueIndex('car_tag_user_name_idx').on(table.userId, table.name),
  })
);
```

### API Endpoints

```bash
# Create tag
POST /api/v1/car-tags
Authorization: Bearer <token>
{ "name": "Second Car" }

# Response
{ "id": "uuid", "name": "Second Car", "isDefault": false }

# Update tag
PATCH /api/v1/car-tags/:tagId
{ "name": "Spouse's Car" }

# Delete tag
DELETE /api/v1/car-tags/:tagId

# Cannot delete default
HTTP 400
{ "error": "Cannot delete default tags" }
```

### Manage Tags Page Component

```tsx
// pages/ManageTagsPage.tsx
export function ManageTagsPage() {
  const { tags, isLoading, createTag, updateTag, deleteTag } = useCarTagsStore();
  const [editingId, setEditingId] = useState<string | null>(null);

  if (isLoading) return <LoadingScreen />;

  return (
    <div className="min-h-screen bg-gray-50">
      <header className="bg-white p-4 border-b flex items-center">
        <BackButton />
        <h1 className="text-xl font-bold ml-2">Manage Car Tags</h1>
      </header>

      <div className="p-4 space-y-4">
        <AddTagForm onAdd={createTag} />

        <div className="bg-white rounded-lg divide-y">
          {tags.map((tag) => (
            <TagListItem
              key={tag.id}
              tag={tag}
              isEditing={editingId === tag.id}
              onEdit={() => setEditingId(tag.id)}
              onSave={(name) => {
                updateTag(tag.id, name);
                setEditingId(null);
              }}
              onCancel={() => setEditingId(null)}
              onDelete={() => deleteTag(tag.id)}
            />
          ))}
        </div>

        <p className="text-sm text-gray-500 text-center">
          Deleting a tag won't delete your saved spots.
        </p>
      </div>
    </div>
  );
}
```

### Tag List Item Component

```tsx
// components/tags/TagListItem.tsx
interface TagListItemProps {
  tag: CarTag;
  isEditing: boolean;
  onEdit: () => void;
  onSave: (name: string) => void;
  onCancel: () => void;
  onDelete: () => void;
}

export function TagListItem({
  tag,
  isEditing,
  onEdit,
  onSave,
  onCancel,
  onDelete,
}: TagListItemProps) {
  const [name, setName] = useState(tag.name);

  if (isEditing) {
    return (
      <div className="p-4 flex items-center gap-2">
        <input
          value={name}
          onChange={(e) => setName(e.target.value)}
          className="flex-1 px-3 py-2 border rounded"
          autoFocus
        />
        <Button size="sm" onClick={() => onSave(name)}>
          Save
        </Button>
        <Button size="sm" variant="ghost" onClick={onCancel}>
          Cancel
        </Button>
      </div>
    );
  }

  return (
    <div className="p-4 flex items-center justify-between">
      <div className="flex items-center gap-3">
        <TagBadge name={tag.name} />
        {tag.isDefault && <span className="text-xs bg-gray-100 px-2 py-1 rounded">Default</span>}
      </div>

      <div className="flex items-center gap-2">
        <button onClick={onEdit} className="p-2 text-gray-400 hover:text-gray-600">
          <Pencil className="w-4 h-4" />
        </button>
        {!tag.isDefault && (
          <button onClick={onDelete} className="p-2 text-gray-400 hover:text-red-500">
            <Trash className="w-4 h-4" />
          </button>
        )}
      </div>
    </div>
  );
}
```

### File Locations

**New Files:**

- `apps/web/src/pages/ManageTagsPage.tsx`
- `apps/web/src/components/tags/AddTagForm.tsx`
- `apps/web/src/components/tags/TagListItem.tsx`
- `apps/api/src/repositories/carTag.repository.ts`
- `apps/api/src/routes/tags/tags.routes.ts`

**Modified Files:**

- `apps/api/src/schema/carTags.ts` - add isDefault column
- `apps/web/src/stores/carTagsStore.ts` - add CRUD actions
- `apps/web/src/router.tsx` - add /settings/tags route

### Testing Coverage

- ManageTagsPage: 90%
- Tag CRUD endpoints: 100%
- Tag components: 95%

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation | PO     |
