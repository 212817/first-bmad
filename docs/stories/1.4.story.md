# Story 1.4: Guest Mode

## Status

Approved

## Story

**As a** user who doesn't want to create an account,  
**I want** to use the app without signing in,  
**so that** I can quickly save my parking spot without friction.

## Acceptance Criteria

1. Login screen displays "Continue as Guest" option
2. Selecting Guest mode skips authentication and proceeds to home screen
3. Guest mode displays a persistent banner/indicator showing "Guest Mode - Data stored locally only"
4. App initializes IndexedDB for local storage
5. Guest users can access all spot-saving features (to be built in Epic 2)
6. A prompt encourages signing in to enable sync (non-blocking, dismissible)
7. Guest mode state persists across browser sessions until user signs in

## Tasks / Subtasks

- [ ] **Task 1: Create IndexedDB Storage Service** (AC: 4, 7)
  - [ ] Create `apps/web/src/services/storage/indexedDb.service.ts`
  - [ ] Create `apps/web/src/services/storage/types.ts`
  - [ ] Initialize database with name `wdip-local` and version `1`
  - [ ] Create object stores: `spots`, `settings`, `guestSession`
  - [ ] Implement `initDatabase()` - opens/creates IndexedDB
  - [ ] Implement `getItem<T>(store, key)` - generic getter
  - [ ] Implement `setItem<T>(store, key, value)` - generic setter
  - [ ] Implement `deleteItem(store, key)` - delete by key
  - [ ] Implement `getAllItems<T>(store)` - get all from store
  - [ ] Implement `clearStore(store)` - clear entire store
  - [ ] Add error handling with fallback awareness
  - [ ] Write unit tests for IndexedDB service

- [ ] **Task 2: Create Guest Session Management** (AC: 2, 7)
  - [ ] Create `apps/web/src/stores/guestStore.ts`
  - [ ] Add state: `isGuest: boolean`, `guestSessionId: string | null`
  - [ ] Implement `enterGuestMode()` - set guest flag, generate session ID
  - [ ] Implement `exitGuestMode()` - clear guest state
  - [ ] Persist guest state to IndexedDB on change
  - [ ] Hydrate guest state from IndexedDB on app load
  - [ ] Generate UUID for guest session ID (for future migration)
  - [ ] Write unit tests for guest store

- [ ] **Task 3: Update Auth Store for Guest Mode** (AC: 2, 7)
  - [ ] Update `apps/web/src/stores/authStore.ts`
  - [ ] Add `isGuest` derived state from guestStore
  - [ ] Modify `isAuthenticated` to include guest mode check
  - [ ] Add `authMode: 'authenticated' | 'guest' | 'none'`
  - [ ] Update `logout()` to also clear guest mode
  - [ ] Write unit tests for auth store guest integration

- [ ] **Task 4: Frontend - Guest Mode Button** (AC: 1)
  - [ ] Add "Continue as Guest" button to `LoginPage.tsx`
  - [ ] Create `GuestModeButton.tsx` component
  - [ ] Style to differentiate from OAuth buttons (secondary/outline style)
  - [ ] Position below OAuth buttons with visual separator
  - [ ] Handle click → call `guestStore.enterGuestMode()` → navigate to home

- [ ] **Task 5: Guest Mode Navigation** (AC: 2)
  - [ ] Update `useAuth` hook to support guest navigation
  - [ ] Modify route guards to allow guest users to access home
  - [ ] Implement redirect logic: guest enters → goes to home screen
  - [ ] Test navigation flow end-to-end

- [ ] **Task 6: Guest Mode Banner Component** (AC: 3)
  - [ ] Create `apps/web/src/components/ui/GuestModeBanner.tsx`
  - [ ] Create `apps/web/src/components/ui/types.ts` (if needed)
  - [ ] Display "Guest Mode - Data stored locally only" message
  - [ ] Use warning/info color scheme (amber/yellow)
  - [ ] Include icon (info or warning)
  - [ ] Add optional "Sign in to sync" link
  - [ ] Position as sticky banner at top or bottom of screen
  - [ ] Implement responsive design (compact on mobile)

- [ ] **Task 7: Integrate Banner into Layout** (AC: 3)
  - [ ] Update main layout component to conditionally render `GuestModeBanner`
  - [ ] Only show when `authMode === 'guest'`
  - [ ] Ensure banner doesn't interfere with main content
  - [ ] Test on various screen sizes

- [ ] **Task 8: Sign-In Prompt Component** (AC: 6)
  - [ ] Create `apps/web/src/components/prompts/SignInPrompt.tsx`
  - [ ] Create `apps/web/src/components/prompts/types.ts`
  - [ ] Design non-blocking modal/toast/card UI
  - [ ] Display benefits of signing in (sync across devices)
  - [ ] Include "Sign In" and "Dismiss" buttons
  - [ ] Implement dismiss logic with persistence (don't show again this session)
  - [ ] Store dismissal in IndexedDB settings

- [ ] **Task 9: Show Sign-In Prompt at Strategic Moments** (AC: 6)
  - [ ] Show prompt after first spot save (future: when Epic 2 complete)
  - [ ] Show prompt on 3rd app visit in guest mode
  - [ ] Track prompt displays to avoid annoyance
  - [ ] Respect dismissal preference
  - [ ] Create `useSignInPrompt` hook for logic

- [ ] **Task 10: Testing & Documentation**
  - [ ] Test guest mode persistence across browser refresh
  - [ ] Test guest mode persistence across browser close/reopen
  - [ ] Test transition from guest to signed-in state
  - [ ] Test IndexedDB quota handling
  - [ ] Document guest mode behavior in README
  - [ ] Add Playwright E2E tests for guest flow

## Dev Notes

### Previous Stories Context

- Story 1.2: Google OAuth with JWT tokens, auth store, useAuth hook
- Story 1.3: Apple Sign-In added as second provider

This story adds **guest mode** as third auth option. Guest users have no backend account - everything local via IndexedDB.

### Architecture References

[Source: architecture-frontend/7-state-management.md]

Guest mode uses:

- **IndexedDB** for persistence (not localStorage - better for structured data)
- **Zustand** store for runtime state (hydrated from IndexedDB)
- **Separate guestStore** to keep concerns clean

### Guest Mode Flow Diagram

```
┌────────────┐     ┌────────────┐     ┌────────────┐
│ Login Page │     │ guestStore │     │ IndexedDB  │
└─────┬──────┘     └─────┬──────┘     └─────┬──────┘
      │                  │                   │
      │ Click "Guest"    │                   │
      │─────────────────>│                   │
      │                  │                   │
      │                  │ enterGuestMode()  │
      │                  │──────────────────>│
      │                  │                   │
      │                  │ sessionId saved   │
      │                  │<──────────────────│
      │                  │                   │
      │ isGuest = true   │                   │
      │<─────────────────│                   │
      │                  │                   │
      │ Navigate to Home │                   │
      │─────────>        │                   │
```

### IndexedDB Schema

```typescript
// services/storage/types.ts

interface WDIPDatabase {
  spots: SpotStore;
  settings: SettingsStore;
  guestSession: GuestSessionStore;
}

interface SpotStore {
  // Key: spot ID (UUID)
  // Value: ParkingSpot object
  [spotId: string]: ParkingSpot;
}

interface SettingsStore {
  signInPromptDismissed?: boolean;
  signInPromptLastShown?: number;
  guestVisitCount?: number;
}

interface GuestSessionStore {
  isGuest: boolean;
  guestSessionId: string | null;
  createdAt: number;
}
```

### IndexedDB Service Implementation

```typescript
// services/storage/indexedDb.service.ts
const DB_NAME = 'wdip-local';
const DB_VERSION = 1;

const STORES = {
  spots: 'spots',
  settings: 'settings',
  guestSession: 'guestSession',
} as const;

export const indexedDbService = {
  db: null as IDBDatabase | null,

  init: async (): Promise<void> => {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, DB_VERSION);

      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        indexedDbService.db = request.result;
        resolve();
      };

      request.onupgradeneeded = (event) => {
        const db = (event.target as IDBOpenDBRequest).result;

        // Create object stores
        if (!db.objectStoreNames.contains(STORES.spots)) {
          db.createObjectStore(STORES.spots, { keyPath: 'id' });
        }
        if (!db.objectStoreNames.contains(STORES.settings)) {
          db.createObjectStore(STORES.settings);
        }
        if (!db.objectStoreNames.contains(STORES.guestSession)) {
          db.createObjectStore(STORES.guestSession);
        }
      };
    });
  },

  getItem: async <T>(store: string, key: string): Promise<T | null> => {
    // Implementation with transaction
  },

  setItem: async <T>(store: string, key: string, value: T): Promise<void> => {
    // Implementation with transaction
  },

  // ... other methods
};
```

### Guest Store Implementation

```typescript
// stores/guestStore.ts
import { create } from 'zustand';
import { indexedDbService } from '@/services/storage/indexedDb.service';

interface GuestState {
  isGuest: boolean;
  guestSessionId: string | null;
  createdAt: number | null;
}

interface GuestActions {
  enterGuestMode: () => Promise<void>;
  exitGuestMode: () => Promise<void>;
  hydrate: () => Promise<void>;
}

export const useGuestStore = create<GuestState & GuestActions>((set, get) => ({
  isGuest: false,
  guestSessionId: null,
  createdAt: null,

  enterGuestMode: async () => {
    const sessionId = crypto.randomUUID();
    const createdAt = Date.now();

    await indexedDbService.setItem('guestSession', 'current', {
      isGuest: true,
      guestSessionId: sessionId,
      createdAt,
    });

    set({ isGuest: true, guestSessionId: sessionId, createdAt });
  },

  exitGuestMode: async () => {
    await indexedDbService.deleteItem('guestSession', 'current');
    set({ isGuest: false, guestSessionId: null, createdAt: null });
  },

  hydrate: async () => {
    const session = await indexedDbService.getItem<GuestState>('guestSession', 'current');
    if (session?.isGuest) {
      set(session);
    }
  },
}));
```

### Guest Mode Button Styling

```tsx
// components/auth/GuestModeButton.tsx
export function GuestModeButton({ onClick }: { onClick: () => void }) {
  return (
    <button
      onClick={onClick}
      className="w-full h-12 border-2 border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors"
    >
      Continue as Guest
    </button>
  );
}
```

### Guest Mode Banner Styling

```tsx
// components/ui/GuestModeBanner.tsx
import { Info } from 'lucide-react';

export function GuestModeBanner() {
  return (
    <div className="sticky top-0 z-50 bg-amber-50 border-b border-amber-200 px-4 py-2">
      <div className="flex items-center justify-center gap-2 text-amber-800 text-sm">
        <Info className="w-4 h-4" />
        <span>Guest Mode - Data stored locally only</span>
        <a href="/login" className="ml-2 underline hover:text-amber-900">
          Sign in to sync
        </a>
      </div>
    </div>
  );
}
```

### Login Page Layout

```tsx
// pages/LoginPage.tsx (updated structure)
export function LoginPage() {
  return (
    <div className="flex flex-col items-center justify-center min-h-screen p-4">
      <h1 className="text-3xl font-bold mb-8">Where Did I Park?</h1>

      <div className="w-full max-w-sm space-y-4">
        {/* OAuth Buttons */}
        <GoogleLoginButton onClick={handleGoogleLogin} />
        <AppleLoginButton onClick={handleAppleLogin} />

        {/* Divider */}
        <div className="relative py-4">
          <div className="absolute inset-0 flex items-center">
            <div className="w-full border-t border-gray-300" />
          </div>
          <div className="relative flex justify-center">
            <span className="bg-white px-4 text-sm text-gray-500">or</span>
          </div>
        </div>

        {/* Guest Mode */}
        <GuestModeButton onClick={handleGuestMode} />
      </div>
    </div>
  );
}
```

### Sign-In Prompt Behavior

```typescript
// hooks/useSignInPrompt/useSignInPrompt.ts
export function useSignInPrompt() {
  const { isGuest } = useGuestStore();
  const [showPrompt, setShowPrompt] = useState(false);

  useEffect(() => {
    if (!isGuest) return;

    const checkPrompt = async () => {
      const settings = await indexedDbService.getItem<Settings>('settings', 'app');

      if (settings?.signInPromptDismissed) return;

      const visitCount = (settings?.guestVisitCount ?? 0) + 1;
      await indexedDbService.setItem('settings', 'app', {
        ...settings,
        guestVisitCount: visitCount,
      });

      // Show on 3rd visit
      if (visitCount >= 3) {
        setShowPrompt(true);
      }
    };

    checkPrompt();
  }, [isGuest]);

  const dismiss = async () => {
    setShowPrompt(false);
    await indexedDbService.setItem('settings', 'app', {
      signInPromptDismissed: true,
    });
  };

  return { showPrompt, dismiss };
}
```

### Auth Mode Integration

```typescript
// Updated authStore.ts concept
interface AuthState {
  user: User | null;
  isLoading: boolean;
}

interface AuthDerived {
  authMode: 'authenticated' | 'guest' | 'none';
  isAuthenticated: boolean; // true for both auth and guest
  canSync: boolean; // only true for authenticated
}

// Usage in components
const { authMode } = useAuthStore();

if (authMode === 'guest') {
  // Show guest banner
}
```

### File Locations

**New files:**

- `apps/web/src/services/storage/indexedDb.service.ts`
- `apps/web/src/services/storage/types.ts`
- `apps/web/src/stores/guestStore.ts`
- `apps/web/src/components/auth/GuestModeButton.tsx`
- `apps/web/src/components/ui/GuestModeBanner.tsx`
- `apps/web/src/components/prompts/SignInPrompt.tsx`
- `apps/web/src/components/prompts/types.ts`
- `apps/web/src/hooks/useSignInPrompt/useSignInPrompt.ts`
- `apps/web/src/hooks/useSignInPrompt/types.ts`

**Modified files:**

- `apps/web/src/stores/authStore.ts` - add guest integration
- `apps/web/src/pages/LoginPage.tsx` - add guest button
- `apps/web/src/layouts/MainLayout.tsx` - add guest banner

### Testing

**Coverage Targets:**

- IndexedDB service: 95%
- Guest store: 100%
- Guest components: 90%

**E2E Test Cases:**

```typescript
// e2e/guest-mode.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Guest Mode', () => {
  test('can enter guest mode from login', async ({ page }) => {
    await page.goto('/login');
    await page.click('text=Continue as Guest');

    await expect(page).toHaveURL('/');
    await expect(page.locator('text=Guest Mode')).toBeVisible();
  });

  test('guest state persists after refresh', async ({ page }) => {
    await page.goto('/login');
    await page.click('text=Continue as Guest');

    await page.reload();

    await expect(page.locator('text=Guest Mode')).toBeVisible();
  });
});
```

### Coding Standards Reminders

- Types in `types.ts` per folder
- Each hook in own folder
- No useCallback/useMemo unless proven needed
- Services throw typed errors

### Future Considerations (Post-MVP)

- Guest-to-account migration (merge local spots to account)
- Multi-device guest warning
- Storage quota management
- Offline sync queue for when guest signs in

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation | PO     |
