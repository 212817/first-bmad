# Story 3.4: Spot Detail Screen

## Status

Ready for Review

## Story

**As a** user,  
**I want** to view full details of a saved parking spot,  
**so that** I can see the photo, note, and navigate to it easily.

## Acceptance Criteria

1. Detail screen shows full photo (if present) at top
2. Displays address or coordinates prominently
3. Shows saved timestamp in human-readable format
4. Shows note text (if present)
5. Shows car tag badge
6. Navigate button launches native maps app
7. Share button visible (functionality in Epic 4)
8. Delete button visible with confirmation
9. Accessible via tapping spot from history list or home screen

## Tasks / Subtasks

- [x] **Task 1: Create Spot Detail Page** (AC: 1-6, 9)
  - [x] Create `apps/web/src/pages/SpotDetailPage.tsx`
  - [x] Add route `/spot/:spotId` to router
  - [x] Fetch spot data from store or API
  - [x] Handle loading state
  - [x] Handle spot not found (404)

- [x] **Task 2: Backend - Get Single Spot Endpoint** (AC: 9)
  - [x] Update or create `GET /v1/spots/:spotId` endpoint
  - [x] Validate user owns spot
  - [x] Return full spot data including photo URL
  - [x] Return 404 if not found
  - [x] Write integration tests

- [x] **Task 3: Photo Display** (AC: 1)
  - [x] Display full-width photo at top
  - [x] Handle missing photo gracefully
  - [x] Add tap-to-zoom functionality
  - [x] Show placeholder when no photo

- [x] **Task 4: Location Display** (AC: 2)
  - [x] Show address as primary text
  - [x] Show coordinates below address (smaller text)
  - [x] Copy to clipboard on tap
  - [x] Show toast on copy

- [x] **Task 5: Metadata Display** (AC: 3, 4, 5)
  - [x] Format timestamp: "Saved Jan 15, 2026 at 3:45 PM"
  - [x] Display note in styled card
  - [x] Display car tag badge
  - [x] Handle missing optional fields

- [x] **Task 6: Navigation Action** (AC: 6)
  - [x] Reuse navigation logic from Story 3.2
  - [x] Add prominent "Navigate" button
  - [x] Use primary button styling

- [x] **Task 7: Action Buttons** (AC: 7, 8)
  - [x] Add Share button placeholder (hidden until Epic 4, or show "Coming Soon" tooltip)
  - [x] Add Delete button (triggers Story 3.5)
  - [x] Use icon + label layout

- [x] **Task 8: Guest Mode Detail View** (AC: 9)
  - [x] Fetch from IndexedDB by spotId
  - [x] Same UI as authenticated
  - [x] Write unit tests

- [x] **Task 9: Testing**
  - [x] Test renders with all fields
  - [x] Test renders with missing photo
  - [x] Test renders with missing note
  - [x] Test navigation button works
  - [x] Test copy coordinates
  - [x] Write Playwright E2E tests

## Dev Notes

### Architecture References

- [architecture-frontend/6-component-hierarchy.md](../architecture-frontend/6-component-hierarchy.md)
- [architecture/5-api-specification.md](../architecture/5-api-specification.md)

### Dependencies

- Story 2.1 (spots schema)
- Story 3.2 (navigation service)
- Story 3.3 (navigates here from list)
- Story 3.5 (delete functionality)

### API Endpoint

```bash
# Get single spot
GET /api/v1/spots/:spotId
Authorization: Bearer <token>

# Response
{
  "id": "uuid-1",
  "lat": 40.7128,
  "lng": -74.006,
  "address": "Near Central Park",
  "photoUrl": "https://r2.domain.com/photos/uuid.jpg",
  "note": "By the big oak tree",
  "carTag": "My Car",
  "savedAt": "2026-01-15T15:45:00Z"
}

# 404 Response
{
  "error": "Spot not found"
}
```

### Spot Detail Page Component

```tsx
// pages/SpotDetailPage.tsx
import { useParams, useNavigate } from 'react-router-dom';
import { useSpotStore } from '@/stores/spotStore';
import { NavigationService } from '@/services/navigation.service';

export function SpotDetailPage() {
  const { spotId } = useParams<{ spotId: string }>();
  const navigate = useNavigate();
  const { getSpotById, isLoading } = useSpotStore();
  const [spot, setSpot] = useState<Spot | null>(null);

  useEffect(() => {
    if (spotId) {
      getSpotById(spotId).then(setSpot);
    }
  }, [spotId]);

  if (isLoading) {
    return <LoadingScreen />;
  }

  if (!spot) {
    return <NotFoundScreen message="Spot not found" />;
  }

  const handleNavigate = () => {
    NavigationService.navigate(spot.lat, spot.lng, spot.address);
  };

  const handleShare = () => {
    // Placeholder for Epic 4
  };

  const handleDelete = () => {
    navigate(`/spot/${spotId}/delete`);
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Photo Section */}
      <div className="relative">
        {spot.photoUrl ? (
          <SpotPhoto url={spot.photoUrl} className="w-full h-64 object-cover" />
        ) : (
          <div className="w-full h-48 bg-gray-200 flex items-center justify-center">
            <MapPin className="w-16 h-16 text-gray-400" />
          </div>
        )}
        <button
          onClick={() => navigate(-1)}
          className="absolute top-4 left-4 bg-white/80 p-2 rounded-full"
        >
          <ArrowLeft className="w-5 h-5" />
        </button>
      </div>

      {/* Content */}
      <div className="p-4 space-y-4">
        {/* Location */}
        <LocationCard address={spot.address} lat={spot.lat} lng={spot.lng} />

        {/* Metadata */}
        <div className="flex items-center justify-between">
          <time className="text-sm text-gray-500">Saved {formatDateTime(spot.savedAt)}</time>
          <TagBadge name={spot.carTag || 'My Car'} />
        </div>

        {/* Note */}
        {spot.note && (
          <div className="bg-white p-4 rounded-lg border">
            <p className="text-gray-700">{spot.note}</p>
          </div>
        )}

        {/* Actions */}
        <div className="space-y-3 pt-4">
          <Button onClick={handleNavigate} className="w-full" variant="primary">
            <Navigation className="w-5 h-5 mr-2" />
            Navigate
          </Button>

          <div className="flex gap-3">
            <Button onClick={handleShare} className="flex-1" variant="secondary" disabled>
              <Share className="w-5 h-5 mr-2" />
              Share
            </Button>
            <Button onClick={handleDelete} className="flex-1" variant="destructive">
              <Trash className="w-5 h-5 mr-2" />
              Delete
            </Button>
          </div>
        </div>
      </div>
    </div>
  );
}
```

### Location Card Component

```tsx
// components/spot/LocationCard.tsx
interface LocationCardProps {
  address?: string;
  lat: number;
  lng: number;
}

export function LocationCard({ address, lat, lng }: LocationCardProps) {
  const copyToClipboard = async () => {
    const text = address || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    await navigator.clipboard.writeText(text);
    toast.success('Copied to clipboard');
  };

  return (
    <button
      onClick={copyToClipboard}
      className="w-full text-left bg-white p-4 rounded-lg border hover:bg-gray-50"
    >
      <div className="flex items-start gap-3">
        <MapPin className="w-5 h-5 text-primary mt-1 shrink-0" />
        <div>
          {address ? (
            <>
              <p className="font-medium">{address}</p>
              <p className="text-sm text-gray-500">
                {lat.toFixed(6)}, {lng.toFixed(6)}
              </p>
            </>
          ) : (
            <p className="font-medium">
              {lat.toFixed(6)}, {lng.toFixed(6)}
            </p>
          )}
          <p className="text-xs text-gray-400 mt-1">Tap to copy</p>
        </div>
      </div>
    </button>
  );
}
```

### Spot Store Addition

```typescript
// stores/spotStore.ts - add to existing
getSpotById: async (spotId: string): Promise<Spot | null> => {
  // Check if we have it locally first
  const local = get().spots.find((s) => s.id === spotId);
  if (local) return local;

  // If guest mode, fetch from IndexedDB
  const { user } = useAuthStore.getState();
  if (!user) {
    return await IndexedDBService.getSpot(spotId);
  }

  // Fetch from API
  try {
    const response = await apiClient.get(`/v1/spots/${spotId}`);
    return response.data;
  } catch (error) {
    if (error.response?.status === 404) {
      return null;
    }
    throw error;
  }
};
```

### File Locations

**New Files:**

- `apps/web/src/pages/SpotDetailPage.tsx`
- `apps/web/src/components/spot/LocationCard.tsx`
- `apps/web/src/components/spot/SpotPhoto.tsx`

**Modified Files:**

- `apps/api/src/routes/spots/spots.routes.ts` - add GET :spotId
- `apps/web/src/stores/spotStore.ts` - add getSpotById
- `apps/web/src/router.tsx` - add /spot/:spotId route
- `apps/web/src/services/indexeddb.service.ts` - add getSpot

### Testing Coverage

- SpotDetailPage: 90%
- LocationCard: 95%
- SpotPhoto: 90%
- GET endpoint: 100%

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### File List

**New Files:**

- `apps/web/src/pages/SpotDetailPage.tsx` - Spot detail page component
- `apps/web/src/components/spot/LocationCard.tsx` - Location display with copy-to-clipboard
- `apps/web/src/components/spot/SpotPhoto.tsx` - Photo display with tap-to-zoom
- `apps/web/src/pages/__tests__/SpotDetailPage.test.tsx` - Unit tests for SpotDetailPage
- `apps/web/src/components/spot/__tests__/LocationCard.test.tsx` - Unit tests for LocationCard
- `apps/web/src/components/spot/__tests__/SpotPhoto.test.tsx` - Unit tests for SpotPhoto
- `apps/web/e2e/spot-detail.spec.ts` - E2E tests for spot detail page

**Modified Files:**

- `apps/web/src/App.tsx` - Added /spot/:spotId route and SpotDetailPage import
- `apps/web/src/stores/spotStore.ts` - Added getSpotById method
- `apps/web/src/stores/spot.types.ts` - Added getSpotById to SpotActions interface
- `apps/web/src/components/spot/index.ts` - Added LocationCard and SpotPhoto exports
- `apps/web/src/utils/formatters.ts` - Added formatDateTime function

### Debug Log References

N/A

### Completion Notes

- All 9 tasks completed successfully
- 613 unit tests passing (web)
- 245 integration tests passing (api)
- 11 new E2E tests passing for spot detail page
- Backend endpoint `GET /spots/:id` already existed with full functionality

## Change Log

| Date       | Version | Description             | Author    |
| ---------- | ------- | ----------------------- | --------- |
| 2026-01-15 | 1.0     | Initial story creation  | PO        |
| 2026-02-03 | 1.1     | Implementation complete | Dev Agent |
