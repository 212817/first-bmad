# Story 3.6: Search and Filter Spot History

## Status

Approved

## Story

**As a** user,  
**I want** to search and filter my parking history,  
**so that** I can quickly find a specific saved location.

## Acceptance Criteria

1. Search input visible on history screen
2. Search filters spots by address, note, or car tag
3. Search is case-insensitive
4. Date range filter available (optional)
5. Car tag filter dropdown available
6. Filters can be combined
7. Results update as user types (debounced)
8. "No results" message when nothing matches
9. Clear filters button resets to show all spots
10. For authenticated users, filtering happens server-side
11. For guests, filtering happens client-side on IndexedDB data

## Tasks / Subtasks

- [ ] **Task 0: Install Dependencies** (prerequisite)
  - [ ] `npm install use-debounce`

- [ ] **Task 1: Create Search Input Component** (AC: 1, 7)
  - [ ] Create `apps/web/src/components/spot/SpotSearchInput.tsx`
  - [ ] Search icon on left
  - [ ] Clear button when has value
  - [ ] Debounce input (300ms)
  - [ ] Auto-focus option

- [ ] **Task 2: Create Filter Dropdown** (AC: 4, 5)
  - [ ] Create `apps/web/src/components/spot/SpotFilters.tsx`
  - [ ] Car tag dropdown (show user's tags)
  - [ ] Date range picker (optional enhancement)
  - [ ] Filter icon button to expand

- [ ] **Task 3: Backend - Add Search Query Params** (AC: 10)
  - [ ] Update `GET /v1/spots` endpoint
  - [ ] Add `q` param for text search
  - [ ] Add `carTag` param for tag filter
  - [ ] Add `startDate` / `endDate` params (optional)
  - [ ] Search across address, note fields
  - [ ] Use ILIKE for case-insensitive search
  - [ ] Write integration tests

- [ ] **Task 4: Update Spot Repository** (AC: 10)
  - [ ] Update `findByUserId` with search options
  - [ ] Build dynamic where clause
  - [ ] Handle null address/note gracefully
  - [ ] Write unit tests

- [ ] **Task 5: Update Spot Store** (AC: 7)
  - [ ] Add `searchQuery: string` state
  - [ ] Add `filters: SpotFilters` state
  - [ ] Add `setSearchQuery(q)` action
  - [ ] Add `setFilters(filters)` action
  - [ ] Re-fetch spots when search/filters change
  - [ ] Write unit tests

- [ ] **Task 6: Client-Side Filtering (Guest Mode)** (AC: 11)
  - [ ] Implement `filterSpots(spots, query, filters)` utility
  - [ ] Case-insensitive matching
  - [ ] Filter on address, note, carTag
  - [ ] Support date range
  - [ ] Write unit tests

- [ ] **Task 7: Integrate Search in History Page** (AC: 1-9)
  - [ ] Add SpotSearchInput above list
  - [ ] Add filter button/dropdown
  - [ ] Show "No results" empty state
  - [ ] Show "Clear filters" when filtered
  - [ ] Preserve search on navigation

- [ ] **Task 8: No Results State** (AC: 8)
  - [ ] Create specific empty state for search
  - [ ] Message: "No spots matching your search"
  - [ ] Different from "No spots saved yet"

- [ ] **Task 9: Testing**
  - [ ] Test search filters results
  - [ ] Test tag filter works
  - [ ] Test combined filters
  - [ ] Test clear filters
  - [ ] Test no results state
  - [ ] Test debounce behavior
  - [ ] Write Playwright E2E tests

## Dev Notes

### Architecture References

- [architecture-frontend/6-component-hierarchy.md](../architecture-frontend/6-component-hierarchy.md)
- [architecture/5-api-specification.md](../architecture/5-api-specification.md)

### Dependencies

- Story 2.7 (car tags)
- Story 3.3 (HistoryPage, SpotList)

### API Endpoint (Updated)

```bash
# Search spots
GET /api/v1/spots?q=park&carTag=work&limit=20
Authorization: Bearer <token>

# Query params
# - q: text search (searches address, note)
# - carTag: filter by tag name
# - startDate: ISO date (optional)
# - endDate: ISO date (optional)
# - limit: pagination limit
# - cursor: pagination cursor

# Response (same structure as Story 3.3)
{
  "spots": [...],
  "nextCursor": "..."
}
```

### Search Input Component

```tsx
// components/spot/SpotSearchInput.tsx
import { useEffect, useState } from 'react';
import { useDebouncedCallback } from 'use-debounce';
import { Search, X } from 'lucide-react';

interface SpotSearchInputProps {
  value: string;
  onChange: (value: string) => void;
  placeholder?: string;
}

export function SpotSearchInput({ value, onChange, placeholder }: SpotSearchInputProps) {
  const [localValue, setLocalValue] = useState(value);

  const debouncedOnChange = useDebouncedCallback((val: string) => {
    onChange(val);
  }, 300);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setLocalValue(e.target.value);
    debouncedOnChange(e.target.value);
  };

  const handleClear = () => {
    setLocalValue('');
    onChange('');
  };

  return (
    <div className="relative">
      <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
      <input
        type="text"
        value={localValue}
        onChange={handleChange}
        placeholder={placeholder || 'Search spots...'}
        className="w-full pl-10 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-primary/50"
      />
      {localValue && (
        <button
          onClick={handleClear}
          className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
        >
          <X className="w-5 h-5" />
        </button>
      )}
    </div>
  );
}
```

### Filter Dropdown Component

```tsx
// components/spot/SpotFilters.tsx
import { useState } from 'react';
import { Filter, ChevronDown } from 'lucide-react';
import { useCarTagsStore } from '@/stores/carTagsStore';

interface SpotFiltersProps {
  selectedTag?: string;
  onTagChange: (tag: string | undefined) => void;
}

export function SpotFilters({ selectedTag, onTagChange }: SpotFiltersProps) {
  const [open, setOpen] = useState(false);
  const { tags } = useCarTagsStore();

  return (
    <div className="relative">
      <button
        onClick={() => setOpen(!open)}
        className="flex items-center gap-2 px-3 py-2 border rounded-lg hover:bg-gray-50"
      >
        <Filter className="w-4 h-4" />
        <span>{selectedTag || 'All tags'}</span>
        <ChevronDown className="w-4 h-4" />
      </button>

      {open && (
        <div className="absolute top-full mt-1 right-0 bg-white border rounded-lg shadow-lg min-w-[150px] z-10">
          <button
            onClick={() => {
              onTagChange(undefined);
              setOpen(false);
            }}
            className="w-full px-4 py-2 text-left hover:bg-gray-50"
          >
            All tags
          </button>
          {tags.map((tag) => (
            <button
              key={tag.name}
              onClick={() => {
                onTagChange(tag.name);
                setOpen(false);
              }}
              className="w-full px-4 py-2 text-left hover:bg-gray-50 flex items-center gap-2"
            >
              <div className="w-3 h-3 rounded-full" style={{ backgroundColor: tag.color }} />
              {tag.name}
            </button>
          ))}
        </div>
      )}
    </div>
  );
}
```

### Updated Repository with Search

```typescript
// repositories/spot.repository.ts
interface FindOptions {
  limit?: number;
  cursor?: string;
  searchQuery?: string;
  carTag?: string;
  startDate?: string;
  endDate?: string;
}

findByUserId: async (userId: string, options: FindOptions = {}) => {
  const { limit = 20, cursor, searchQuery, carTag, startDate, endDate } = options;

  let query = db
    .select()
    .from(spots)
    .where(eq(spots.userId, userId))
    .orderBy(desc(spots.savedAt))
    .limit(limit + 1);

  // Cursor pagination
  if (cursor) {
    query = query.where(lt(spots.savedAt, new Date(cursor)));
  }

  // Text search
  if (searchQuery) {
    const searchLower = `%${searchQuery.toLowerCase()}%`;
    query = query.where(
      or(
        sql`LOWER(${spots.address}) LIKE ${searchLower}`,
        sql`LOWER(${spots.note}) LIKE ${searchLower}`
      )
    );
  }

  // Car tag filter
  if (carTag) {
    query = query.where(eq(spots.carTag, carTag));
  }

  // Date range
  if (startDate) {
    query = query.where(gte(spots.savedAt, new Date(startDate)));
  }
  if (endDate) {
    query = query.where(lte(spots.savedAt, new Date(endDate)));
  }

  const results = await query;

  const hasMore = results.length > limit;
  const items = hasMore ? results.slice(0, -1) : results;
  const nextCursor = hasMore ? items[items.length - 1].savedAt : null;

  return { spots: items, nextCursor };
};
```

### Client-Side Filter Utility

```typescript
// utils/filterSpots.ts
interface FilterOptions {
  query?: string;
  carTag?: string;
  startDate?: Date;
  endDate?: Date;
}

export function filterSpots(spots: Spot[], options: FilterOptions): Spot[] {
  const { query, carTag, startDate, endDate } = options;

  return spots.filter((spot) => {
    // Text search
    if (query) {
      const q = query.toLowerCase();
      const matchesAddress = spot.address?.toLowerCase().includes(q);
      const matchesNote = spot.note?.toLowerCase().includes(q);
      const matchesTag = spot.carTag?.toLowerCase().includes(q);

      if (!matchesAddress && !matchesNote && !matchesTag) {
        return false;
      }
    }

    // Car tag filter
    if (carTag && spot.carTag !== carTag) {
      return false;
    }

    // Date range
    const savedAt = new Date(spot.savedAt);
    if (startDate && savedAt < startDate) {
      return false;
    }
    if (endDate && savedAt > endDate) {
      return false;
    }

    return true;
  });
}
```

### Updated History Page

```tsx
// pages/HistoryPage.tsx
export function HistoryPage() {
  const navigate = useNavigate();
  const {
    spots,
    hasMore,
    isLoading,
    searchQuery,
    filters,
    fetchSpots,
    loadMore,
    setSearchQuery,
    setFilters,
  } = useSpotStore();

  useEffect(() => {
    fetchSpots();
  }, [searchQuery, filters]);

  const hasActiveFilters = searchQuery || filters.carTag;

  const handleClearFilters = () => {
    setSearchQuery('');
    setFilters({});
  };

  return (
    <div className="min-h-screen">
      <header className="sticky top-0 bg-white border-b p-4">
        <h1 className="text-xl font-bold mb-3">Spot History</h1>

        <div className="flex gap-2">
          <SpotSearchInput value={searchQuery} onChange={setSearchQuery} />
          <SpotFilters
            selectedTag={filters.carTag}
            onTagChange={(tag) => setFilters({ ...filters, carTag: tag })}
          />
        </div>
      </header>

      {isLoading && spots.length === 0 ? (
        <LoadingScreen />
      ) : spots.length === 0 ? (
        hasActiveFilters ? (
          <NoResultsState onClear={handleClearFilters} />
        ) : (
          <EmptySpotState />
        )
      ) : (
        <>
          {hasActiveFilters && (
            <div className="p-2 bg-gray-50 flex justify-between items-center">
              <span className="text-sm text-gray-600">
                {spots.length} result{spots.length !== 1 ? 's' : ''}
              </span>
              <button onClick={handleClearFilters} className="text-sm text-primary">
                Clear filters
              </button>
            </div>
          )}
          <SpotList
            spots={spots}
            hasMore={hasMore}
            loadMore={loadMore}
            onSpotClick={(spot) => navigate(`/spot/${spot.id}`)}
          />
        </>
      )}
    </div>
  );
}
```

### No Results State

```tsx
// components/spot/NoResultsState.tsx
interface NoResultsStateProps {
  onClear: () => void;
}

export function NoResultsState({ onClear }: NoResultsStateProps) {
  return (
    <div className="flex flex-col items-center justify-center p-8 text-center">
      <Search className="w-12 h-12 text-gray-300 mb-4" />
      <h2 className="text-lg font-medium text-gray-700">No spots found</h2>
      <p className="text-gray-500 mt-1">Try adjusting your search or filters</p>
      <button onClick={onClear} className="mt-4 text-primary font-medium">
        Clear filters
      </button>
    </div>
  );
}
```

### File Locations

**New Files:**

- `apps/web/src/components/spot/SpotSearchInput.tsx`
- `apps/web/src/components/spot/SpotFilters.tsx`
- `apps/web/src/components/spot/NoResultsState.tsx`
- `apps/web/src/utils/filterSpots.ts`

**Modified Files:**

- `apps/api/src/routes/spots/spots.routes.ts` - add search params
- `apps/api/src/repositories/spot.repository.ts` - add search logic
- `apps/web/src/stores/spotStore.ts` - add search/filter state
- `apps/web/src/pages/HistoryPage.tsx` - integrate search/filter

### Dependencies (npm)

```json
{
  "use-debounce": "^10.0.4"
}
```

### Testing Coverage

- SpotSearchInput: 95%
- SpotFilters: 90%
- NoResultsState: 100%
- filterSpots utility: 100%
- Server search: 95%

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation | PO     |
