# Story 2.1: Capture and Save GPS Location

## Status

Approved

## Story

**As a** user,  
**I want** to save my current location with one tap,  
**so that** I can quickly mark where I parked.

## Acceptance Criteria

1. Home screen displays a prominent "Save my spot" button
2. Tapping the button requests location permission (with clear value message)
3. If permission granted, captures latitude, longitude, and accuracy from Geolocation API
4. Saves spot to database (authenticated) or IndexedDB (guest) with timestamp
5. If location permission denied, displays fallback option (manual address entry - Story 2.6)
6. Shows loading indicator while capturing location
7. Spot data includes: id, user_id, lat, lng, accuracy_meters, saved_at (UTC)
8. After successful save, proceeds to confirmation screen
9. API endpoint `POST /api/spots` testable via curl with JSON body: `{"lat": 40.7128, "lng": -74.0060}`

## Tasks / Subtasks

- [ ] **Task 1: Create Spots Database Schema** (AC: 7)
  - [ ] Create `apps/api/src/db/schema/spots.ts`
  - [ ] Define `spots` table with Drizzle ORM:
    - `id` (UUID, primary key)
    - `userId` (UUID, foreign key to users, nullable for migration)
    - `lat` (decimal, precision 9, scale 6)
    - `lng` (decimal, precision 9, scale 6)
    - `accuracyMeters` (integer, nullable)
    - `photoUrl` (text, nullable)
    - `note` (text, nullable, max 500)
    - `carTag` (text, nullable)
    - `address` (text, nullable)
    - `savedAt` (timestamp with timezone)
    - `createdAt`, `updatedAt` (timestamps)
  - [ ] Add index on `userId` + `savedAt` for history queries
  - [ ] Generate and run migration
  - [ ] Write schema tests

- [ ] **Task 2: Create Spots Repository** (AC: 4, 7)
  - [ ] Create `apps/api/src/repositories/spot.repository.ts`
  - [ ] Create `apps/api/src/repositories/spot.types.ts`
  - [ ] Implement `create(userId, spotData)` - insert new spot
  - [ ] Implement `findById(id)` - get single spot
  - [ ] Implement `findByUserId(userId, limit)` - get user's spots
  - [ ] Implement `update(id, data)` - update spot fields
  - [ ] Implement `delete(id)` - soft delete spot
  - [ ] Write unit tests for repository

- [ ] **Task 3: Create Spots API Routes** (AC: 4, 8, 9)
  - [ ] Create `apps/api/src/routes/spots/spots.routes.ts`
  - [ ] Create `apps/api/src/routes/spots/spots.service.ts`
  - [ ] Create `apps/api/src/routes/spots/types.ts`
  - [ ] Add `POST /v1/spots` - create new spot
  - [ ] Add request validation (lat: -90 to 90, lng: -180 to 180)
  - [ ] Return created spot with 201 status
  - [ ] Require authentication middleware
  - [ ] Register routes in main router
  - [ ] Write integration tests

- [ ] **Task 4: Create Geolocation Hook** (AC: 2, 3, 6)
  - [ ] Create `apps/web/src/hooks/useGeolocation/useGeolocation.ts`
  - [ ] Create `apps/web/src/hooks/useGeolocation/types.ts`
  - [ ] Implement `getCurrentPosition()` - wrapper for Geolocation API
  - [ ] Handle permission states: prompt, granted, denied
  - [ ] Return loading, error, and position states
  - [ ] Implement accuracy threshold check (warn if >100m)
  - [ ] Set timeout for location request (10 seconds)
  - [ ] Write unit tests with mocked Geolocation API

- [ ] **Task 5: Create Spots Store** (AC: 4)
  - [ ] Create `apps/web/src/stores/spotStore.ts`
  - [ ] Create `apps/web/src/stores/spot.types.ts`
  - [ ] Add state: `currentSpot`, `isLoading`, `error`
  - [ ] Implement `saveSpot(position)` - call API or IndexedDB
  - [ ] Implement optimistic updates with rollback
  - [ ] Detect auth mode and route to correct storage
  - [ ] Write unit tests

- [ ] **Task 6: Update IndexedDB Service for Spots** (AC: 4)
  - [ ] Update `indexedDb.service.ts` to handle spots store
  - [ ] Implement `saveSpot(spot)` for guest mode
  - [ ] Implement `getSpots(limit)` for guest history
  - [ ] Ensure spot schema matches API model
  - [ ] Write unit tests for guest spot storage

- [ ] **Task 7: Create Home Screen with Save Button** (AC: 1, 2, 5)
  - [ ] Create `apps/web/src/pages/HomePage.tsx`
  - [ ] Create large, prominent "Save my spot" button
  - [ ] Style with primary color, centered, touch-friendly (min 48px)
  - [ ] Add parking icon or car emoji for visual clarity
  - [ ] On click: trigger geolocation capture
  - [ ] Show permission prompt with value message first time

- [ ] **Task 8: Location Permission UX** (AC: 2, 5)
  - [ ] Create `apps/web/src/components/prompts/LocationPermissionPrompt.tsx`
  - [ ] Display before browser permission dialog
  - [ ] Explain why location is needed
  - [ ] Provide "Enable Location" and "Enter Manually" options
  - [ ] Remember if user chose manual entry

- [ ] **Task 9: Loading and Success States** (AC: 6, 8)
  - [ ] Show spinner/loading while capturing location
  - [ ] Show spinner while saving to API/IndexedDB
  - [ ] On success, navigate to confirmation screen (Story 2.2)
  - [ ] Animate transition for smooth UX

- [ ] **Task 10: Error Handling** (AC: 5)
  - [ ] Handle location timeout (>10s)
  - [ ] Handle location unavailable
  - [ ] Handle API save errors
  - [ ] Display user-friendly error messages
  - [ ] Offer retry or manual entry fallback

- [ ] **Task 11: Testing & Documentation**
  - [ ] Test on iOS Safari (PWA)
  - [ ] Test on Android Chrome
  - [ ] Test on desktop browsers
  - [ ] Test guest mode save flow
  - [ ] Test authenticated save flow
  - [ ] Add curl examples to API docs
  - [ ] Write Playwright E2E tests

## Dev Notes

### Architecture References

- [architecture/5-api-specification.md](../architecture/5-api-specification.md) - Spots endpoints
- [architecture-backend/4-data-models.md](../architecture-backend/4-data-models.md) - Spots schema
- [architecture-frontend/7-state-management.md](../architecture-frontend/7-state-management.md) - Spot store

### Database Schema

```typescript
// db/schema/spots.ts
import { pgTable, uuid, decimal, integer, text, timestamp } from 'drizzle-orm/pg-core';
import { users } from './users';

export const spots = pgTable('spots', {
  id: uuid('id').defaultRandom().primaryKey(),
  userId: uuid('user_id').references(() => users.id),
  lat: decimal('lat', { precision: 9, scale: 6 }).notNull(),
  lng: decimal('lng', { precision: 9, scale: 6 }).notNull(),
  accuracyMeters: integer('accuracy_meters'),
  photoUrl: text('photo_url'),
  note: text('note'),
  carTag: text('car_tag'),
  address: text('address'),
  savedAt: timestamp('saved_at', { withTimezone: true }).notNull().defaultNow(),
  createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).notNull().defaultNow(),
});
```

### API Endpoint

```bash
# Create spot
curl -X POST http://localhost:3000/api/v1/spots \
  -H "Content-Type: application/json" \
  -H "Cookie: token=<jwt>" \
  -d '{"lat": 40.7128, "lng": -74.0060, "accuracyMeters": 15}'

# Response
{
  "id": "uuid",
  "lat": 40.7128,
  "lng": -74.006,
  "accuracyMeters": 15,
  "savedAt": "2026-01-15T12:00:00Z"
}
```

### Geolocation API Usage

```typescript
// hooks/useGeolocation/useGeolocation.ts
export function useGeolocation() {
  const [state, setState] = useState<GeolocationState>({
    position: null,
    error: null,
    isLoading: false,
    permissionState: 'prompt',
  });

  const getCurrentPosition = async (): Promise<GeolocationPosition> => {
    setState((s) => ({ ...s, isLoading: true, error: null }));

    return new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          setState((s) => ({
            ...s,
            position: {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
              accuracy: position.coords.accuracy,
            },
            isLoading: false,
          }));
          resolve(position);
        },
        (error) => {
          setState((s) => ({
            ...s,
            error: error.message,
            isLoading: false,
            permissionState: error.code === 1 ? 'denied' : 'prompt',
          }));
          reject(error);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000, // 1 minute cache
        }
      );
    });
  };

  return { ...state, getCurrentPosition };
}
```

### Save Flow (Authenticated vs Guest)

```typescript
// stores/spotStore.ts
saveSpot: async (position) => {
  const { authMode } = useAuthStore.getState();
  const { isGuest } = useGuestStore.getState();

  if (isGuest) {
    // Save to IndexedDB
    const spot = {
      id: crypto.randomUUID(),
      lat: position.lat,
      lng: position.lng,
      accuracyMeters: position.accuracy,
      savedAt: new Date().toISOString(),
    };
    await indexedDbService.setItem('spots', spot.id, spot);
    return spot;
  } else {
    // Save to API
    const response = await fetch('/api/v1/spots', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        lat: position.lat,
        lng: position.lng,
        accuracyMeters: position.accuracy,
      }),
    });
    return response.json();
  }
};
```

### File Locations

**New Backend Files:**

- `apps/api/src/db/schema/spots.ts`
- `apps/api/src/repositories/spot.repository.ts`
- `apps/api/src/repositories/spot.types.ts`
- `apps/api/src/routes/spots/spots.routes.ts`
- `apps/api/src/routes/spots/spots.service.ts`
- `apps/api/src/routes/spots/types.ts`

**New Frontend Files:**

- `apps/web/src/pages/HomePage.tsx`
- `apps/web/src/hooks/useGeolocation/useGeolocation.ts`
- `apps/web/src/hooks/useGeolocation/types.ts`
- `apps/web/src/stores/spotStore.ts`
- `apps/web/src/stores/spot.types.ts`
- `apps/web/src/components/prompts/LocationPermissionPrompt.tsx`

**Modified Files:**

- `apps/api/src/routes/index.ts` - register spots routes
- `apps/web/src/services/storage/indexedDb.service.ts` - add spots methods

### Testing Coverage

- Spot repository: 100%
- Spots API routes: 100%
- useGeolocation hook: 95%
- spotStore: 100%
- HomePage: 90%

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation | PO     |
