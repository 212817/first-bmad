# Story 4.1: Share Spot Link

## Status

In Progress

## Story

**As a** user,  
**I want** to share my parking spot with someone else,  
**so that** they can find the car (e.g., partner picking up).

## Acceptance Criteria

1. "Share" button available on spot detail screen and confirmation screen
2. Generates a shareable URL with unique spot identifier
3. Uses Web Share API where supported; fallback to copy-to-clipboard
4. Shared link works without requiring recipient to have an account
5. Shared spot view shows: address, coordinates, photo (if any), "Navigate" button
6. Shared links expire after 7 days for privacy
7. Rate limit on share link generation to prevent abuse

## Tasks / Subtasks

- [x] **Task 0: Install Rate Limiter Dependency** (prerequisite for AC: 7)
  - [x] Check if `express-rate-limit` exists in package.json
  - [x] If not: `npm install express-rate-limit`

- [x] **Task 1: Create Share Token Schema** (AC: 2, 6)
  - [x] Add `share_tokens` table to Drizzle schema
  - [x] Fields: `id`, `token` (unique), `spotId`, `createdAt`, `expiresAt`
  - [x] Index on `token` for fast lookup
  - [x] Run migration
  - [x] Write unit tests

- [x] **Task 2: Backend - Create Share Link Endpoint** (AC: 2, 6, 7)
  - [x] Create `POST /v1/spots/:spotId/share` endpoint
  - [x] Generate unique token (nanoid or uuid)
  - [x] Set expiresAt to 7 days from now
  - [x] Store in share_tokens table
  - [x] Return shareable URL: `{baseUrl}/s/{token}`
  - [x] Add rate limiting (10 shares/hour per user)
  - [x] Write integration tests

- [x] **Task 3: Share Token Repository** (AC: 2, 6)
  - [x] Create `apps/api/src/repositories/shareToken.repository.ts`
  - [x] `create(spotId, token, expiresAt)` method
  - [x] `findByToken(token)` method - includes spot data
  - [x] `deleteExpired()` method for cleanup job
  - [x] Write unit tests

- [x] **Task 4: Create Share Service (Frontend)** (AC: 3)
  - [x] Create `apps/web/src/services/share/share.service.ts`
  - [x] Create `apps/web/src/services/share/types.ts`
  - [x] Detect Web Share API support
  - [x] `shareSpot(url, title)` - uses Web Share API
  - [x] `copyToClipboard(url)` - fallback
  - [x] Write unit tests

- [x] **Task 5: Create Share Button Component** (AC: 1, 3)
  - [x] Create `apps/web/src/components/spot/ShareButton.tsx`
  - [x] Call API to generate share link
  - [x] Try Web Share API first
  - [x] Fallback to copy-to-clipboard with toast
  - [x] Show loading state while generating
  - [x] Handle errors gracefully

- [x] **Task 6: Integrate Share Button** (AC: 1)
  - [x] Add to SpotDetailPage (replace disabled button from 3.4)
  - [x] Add to ConfirmationScreen (Story 2.2)
  - [x] Consistent styling and placement

- [x] **Task 7: Update Spot Store** (AC: 2)
  - [x] Add `createShareLink(spotId)` action
  - [x] Return shareable URL
  - [x] Handle errors

- [x] **Task 8: Testing**
  - [x] Test share link generation
  - [x] Test Web Share API path
  - [x] Test copy-to-clipboard fallback
  - [x] Test rate limiting
  - [ ] Write Playwright E2E tests

## Dev Notes

### Architecture References

- [architecture/5-api-specification.md](../architecture/5-api-specification.md)
- [architecture-frontend/9-external-services.md](../architecture-frontend/9-external-services.md)

### Dependencies

- Story 2.2 (ConfirmationScreen)
- Story 3.4 (SpotDetailPage)

### Database Schema

```typescript
// schema/shareTokens.ts
import { pgTable, uuid, varchar, timestamp, index } from 'drizzle-orm/pg-core';

export const shareTokens = pgTable(
  'share_tokens',
  {
    id: uuid('id').defaultRandom().primaryKey(),
    token: varchar('token', { length: 32 }).notNull().unique(),
    spotId: uuid('spot_id')
      .notNull()
      .references(() => spots.id, { onDelete: 'cascade' }),
    createdAt: timestamp('created_at').defaultNow().notNull(),
    expiresAt: timestamp('expires_at').notNull(),
  },
  (table) => ({
    tokenIdx: index('share_token_idx').on(table.token),
  })
);
```

### API Endpoint

```bash
# Create share link
POST /api/v1/spots/:spotId/share
Authorization: Bearer <token>

# Response
{
  "shareUrl": "https://app.example.com/s/abc123xyz",
  "expiresAt": "2026-01-22T10:00:00Z"
}

# Rate limit exceeded
HTTP 429
{
  "error": "Rate limit exceeded. Try again later."
}
```

### Share Service Implementation

```typescript
// services/share/share.service.ts
export const shareService = {
  canUseWebShare: (): boolean => {
    return 'share' in navigator && 'canShare' in navigator;
  },

  shareSpot: async (url: string, title: string): Promise<boolean> => {
    if (shareService.canUseWebShare()) {
      try {
        await navigator.share({
          title,
          text: "Here's where I parked",
          url,
        });
        return true;
      } catch (error) {
        if ((error as Error).name === 'AbortError') {
          // User cancelled - not an error
          return false;
        }
        throw error;
      }
    }
    return false;
  },

  copyToClipboard: async (url: string): Promise<void> => {
    await navigator.clipboard.writeText(url);
  },
};
```

### Share Button Component

```tsx
// components/spot/ShareButton.tsx
interface ShareButtonProps {
  spotId: string;
  spotAddress?: string;
}

export function ShareButton({ spotId, spotAddress }: ShareButtonProps) {
  const [isSharing, setIsSharing] = useState(false);
  const { createShareLink } = useSpotStore();

  const handleShare = async () => {
    setIsSharing(true);
    try {
      const { shareUrl } = await createShareLink(spotId);
      const title = spotAddress || 'My Parking Spot';

      const shared = await shareService.shareSpot(shareUrl, title);

      if (!shared) {
        // Web Share not available or cancelled - copy to clipboard
        await shareService.copyToClipboard(shareUrl);
        toast.success('Link copied to clipboard!');
      }
    } catch (error) {
      toast.error('Failed to create share link');
    } finally {
      setIsSharing(false);
    }
  };

  return (
    <Button onClick={handleShare} disabled={isSharing} variant="secondary">
      <Share className="w-5 h-5 mr-2" />
      {isSharing ? 'Sharing...' : 'Share'}
    </Button>
  );
}
```

### Rate Limiting

```typescript
// middleware/rateLimit.ts
import rateLimit from 'express-rate-limit';

export const shareRateLimiter = rateLimit({
  windowMs: 60 * 60 * 1000, // 1 hour
  max: 10, // 10 shares per hour
  keyGenerator: (req) => req.user?.id || req.ip,
  message: { error: 'Rate limit exceeded. Try again later.' },
});

// Usage in route
router.post('/:spotId/share', authMiddleware, shareRateLimiter, shareController);
```

### File Locations

**New Files:**

- `apps/api/src/schema/shareTokens.ts`
- `apps/api/src/repositories/shareToken.repository.ts`
- `apps/api/src/routes/spots/share.routes.ts`
- `apps/web/src/services/share/share.service.ts`
- `apps/web/src/services/share/types.ts`
- `apps/web/src/components/spot/ShareButton.tsx`

**Modified Files:**

- `apps/api/src/schema/index.ts` - export shareTokens
- `apps/web/src/stores/spotStore.ts` - add createShareLink
- `apps/web/src/pages/SpotDetailPage.tsx` - add ShareButton
- `apps/web/src/pages/ConfirmationPage.tsx` - add ShareButton

### Testing Coverage

- ShareButton: 90%
- Share service: 95%
- Share endpoint: 100%
- Rate limiting: 100%

## Change Log

| Date       | Version | Description             | Author    |
| ---------- | ------- | ----------------------- | --------- |
| 2026-01-15 | 1.0     | Initial story creation  | PO        |
| 2026-02-04 | 1.1     | Implementation complete | Dev Agent |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### File List

**New Files:**

- `packages/shared/src/db/schema.ts` - Added shareTokens table
- `apps/api/src/repositories/shareToken.repository.ts` - Share token repository with CRUD operations
- `apps/api/src/repositories/shareToken.types.ts` - TypeScript types for share tokens
- `apps/api/test/unit/shareToken.repository.test.ts` - Unit tests for share token repository
- `apps/web/src/services/share/share.service.ts` - Share service with Web Share API and clipboard fallback
- `apps/web/src/services/share/types.ts` - TypeScript types for share service
- `apps/web/src/services/share/__tests__/share.service.test.ts` - Unit tests for share service
- `apps/web/src/components/spot/ShareButton.tsx` - Share button component
- `apps/web/src/components/spot/__tests__/ShareButton.test.tsx` - Unit tests for ShareButton

**Modified Files:**

- `apps/api/src/config/env.ts` - Added FRONTEND_URL environment variable
- `apps/api/src/middleware/rateLimit.middleware.ts` - Added shareRateLimiter (10/hour)
- `apps/api/src/routes/spots/spots.routes.ts` - Added POST /:id/share endpoint
- `apps/api/src/routes/spots/spots.service.ts` - Added createShareLink method
- `apps/api/src/routes/spots/types.ts` - Added CreateShareLinkResponse type
- `apps/web/src/stores/spot.types.ts` - Added ShareLinkResponse type and createShareLink action
- `apps/web/src/stores/spotStore.ts` - Implemented createShareLink action
- `apps/web/src/components/spot/types.ts` - Added ShareButtonProps interface
- `apps/web/src/components/spot/index.ts` - Added ShareButton export
- `apps/web/src/pages/SpotDetailPage.tsx` - Replaced disabled Share placeholder with ShareButton
- `apps/web/src/pages/SpotConfirmationPage.tsx` - Added ShareButton for authenticated users
- `apps/web/src/pages/__tests__/SpotDetailPage.test.tsx` - Updated Share button test expectations

### Debug Log References

None - implementation completed without blocking issues.

### Completion Notes

- All 259 API unit tests pass
- All 712 web unit tests pass (1 pre-existing failure in useGeolocation unrelated to this story)
- Used existing custom `createRateLimiter` instead of `express-rate-limit` package
- Share button hidden in guest mode (only shown for authenticated users)
- Web Share API support detection with clipboard fallback
- Share tokens expire after 7 days (checked on lookup, not via scheduled job)
- E2E tests pending (marked incomplete in Task 8)
- AC 4 and 5 (shared spot view page) will be completed in Story 4.2
