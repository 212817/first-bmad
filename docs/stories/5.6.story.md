# Story 5.6: Delete Account

## Status

Approved

## Story

**As a** user,  
**I want** to delete my account entirely,  
**so that** I can stop using the service and remove my identity.

## Acceptance Criteria

1. "Delete Account" option in Settings (authenticated users only)
2. Confirmation dialog with warning
3. Deletes user record, all spots, all photos
4. Revokes OAuth connection where possible
5. Signs user out; returns to login screen
6. Cannot be undone

## Tasks / Subtasks

- [ ] **Task 1: Backend - Delete Account Endpoint** (AC: 3)
  - [ ] Create `DELETE /v1/users/me` endpoint
  - [ ] Delete all spots and photos (reuse from 5.5)
  - [ ] Delete user record from database
  - [ ] Return success
  - [ ] Write integration tests

- [ ] **Task 2: OAuth Token Revocation** (AC: 4)
  - [ ] Google: Call token revocation endpoint
  - [ ] Apple: Note limitations (Apple doesn't provide revoke API)
  - [ ] Handle revocation failures gracefully (don't block deletion)

- [ ] **Task 3: Create Delete Account Page** (AC: 1, 2, 6)
  - [ ] Create `apps/web/src/pages/DeleteAccountPage.tsx`
  - [ ] Add route `/settings/delete-account` to router
  - [ ] Only accessible to authenticated users
  - [ ] Redirect guests to settings

- [ ] **Task 4: Delete Account Confirmation** (AC: 2, 6)
  - [ ] Reuse/extend DeleteDataConfirmation component
  - [ ] Stronger warning than delete data
  - [ ] "Your account and all data will be permanently deleted"
  - [ ] Require typing "DELETE MY ACCOUNT"

- [ ] **Task 5: Execute Account Deletion** (AC: 3, 5)
  - [ ] Call DELETE /users/me endpoint
  - [ ] Clear local tokens
  - [ ] Clear any cached user data
  - [ ] Redirect to home/login

- [ ] **Task 6: Post-Deletion Cleanup** (AC: 5)
  - [ ] Clear auth tokens from localStorage
  - [ ] Reset all Zustand stores
  - [ ] Navigate to login screen
  - [ ] Show success message

- [ ] **Task 7: Testing**
  - [ ] Test only available for authenticated users
  - [ ] Test confirmation required
  - [ ] Test account actually deleted
  - [ ] Test signed out after deletion
  - [ ] Test cannot log back in with same account
  - [ ] Write Playwright E2E tests

## Dev Notes

### Architecture References

- [architecture/5-api-specification.md](../architecture/5-api-specification.md)
- [architecture/6-security-considerations.md](../architecture/6-security-considerations.md)

### Dependencies

- Story 5.5 (Delete all data functionality)
- Story 1.2 (Google OAuth)
- Story 1.3 (Apple Sign-In)

### API Endpoint

```bash
# Delete account (and all data)
DELETE /api/v1/users/me
Authorization: Bearer <token>

# Response
HTTP 204 No Content

# On error
HTTP 500
{
  "error": "Failed to delete account. Please try again."
}
```

### Backend Delete Account Handler

```typescript
// routes/users/users.routes.ts
router.delete('/me', authMiddleware, async (req, res) => {
  const userId = req.user.id;
  const user = await userRepository.findById(userId);

  if (!user) {
    return res.status(404).json({ error: 'User not found' });
  }

  try {
    // Delete all user data first (same as 5.5)
    const spots = await spotRepository.findAllByUserId(userId);
    const photoKeys = spots
      .filter((spot) => spot.photoUrl)
      .map((spot) => extractPhotoKey(spot.photoUrl!));

    if (photoKeys.length > 0) {
      await r2Service.deleteObjects(photoKeys);
    }

    await spotRepository.deleteAllByUserId(userId);
    await carTagRepository.deleteAllByUserId(userId);

    // Revoke OAuth token if possible
    await revokeOAuthToken(user);

    // Delete the user record
    await userRepository.delete(userId);

    console.log(`Deleted account for user ${userId}`);

    return res.status(204).send();
  } catch (error) {
    console.error('Failed to delete account:', error);
    return res.status(500).json({ error: 'Failed to delete account. Please try again.' });
  }
});
```

### OAuth Token Revocation

```typescript
// services/oauth.service.ts
export async function revokeOAuthToken(user: User): Promise<void> {
  if (!user.refreshToken) return;

  try {
    if (user.provider === 'google') {
      // Google token revocation
      await fetch('https://oauth2.googleapis.com/revoke', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `token=${user.refreshToken}`,
      });
    }
    // Apple doesn't provide a token revocation API
    // The token will naturally expire
  } catch (error) {
    // Log but don't fail - user deletion should still proceed
    console.error('Failed to revoke OAuth token:', error);
  }
}
```

### Delete Account Page

```tsx
// pages/DeleteAccountPage.tsx
export function DeleteAccountPage() {
  const navigate = useNavigate();
  const { isGuest, signOut } = useAuthStore();
  const [confirmText, setConfirmText] = useState('');
  const [isDeleting, setIsDeleting] = useState(false);

  // Redirect guests
  useEffect(() => {
    if (isGuest) {
      navigate('/settings');
    }
  }, [isGuest]);

  const canDelete = confirmText === 'DELETE MY ACCOUNT';

  const handleDelete = async () => {
    if (!canDelete) return;

    setIsDeleting(true);

    try {
      await apiClient.delete('/v1/users/me');

      // Clear all local state
      localStorage.removeItem('auth_token');
      localStorage.removeItem('refresh_token');

      // Reset stores
      useAuthStore.getState().reset();
      useSpotStore.getState().reset();
      useCarTagsStore.getState().reset();

      toast.success('Account deleted successfully');
      navigate('/');
    } catch (error) {
      toast.error('Failed to delete account');
      setIsDeleting(false);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      <header className="bg-white p-4 border-b flex items-center">
        <BackButton />
        <h1 className="text-xl font-bold ml-2">Delete Account</h1>
      </header>

      <div className="p-4 space-y-6">
        <div className="bg-red-50 border border-red-200 rounded-lg p-4">
          <div className="flex items-start gap-3">
            <AlertTriangle className="w-6 h-6 text-red-500 shrink-0" />
            <div>
              <h2 className="font-semibold text-red-800">Permanent Deletion</h2>
              <p className="text-sm text-red-700 mt-1">
                This will permanently delete your account, all parking spots, and photos. You will
                not be able to sign in again with this account.
              </p>
            </div>
          </div>
        </div>

        <div className="bg-white rounded-lg p-4 space-y-4">
          <p className="text-sm text-gray-600">
            To confirm, type <span className="font-mono font-bold">DELETE MY ACCOUNT</span> below:
          </p>

          <input
            type="text"
            value={confirmText}
            onChange={(e) => setConfirmText(e.target.value.toUpperCase())}
            placeholder="Type DELETE MY ACCOUNT to confirm"
            className="w-full px-4 py-3 border rounded-lg font-mono text-sm"
            disabled={isDeleting}
          />

          <div className="flex gap-3">
            <Button
              onClick={() => navigate(-1)}
              variant="secondary"
              className="flex-1"
              disabled={isDeleting}
            >
              Cancel
            </Button>
            <Button
              onClick={handleDelete}
              variant="destructive"
              className="flex-1"
              disabled={!canDelete || isDeleting}
            >
              {isDeleting ? 'Deleting...' : 'Delete Account'}
            </Button>
          </div>
        </div>
      </div>
    </div>
  );
}
```

### File Locations

**New Files:**

- `apps/web/src/pages/DeleteAccountPage.tsx`
- `apps/api/src/services/oauth.service.ts` - add revocation

**Modified Files:**

- `apps/api/src/routes/users/users.routes.ts` - add DELETE /me endpoint
- `apps/api/src/repositories/user.repository.ts` - add delete method
- `apps/web/src/router.tsx` - add /settings/delete-account route

### Testing Coverage

- DeleteAccountPage: 90%
- Delete account endpoint: 100%
- OAuth revocation: 85% (Apple limitation)

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation | PO     |
