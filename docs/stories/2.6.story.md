# Story 2.6: Manual Address Entry Fallback

## Status

Approved

## Story

**As a** user who denied location permission,  
**I want** to manually enter an address,  
**so that** I can still save my parking spot.

## Acceptance Criteria

1. When location permission is denied, show "Enter address manually" option
2. Text input accepts free-form address
3. Address is geocoded to coordinates using OpenCage API
4. Geocoding result is cached in database to conserve API quota
5. If geocoding fails, allow saving with address text only (no coordinates)
6. User is informed that navigation may be less accurate without GPS

## Tasks / Subtasks

- [ ] **Task 1: Create Address Input Component** (AC: 1, 2)
  - [ ] Create `apps/web/src/components/spot/AddressInput.tsx`
  - [ ] Full-width text input for address
  - [ ] Placeholder: "123 Main St, City, State"
  - [ ] Clear button
  - [ ] Submit button or enter-to-submit

- [ ] **Task 2: Create Geocoding Service (Backend)** (AC: 3, 4)
  - [ ] Create `apps/api/src/services/geocoding/geocoding.service.ts`
  - [ ] Create `apps/api/src/services/geocoding/types.ts`
  - [ ] Implement `geocodeAddress(address)` - call OpenCage API
  - [ ] Parse response for lat/lng
  - [ ] Handle rate limits (2,500/day free tier)
  - [ ] Write unit tests

- [ ] **Task 3: Create Geocache Database Table** (AC: 4)
  - [ ] Create `apps/api/src/db/schema/geocache.ts`
  - [ ] Fields: `id`, `addressQuery`, `lat`, `lng`, `formattedAddress`, `createdAt`
  - [ ] Index on `addressQuery` for fast lookup
  - [ ] Run migration

- [ ] **Task 4: Implement Geocache Repository** (AC: 4)
  - [ ] Create `apps/api/src/repositories/geocache.repository.ts`
  - [ ] Implement `findByAddress(query)` - check cache first
  - [ ] Implement `create(result)` - cache new results
  - [ ] Normalize queries (lowercase, trim)
  - [ ] Write unit tests

- [ ] **Task 5: Create Geocoding API Endpoint** (AC: 3)
  - [ ] Add `POST /v1/geocode` endpoint
  - [ ] Accept `{ address: string }`
  - [ ] Return `{ lat, lng, formattedAddress }` or error
  - [ ] Check cache before calling OpenCage
  - [ ] Rate limit per user (10 requests/minute)
  - [ ] Write integration tests

- [ ] **Task 6: Frontend - Manual Entry Flow** (AC: 1, 2, 5)
  - [ ] Show AddressInput when location denied
  - [ ] On submit: call geocoding endpoint
  - [ ] If success: save spot with coordinates
  - [ ] If fail: save spot with address text only

- [ ] **Task 7: Warning for No Coordinates** (AC: 6)
  - [ ] Create warning banner component
  - [ ] Display when spot has address but no coords
  - [ ] Text: "Navigation may be less accurate"
  - [ ] Show on confirmation and detail screens

- [ ] **Task 8: Update Spot Save Flow** (AC: 5)
  - [ ] Allow creating spot with address only (no lat/lng)
  - [ ] Update validation to make lat/lng optional
  - [ ] Update database schema if needed (nullable coords)

- [ ] **Task 9: Guest Mode Manual Entry**
  - [ ] For guests: skip geocoding (preserve free quota)
  - [ ] Save address text directly to IndexedDB
  - [ ] Show warning about limited navigation

- [ ] **Task 10: Environment Variables**
  - [ ] Add `OPENCAGE_API_KEY` to env config
  - [ ] Document OpenCage setup in README
  - [ ] Add to Vercel/deployment env

- [ ] **Task 11: Testing & Documentation**
  - [ ] Test geocoding with real addresses
  - [ ] Test cache hit/miss
  - [ ] Test rate limiting
  - [ ] Test save without coordinates
  - [ ] Write Playwright E2E tests

## Dev Notes

### Architecture References

- [architecture-backend/9-external-services.md](../architecture-backend/9-external-services.md) - OpenCage API

### OpenCage API

```
GET https://api.opencagedata.com/geocode/v1/json?q=ADDRESS&key=API_KEY
```

Free tier: 2,500 requests/day

### Geocoding Service

```typescript
// services/geocoding/geocoding.service.ts
const OPENCAGE_URL = 'https://api.opencagedata.com/geocode/v1/json';

export const geocodingService = {
  geocodeAddress: async (address: string): Promise<GeocodingResult | null> => {
    // Check cache first
    const cached = await geocacheRepository.findByAddress(address);
    if (cached) {
      return cached;
    }

    // Call OpenCage
    const url = new URL(OPENCAGE_URL);
    url.searchParams.set('q', address);
    url.searchParams.set('key', env.OPENCAGE_API_KEY);
    url.searchParams.set('limit', '1');

    const response = await fetch(url);
    const data = await response.json();

    if (data.results?.length > 0) {
      const result = {
        lat: data.results[0].geometry.lat,
        lng: data.results[0].geometry.lng,
        formattedAddress: data.results[0].formatted,
      };

      // Cache result
      await geocacheRepository.create({
        addressQuery: address.toLowerCase().trim(),
        ...result,
      });

      return result;
    }

    return null;
  },
};
```

### Geocache Schema

```typescript
// db/schema/geocache.ts
export const geocache = pgTable('geocache', {
  id: uuid('id').defaultRandom().primaryKey(),
  addressQuery: text('address_query').notNull().unique(),
  lat: decimal('lat', { precision: 9, scale: 6 }).notNull(),
  lng: decimal('lng', { precision: 9, scale: 6 }).notNull(),
  formattedAddress: text('formatted_address'),
  createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),
});
```

### Geocoding Endpoint

```typescript
// routes/geocode/geocode.routes.ts
router.post('/', authMiddleware, rateLimiter, async (req, res) => {
  const { address } = req.body;

  if (!address || address.length < 5) {
    throw new ValidationError('Address too short');
  }

  const result = await geocodingService.geocodeAddress(address);

  if (!result) {
    res.status(404).json({ error: 'Address not found' });
    return;
  }

  res.json(result);
});
```

### Address Input Component

```tsx
// components/spot/AddressInput.tsx
interface AddressInputProps {
  onSubmit: (address: string) => void;
  isLoading?: boolean;
}

export function AddressInput({ onSubmit, isLoading }: AddressInputProps) {
  const [address, setAddress] = useState('');

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (address.trim()) {
      onSubmit(address.trim());
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-3">
      <div>
        <label className="block text-sm font-medium mb-1">Enter parking address</label>
        <input
          type="text"
          value={address}
          onChange={(e) => setAddress(e.target.value)}
          placeholder="123 Main St, City, State"
          className="w-full p-3 border rounded-lg"
          disabled={isLoading}
        />
      </div>
      <button
        type="submit"
        disabled={!address.trim() || isLoading}
        className="w-full h-12 bg-blue-500 text-white rounded-lg font-medium disabled:opacity-50"
      >
        {isLoading ? 'Finding location...' : 'Save Spot'}
      </button>
    </form>
  );
}
```

### No-Coordinates Warning

```tsx
// components/ui/NoCoordinatesWarning.tsx
export function NoCoordinatesWarning() {
  return (
    <div className="flex items-center gap-2 p-3 bg-amber-50 border border-amber-200 rounded-lg text-amber-800 text-sm">
      <AlertTriangle className="w-5 h-5 flex-shrink-0" />
      <span>
        Navigation may be less accurate without GPS coordinates. Try enabling location permission
        for better results.
      </span>
    </div>
  );
}
```

### Manual Entry Flow

```
Location Denied
      ↓
Show "Enter address manually"
      ↓
User enters address
      ↓
Call POST /v1/geocode
      ↓
┌─────────────────┬─────────────────┐
│   Success       │    Failure      │
│  lat/lng found  │  not found      │
└────────┬────────┴────────┬────────┘
         ↓                 ↓
   Save spot with    Save spot with
   coordinates       address only
         ↓                 ↓
   Normal flow       Show warning
```

### Environment Variables

```bash
# OpenCage Geocoding
OPENCAGE_API_KEY=your_api_key_here
```

### File Locations

**New Backend Files:**

- `apps/api/src/services/geocoding/geocoding.service.ts`
- `apps/api/src/services/geocoding/types.ts`
- `apps/api/src/db/schema/geocache.ts`
- `apps/api/src/repositories/geocache.repository.ts`
- `apps/api/src/routes/geocode/geocode.routes.ts`

**New Frontend Files:**

- `apps/web/src/components/spot/AddressInput.tsx`
- `apps/web/src/components/ui/NoCoordinatesWarning.tsx`

**Modified Files:**

- `apps/api/src/db/schema/spots.ts` - make lat/lng nullable
- `apps/api/src/routes/spots/spots.routes.ts` - allow address-only

### Testing Coverage

- geocodingService: 100%
- geocacheRepository: 100%
- Geocode endpoint: 100%
- AddressInput: 90%

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-15 | 1.0     | Initial story creation | PO     |
