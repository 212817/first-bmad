# Story 2.6: Manual Address Entry Fallback

## Status

Done

## Story

**As a** user who denied location permission,  
**I want** to manually enter an address,  
**so that** I can still save my parking spot.

## Acceptance Criteria

1. When location permission is denied, show "Enter address manually" option
2. Text input accepts free-form address
3. Address is geocoded to coordinates using OpenCage API
4. Geocoding result is cached in database to conserve API quota
5. If geocoding fails, allow saving with address text only (no coordinates)
6. User is informed that navigation may be less accurate without GPS

## Tasks / Subtasks

- [x] **Task 1: Create Address Input Component** (AC: 1, 2)
  - [x] Create `apps/web/src/components/spot/AddressInput.tsx`
  - [x] Full-width text input for address
  - [x] Placeholder: "123 Main St, City, State"
  - [x] Clear button
  - [x] Submit button or enter-to-submit

- [x] **Task 2: Create Geocoding Service (Backend)** (AC: 3, 4)
  - [x] Create `apps/api/src/services/geocoding/geocoding.service.ts`
  - [x] Create `apps/api/src/services/geocoding/types.ts`
  - [x] Implement `geocodeAddress(address)` - call OpenCage API
  - [x] Parse response for lat/lng
  - [x] Handle rate limits (2,500/day free tier)
  - [x] Write unit tests

- [x] **Task 3: Create Geocache Database Table** (AC: 4)
  - [x] Create `apps/api/src/db/schema/geocache.ts`
  - [x] Fields: `id`, `addressQuery`, `lat`, `lng`, `formattedAddress`, `createdAt`
  - [x] Index on `addressQuery` for fast lookup
  - [x] Run migration

- [x] **Task 4: Implement Geocache Repository** (AC: 4)
  - [x] Create `apps/api/src/repositories/geocache.repository.ts`
  - [x] Implement `findByAddress(query)` - check cache first
  - [x] Implement `create(result)` - cache new results
  - [x] Normalize queries (lowercase, trim)
  - [x] Write unit tests

- [x] **Task 5: Create Geocoding API Endpoint** (AC: 3)
  - [x] Add `POST /v1/geocode` endpoint
  - [x] Accept `{ address: string }`
  - [x] Return `{ lat, lng, formattedAddress }` or error
  - [x] Check cache before calling OpenCage
  - [x] Rate limit per user (10 requests/minute)
  - [x] Write integration tests

- [x] **Task 6: Frontend - Manual Entry Flow** (AC: 1, 2, 5)
  - [x] Show AddressInput when location denied
  - [x] On submit: call geocoding endpoint
  - [x] If success: save spot with coordinates
  - [x] If fail: save spot with address text only

- [x] **Task 7: Warning for No Coordinates** (AC: 6)
  - [x] Create warning banner component
  - [x] Display when spot has address but no coords
  - [x] Text: "Navigation may be less accurate"
  - [x] Show on confirmation and detail screens

- [x] **Task 8: Update Spot Save Flow** (AC: 5)
  - [x] Allow creating spot with address only (no lat/lng)
  - [x] Update validation to make lat/lng optional
  - [x] Update database schema if needed (nullable coords)

- [x] **Task 9: Guest Mode Manual Entry**
  - [x] For guests: skip geocoding (preserve free quota)
  - [x] Save address text directly to IndexedDB
  - [x] Show warning about limited navigation

- [x] **Task 10: Environment Variables**
  - [x] Add `OPENCAGE_API_KEY` to env config
  - [x] Document OpenCage setup in README
  - [x] Add to Vercel/deployment env

- [x] **Task 11: Testing & Documentation**
  - [x] Test geocoding with real addresses
  - [x] Test cache hit/miss
  - [x] Test rate limiting
  - [x] Test save without coordinates
  - [x] Write Playwright E2E tests

## Dev Notes

### Architecture References

- [architecture-backend/9-external-services.md](../architecture-backend/9-external-services.md) - OpenCage API

### OpenCage API

```
GET https://api.opencagedata.com/geocode/v1/json?q=ADDRESS&key=API_KEY
```

Free tier: 2,500 requests/day

### Geocoding Service

```typescript
// services/geocoding/geocoding.service.ts
const OPENCAGE_URL = 'https://api.opencagedata.com/geocode/v1/json';

export const geocodingService = {
  geocodeAddress: async (address: string): Promise<GeocodingResult | null> => {
    // Check cache first
    const cached = await geocacheRepository.findByAddress(address);
    if (cached) {
      return cached;
    }

    // Call OpenCage
    const url = new URL(OPENCAGE_URL);
    url.searchParams.set('q', address);
    url.searchParams.set('key', env.OPENCAGE_API_KEY);
    url.searchParams.set('limit', '1');

    const response = await fetch(url);
    const data = await response.json();

    if (data.results?.length > 0) {
      const result = {
        lat: data.results[0].geometry.lat,
        lng: data.results[0].geometry.lng,
        formattedAddress: data.results[0].formatted,
      };

      // Cache result
      await geocacheRepository.create({
        addressQuery: address.toLowerCase().trim(),
        ...result,
      });

      return result;
    }

    return null;
  },
};
```

### Geocache Schema

```typescript
// db/schema/geocache.ts
export const geocache = pgTable('geocache', {
  id: uuid('id').defaultRandom().primaryKey(),
  addressQuery: text('address_query').notNull().unique(),
  lat: decimal('lat', { precision: 9, scale: 6 }).notNull(),
  lng: decimal('lng', { precision: 9, scale: 6 }).notNull(),
  formattedAddress: text('formatted_address'),
  createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),
});
```

### Geocoding Endpoint

```typescript
// routes/geocode/geocode.routes.ts
router.post('/', authMiddleware, rateLimiter, async (req, res) => {
  const { address } = req.body;

  if (!address || address.length < 5) {
    throw new ValidationError('Address too short');
  }

  const result = await geocodingService.geocodeAddress(address);

  if (!result) {
    res.status(404).json({ error: 'Address not found' });
    return;
  }

  res.json(result);
});
```

### Address Input Component

```tsx
// components/spot/AddressInput.tsx
interface AddressInputProps {
  onSubmit: (address: string) => void;
  isLoading?: boolean;
}

export function AddressInput({ onSubmit, isLoading }: AddressInputProps) {
  const [address, setAddress] = useState('');

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (address.trim()) {
      onSubmit(address.trim());
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-3">
      <div>
        <label className="block text-sm font-medium mb-1">Enter parking address</label>
        <input
          type="text"
          value={address}
          onChange={(e) => setAddress(e.target.value)}
          placeholder="123 Main St, City, State"
          className="w-full p-3 border rounded-lg"
          disabled={isLoading}
        />
      </div>
      <button
        type="submit"
        disabled={!address.trim() || isLoading}
        className="w-full h-12 bg-blue-500 text-white rounded-lg font-medium disabled:opacity-50"
      >
        {isLoading ? 'Finding location...' : 'Save Spot'}
      </button>
    </form>
  );
}
```

### No-Coordinates Warning

```tsx
// components/ui/NoCoordinatesWarning.tsx
export function NoCoordinatesWarning() {
  return (
    <div className="flex items-center gap-2 p-3 bg-amber-50 border border-amber-200 rounded-lg text-amber-800 text-sm">
      <AlertTriangle className="w-5 h-5 flex-shrink-0" />
      <span>
        Navigation may be less accurate without GPS coordinates. Try enabling location permission
        for better results.
      </span>
    </div>
  );
}
```

### Manual Entry Flow

```
Location Denied
      ↓
Show "Enter address manually"
      ↓
User enters address
      ↓
Call POST /v1/geocode
      ↓
┌─────────────────┬─────────────────┐
│   Success       │    Failure      │
│  lat/lng found  │  not found      │
└────────┬────────┴────────┬────────┘
         ↓                 ↓
   Save spot with    Save spot with
   coordinates       address only
         ↓                 ↓
   Normal flow       Show warning
```

### Environment Variables

```bash
# OpenCage Geocoding
OPENCAGE_API_KEY=your_api_key_here
```

### File Locations

**New Backend Files:**

- `apps/api/src/services/geocoding/geocoding.service.ts`
- `apps/api/src/services/geocoding/types.ts`
- `apps/api/src/repositories/geocache.repository.ts`
- `apps/api/src/repositories/geocache.types.ts`
- `apps/api/src/routes/geocode/geocode.routes.ts`
- `apps/api/src/middleware/rateLimit.middleware.ts`
- `apps/api/test/unit/geocoding.service.test.ts`
- `apps/api/test/unit/geocache.repository.test.ts`
- `apps/api/test/integration/geocode.test.ts`

**New Frontend Files:**

- `apps/web/src/components/spot/AddressInput.tsx`
- `apps/web/src/components/spot/__tests__/AddressInput.test.tsx`
- `apps/web/src/components/ui/NoCoordinatesWarning.tsx`
- `apps/web/src/components/ui/__tests__/NoCoordinatesWarning.test.tsx`
- `apps/web/src/pages/ManualEntryPage.tsx`
- `apps/web/src/pages/__tests__/ManualEntryPage.test.tsx`
- `apps/web/src/services/api/geocodingApi.ts`
- `apps/web/e2e/manual-address-entry.spec.ts`

**Modified Files:**

- `packages/shared/src/db/schema.ts` - make lat/lng nullable in parkingSpots, added geocodingCache table
- `packages/shared/src/types/index.ts` - make ParkingSpot.latitude/longitude nullable
- `apps/api/src/repositories/spot.types.ts` - make CreateSpotInput lat/lng nullable
- `apps/api/src/routes/spots/types.ts` - add address-only spot support
- `apps/api/src/routes/spots/spots.service.ts` - handle address-only creation
- `apps/api/src/app.ts` - register geocode routes
- `apps/web/src/stores/spot.types.ts` - add SaveSpotWithAddressInput
- `apps/web/src/stores/spotStore.ts` - handle address-only saves
- `apps/web/src/pages/SpotConfirmationPage.tsx` - show NoCoordinatesWarning
- `apps/web/src/components/ui/index.ts` - export new components
- `apps/web/src/App.tsx` - add /manual-entry route
- `.env.example` - add OPENCAGE_API_KEY, R2 config docs
- `README.md` - document external services

### Testing Coverage

- geocodingService: 100% (14 tests)
- geocacheRepository: 100% (6 tests)
- Geocode endpoint: 100% (6 tests)
- AddressInput: 100% (20 tests)
- ManualEntryPage: 100% (10 tests)
- NoCoordinatesWarning: 100% (7 tests)
- SpotConfirmationPage: 100% (18 tests)

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### Completion Notes

- All 11 tasks completed successfully
- Frontend: 367 unit tests passing
- Backend: 176 unit tests passing
- E2E tests created for manual address entry flow
- Database schema updated to support nullable lat/lng
- Guest mode skips geocoding API to preserve quota

### Debug Log References

None - implementation completed without blocking issues

## QA Results

### Review Date: 2026-02-03

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - Implementation demonstrates strong adherence to architecture patterns and coding standards. The geocoding feature is well-structured with proper separation of concerns across service, repository, and route layers.

**Strengths:**

- Clean layered architecture: service → repository → database
- Comprehensive error handling with graceful fallbacks
- Types properly defined in `types.ts` files per module (backend coding standard 12.1.1)
- Arrow function syntax used consistently (coding standard 12.1.7)
- Rate limiting properly implemented per user (10 requests/minute)
- Fire-and-forget cache writes avoid blocking user responses
- Guest mode correctly skips geocoding API to preserve quota

**Architecture Highlights:**

- `geocodingService` handles OpenCage API calls with timeout (10s) and error recovery
- `geocacheRepository` provides clean data access with address normalization
- `geocodeRouteService` separates route business logic from handlers (no try/catch in routes)
- Frontend `ManualEntryPage` properly orchestrates geocoding with fallback flow

### Refactoring Performed

None required - implementation already meets quality standards.

### Compliance Check

- Coding Standards: ✓ All backend and frontend standards followed
- Project Structure: ✓ Files in correct locations per architecture docs
- Testing Strategy: ✓ Unit/integration/E2E coverage complete
- All ACs Met: ✓ All 6 acceptance criteria fully implemented

### Acceptance Criteria Traceability

| AC  | Description                                        | Implementation                                          | Tests                                    |
| --- | -------------------------------------------------- | ------------------------------------------------------- | ---------------------------------------- |
| AC1 | Show "Enter address manually" when location denied | `ManualEntryPage` at `/spots/manual` route              | E2E: "can navigate to manual entry page" |
| AC2 | Text input accepts free-form address               | `AddressInput` component with validation                | 20 unit tests covering input handling    |
| AC3 | Geocode address via OpenCage API                   | `geocodingService.geocodeAddress()`                     | 14 unit tests, 6 integration tests       |
| AC4 | Cache geocoding results in database                | `geocacheRepository` + `geocoding_cache` table          | 6 unit tests for cache behavior          |
| AC5 | Save with address only if geocoding fails          | `ManualEntryPage` fallback + nullable lat/lng in schema | E2E: "can save spot with address only"   |
| AC6 | Warn about less accurate navigation                | `NoCoordinatesWarning` component                        | 7 unit tests, E2E: warning visible       |

### Improvements Checklist

- [x] All acceptance criteria implemented correctly
- [x] Error handling covers API failures, rate limits, timeouts
- [x] Address normalization prevents duplicate cache entries
- [x] Guest mode preserves API quota appropriately
- [x] Rate limiting configured at 10 requests/minute/user
- [x] Environment variables documented in .env.example
- [ ] Consider adding cache TTL/expiration mechanism for geocoding results
- [ ] Consider adding metrics/logging for API quota monitoring

### Security Review

✓ **Passed** - Security requirements met:

- Geocoding API requires authentication (`authMiddleware`)
- Rate limiting prevents quota abuse (`geocodingRateLimiter`)
- Input validation enforces minimum address length (5 chars)
- No sensitive data exposed in error responses

### Performance Considerations

✓ **Passed** - Performance optimizations in place:

- 10-second timeout prevents hung requests
- Cache-first lookup reduces API calls
- Fire-and-forget cache writes don't block responses
- `no_annotations=1` reduces OpenCage response size

### Test Coverage Summary

| Component            | Coverage | Tests               |
| -------------------- | -------- | ------------------- |
| geocodingService     | 100%     | 14 unit tests       |
| geocacheRepository   | 100%     | 6 unit tests        |
| Geocode endpoint     | 100%     | 6 integration tests |
| AddressInput         | 100%     | 20 unit tests       |
| ManualEntryPage      | 100%     | 10 unit tests       |
| NoCoordinatesWarning | 100%     | 7 unit tests        |
| E2E Manual Entry     | -        | 6 tests             |

### Gate Status

**Gate: PASS** → [docs/qa/gates/2.6-manual-address.yml](../qa/gates/2.6-manual-address.yml)

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, comprehensive test coverage, no blocking issues.

---

## Change Log

| Date       | Version | Description                          | Author |
| ---------- | ------- | ------------------------------------ | ------ |
| 2026-01-15 | 1.0     | Initial story creation               | PO     |
| 2026-02-02 | 2.0     | Implementation complete              | Dev    |
| 2026-02-03 | 2.1     | QA Review: PASS                      | Quinn  |
| 2026-02-03 | 2.2     | Status updated to Done after QA pass | Dev    |
