# Test Design: Story 1.4 - Guest Mode

**Date:** 2026-01-16  
**Designer:** Quinn (Test Architect)  
**Story:** As a user who doesn't want to create an account, I want to use the app without signing in, so that I can quickly save my parking spot without friction.

---

## Test Strategy Overview

| Metric                   | Count | Percentage |
| ------------------------ | ----- | ---------- |
| **Total test scenarios** | 32    | 100%       |
| Unit tests               | 18    | 56%        |
| Integration tests        | 8     | 25%        |
| E2E tests                | 6     | 19%        |

**Priority Distribution:**

- P0 (Critical): 8
- P1 (High): 12
- P2 (Medium): 10
- P3 (Low): 2

---

## Test Scenarios by Acceptance Criteria

### AC1: Login screen displays "Continue as Guest" option

| ID           | Level       | Priority | Test Scenario                                                 | Justification            |
| ------------ | ----------- | -------- | ------------------------------------------------------------- | ------------------------ |
| 1.4-UNIT-001 | Unit        | P1       | GuestModeButton renders with correct text "Continue as Guest" | Pure component rendering |
| 1.4-UNIT-002 | Unit        | P1       | GuestModeButton calls onClick handler when clicked            | Pure component behavior  |
| 1.4-UNIT-003 | Unit        | P2       | GuestModeButton shows loading state when loading=true         | Component state logic    |
| 1.4-UNIT-004 | Unit        | P2       | GuestModeButton is disabled during loading                    | Component prop behavior  |
| 1.4-INT-001  | Integration | P1       | LoginPage renders guest button below OAuth with divider       | Component composition    |
| 1.4-E2E-001  | E2E         | P0       | Guest button visible on login page                            | Critical user visibility |

---

### AC2: Selecting Guest mode skips authentication and proceeds to home screen

| ID           | Level       | Priority | Test Scenario                                          | Justification         |
| ------------ | ----------- | -------- | ------------------------------------------------------ | --------------------- |
| 1.4-UNIT-005 | Unit        | P0       | enterGuestMode() sets isGuest=true in store            | Core state mutation   |
| 1.4-UNIT-006 | Unit        | P0       | enterGuestMode() generates valid UUID sessionId        | Core ID generation    |
| 1.4-UNIT-007 | Unit        | P1       | enterGuestMode() sets createdAt timestamp              | State initialization  |
| 1.4-UNIT-008 | Unit        | P1       | setAuthMode('guest') updates authMode correctly        | Auth state sync       |
| 1.4-INT-002  | Integration | P0       | Guest button click → store update → navigation to home | Multi-component flow  |
| 1.4-E2E-002  | E2E         | P0       | Click "Continue as Guest" → redirects to home screen   | Critical user journey |

---

### AC3: Guest mode displays a persistent banner showing "Guest Mode - Data stored locally only"

| ID           | Level       | Priority | Test Scenario                                      | Justification         |
| ------------ | ----------- | -------- | -------------------------------------------------- | --------------------- |
| 1.4-UNIT-009 | Unit        | P1       | GuestModeBanner renders correct message text       | Component content     |
| 1.4-UNIT-010 | Unit        | P2       | GuestModeBanner has sticky positioning classes     | Styling verification  |
| 1.4-UNIT-011 | Unit        | P1       | GuestModeBanner renders "Sign in to sync" link     | Component content     |
| 1.4-UNIT-012 | Unit        | P1       | GuestModeBanner click handler navigates to login   | Interaction logic     |
| 1.4-INT-003  | Integration | P1       | Banner shown only when authMode === 'guest'        | Conditional rendering |
| 1.4-INT-004  | Integration | P2       | Banner not shown when authMode === 'authenticated' | Negative case         |
| 1.4-E2E-003  | E2E         | P1       | Guest banner visible on home page in guest mode    | User visibility       |

---

### AC4: App initializes IndexedDB for local storage

| ID           | Level       | Priority | Test Scenario                                              | Justification         |
| ------------ | ----------- | -------- | ---------------------------------------------------------- | --------------------- |
| 1.4-UNIT-013 | Unit        | P0       | indexedDbService.init() creates database with correct name | Core initialization   |
| 1.4-UNIT-014 | Unit        | P0       | init() creates 'spots' object store                        | Schema setup          |
| 1.4-UNIT-015 | Unit        | P0       | init() creates 'settings' object store                     | Schema setup          |
| 1.4-UNIT-016 | Unit        | P0       | init() creates 'guestSession' object store                 | Schema setup          |
| 1.4-UNIT-017 | Unit        | P1       | init() throws error if IndexedDB not available             | Error handling        |
| 1.4-UNIT-018 | Unit        | P2       | isAvailable() returns boolean for environment              | Environment detection |
| 1.4-INT-005  | Integration | P1       | App hydrates guest session from IndexedDB on load          | Persistence flow      |

---

### AC5: Guest users can access all spot-saving features (to be built in Epic 2)

| ID           | Level       | Priority | Test Scenario                                      | Justification       |
| ------------ | ----------- | -------- | -------------------------------------------------- | ------------------- |
| 1.4-INT-006  | Integration | P2       | Route guards allow guest users to access home      | Authorization logic |
| 1.4-UNIT-019 | Unit        | P2       | isAuthenticated returns true when authMode='guest' | Derived state       |

_Note: Full feature testing deferred to Epic 2 when spot-saving implemented._

---

### AC6: A prompt encourages signing in to enable sync (non-blocking, dismissible)

| ID           | Level       | Priority | Test Scenario                                      | Justification       |
| ------------ | ----------- | -------- | -------------------------------------------------- | ------------------- |
| 1.4-UNIT-020 | Unit        | P1       | SignInPrompt renders title "Sync your spots"       | Component content   |
| 1.4-UNIT-021 | Unit        | P1       | SignInPrompt renders Sign In and Dismiss buttons   | Component structure |
| 1.4-UNIT-022 | Unit        | P1       | SignInPrompt onDismiss called when Dismiss clicked | Interaction handler |
| 1.4-UNIT-023 | Unit        | P1       | SignInPrompt onSignIn called when Sign In clicked  | Interaction handler |
| 1.4-UNIT-024 | Unit        | P2       | useSignInPrompt shows prompt after 3rd visit       | Trigger logic       |
| 1.4-UNIT-025 | Unit        | P2       | useSignInPrompt respects dismissal preference      | Persistence logic   |
| 1.4-UNIT-026 | Unit        | P3       | useSignInPrompt increments visit count             | Counter logic       |
| 1.4-INT-007  | Integration | P1       | Dismiss persists to IndexedDB settings             | Persistence flow    |
| 1.4-E2E-004  | E2E         | P2       | Sign-in prompt appears on 3rd guest visit          | User journey        |
| 1.4-E2E-005  | E2E         | P2       | Dismissed prompt does not reappear                 | Persistence UX      |

---

### AC7: Guest mode state persists across browser sessions until user signs in

| ID           | Level       | Priority | Test Scenario                                    | Justification        |
| ------------ | ----------- | -------- | ------------------------------------------------ | -------------------- |
| 1.4-UNIT-027 | Unit        | P0       | hydrate() restores isGuest from IndexedDB        | Core persistence     |
| 1.4-UNIT-028 | Unit        | P0       | hydrate() restores guestSessionId from IndexedDB | Core persistence     |
| 1.4-UNIT-029 | Unit        | P1       | hydrate() sets isHydrated=true after completion  | State tracking       |
| 1.4-UNIT-030 | Unit        | P1       | hydrate() handles IndexedDB errors gracefully    | Error resilience     |
| 1.4-UNIT-031 | Unit        | P3       | exitGuestMode() clears all guest state           | Cleanup logic        |
| 1.4-INT-008  | Integration | P0       | Guest state persists across page reload          | Browser session      |
| 1.4-E2E-006  | E2E         | P0       | Guest mode persists after browser close/reopen   | Critical persistence |

---

## Test Level Justification Summary

### Unit Tests (18 scenarios)

- **Why unit:** Pure logic, state mutations, component rendering, isolated behavior
- **Key coverage:** Store actions, service methods, component props
- **Advantages:** Fast execution, isolated failures, easy debugging

### Integration Tests (8 scenarios)

- **Why integration:** Multi-component flows, persistence verification, conditional rendering
- **Key coverage:** Store-to-UI sync, IndexedDB round-trips, route guards
- **Advantages:** Catches integration bugs, tests realistic scenarios

### E2E Tests (6 scenarios)

- **Why E2E:** Critical user journeys, browser-level persistence
- **Key coverage:** Complete guest entry flow, session persistence
- **Advantages:** Validates real user experience, catches environment issues

---

## P0 Test Summary (Must Pass for Release)

| ID               | Test                               | Level       | Why Critical           |
| ---------------- | ---------------------------------- | ----------- | ---------------------- |
| 1.4-UNIT-005     | enterGuestMode() sets isGuest=true | Unit        | Core functionality     |
| 1.4-UNIT-006     | enterGuestMode() generates UUID    | Unit        | Session identification |
| 1.4-UNIT-013     | IndexedDB init creates database    | Unit        | Storage foundation     |
| 1.4-UNIT-014-016 | Object stores created              | Unit        | Schema integrity       |
| 1.4-UNIT-027-028 | hydrate() restores state           | Unit        | Persistence core       |
| 1.4-INT-002      | Button → store → navigation        | Integration | Entry flow             |
| 1.4-INT-008      | State persists on reload           | Integration | Session continuity     |
| 1.4-E2E-001      | Guest button visible               | E2E         | User access            |
| 1.4-E2E-002      | Click → home redirect              | E2E         | Primary journey        |
| 1.4-E2E-006      | Persists after browser restart     | E2E         | Data safety            |

---

## Current Implementation Coverage

Based on existing test files (82 tests passing):

| Test File                   | Scenarios Covered            | Status                       |
| --------------------------- | ---------------------------- | ---------------------------- |
| `indexedDb.service.test.ts` | 1.4-UNIT-013 to 018          | ✅ Implemented               |
| `guestStore.test.ts`        | 1.4-UNIT-005 to 008, 027-031 | ✅ Implemented               |
| `authStore.test.ts`         | 1.4-UNIT-008, 019            | ⚠️ Partial (setAuthMode gap) |
| `GuestModeBanner.test.tsx`  | 1.4-UNIT-009 to 012          | ✅ Implemented               |
| `SignInPrompt.test.tsx`     | 1.4-UNIT-020 to 023          | ✅ Implemented               |
| `useSignInPrompt.test.ts`   | 1.4-UNIT-024 to 026, INT-007 | ✅ Implemented               |
| **E2E tests**               | 1.4-E2E-001 to 006           | ❌ Not implemented           |

---

## Coverage Gaps

| Gap                                   | Severity | Recommendation                |
| ------------------------------------- | -------- | ----------------------------- |
| E2E tests not implemented             | Medium   | Add when Playwright installed |
| `setAuthMode` not tested in authStore | Low      | Add 2-3 unit tests            |
| IndexedDB error paths at 73%          | Low      | Add error injection tests     |

---

## Recommended Execution Order

1. **P0 Unit tests** (fail fast on core logic)
2. **P0 Integration tests** (verify component wiring)
3. **P0 E2E tests** (validate user journey)
4. **P1 tests** in level order
5. **P2+ tests** as time permits

---

## Test Design YAML Block

```yaml
test_design:
  scenarios_total: 32
  by_level:
    unit: 18
    integration: 8
    e2e: 6
  by_priority:
    p0: 8
    p1: 12
    p2: 10
    p3: 2
  coverage_gaps:
    - 'E2E tests deferred (Playwright not installed)'
    - 'authStore.setAuthMode() untested'
  trace_ref: 'docs/qa/assessments/1.4-test-design-20260116.md'
```

---

## Trace Reference

```
Test design matrix: docs/qa/assessments/1.4-test-design-20260116.md
P0 tests identified: 8
Total scenarios: 32
```
